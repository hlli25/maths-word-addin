/*! For license information please see taskpane.js.LICENSE.txt */
!function(){"use strict";var t={58394:function(t,e,n){t.exports=n.p+"de3e2b2213486489b8f8.css"}},e={};function n(i){var r=e[i];if(void 0!==r)return r.exports;var a=e[i]={exports:{}};return t[i](a,a.exports,n),a.exports}n.m=t,n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},function(){var t;n.g.importScripts&&(t=n.g.location+"");var e=n.g.document;if(!t&&e&&(e.currentScript&&"SCRIPT"===e.currentScript.tagName.toUpperCase()&&(t=e.currentScript.src),!t)){var i=e.getElementsByTagName("script");if(i.length)for(var r=i.length-1;r>-1&&(!t||!/^http(s?):/.test(t));)t=i[r--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=t}(),n.b=document.baseURI||self.location.href,function(){function t(t,n){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var i,r,a,o,s=[],c=!0,l=!1;try{if(a=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;c=!1}else for(;!(c=(i=a.call(n)).done)&&(s.push(i.value),s.length!==e);c=!0);}catch(t){l=!0,r=t}finally{try{if(!c&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(l)throw r}}return s}}(t,n)||e(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function e(t,e){if(t){if("string"==typeof t)return n(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?n(t,e):void 0}}function n(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=Array(e);n<e;n++)i[n]=t[n];return i}var i={sin:{structureType:"simple",hasBuiltinLatex:!0},cos:{structureType:"simple",hasBuiltinLatex:!0},tan:{structureType:"simple",hasBuiltinLatex:!0},sec:{structureType:"simple",hasBuiltinLatex:!0},csc:{structureType:"simple",hasBuiltinLatex:!0},cot:{structureType:"simple",hasBuiltinLatex:!0},asin:{structureType:"simple"},acos:{structureType:"simple"},atan:{structureType:"simple"},sinh:{structureType:"simple",hasBuiltinLatex:!0},cosh:{structureType:"simple",hasBuiltinLatex:!0},tanh:{structureType:"simple",hasBuiltinLatex:!0},asinh:{structureType:"simple"},acosh:{structureType:"simple"},atanh:{structureType:"simple"},log:{structureType:"simple",hasBuiltinLatex:!0},logn:{structureType:"functionsub"},ln:{structureType:"simple",hasBuiltinLatex:!0},max:{structureType:"functionlim",hasBuiltinLatex:!0},min:{structureType:"functionlim",hasBuiltinLatex:!0},lim:{structureType:"functionlim",hasBuiltinLatex:!0},argmax:{structureType:"functionlim"},argmin:{structureType:"functionlim"},function:{structureType:"function"},functionsub:{structureType:"functionsub"},functionlim:{structureType:"functionlim"}},r=Object.entries(i).reduce(function(e,n){var i=t(n,2),r=i[0],a=i[1];return e[r]=a.structureType,e},{}),a=Object.keys(i).filter(function(t){return!["function","functionsub","functionlim"].includes(t)}),o=Object.entries(i).filter(function(e){var n=t(e,2);return n[0],n[1].hasBuiltinLatex}).map(function(e){var n=t(e,2),i=n[0];return n[1],"\\".concat(i)}),s={"\\alpha":{unicode:"α",defaultItalic:!0},"\\beta":{unicode:"β",defaultItalic:!0},"\\gamma":{unicode:"γ",defaultItalic:!0},"\\delta":{unicode:"δ",defaultItalic:!0},"\\epsilon":{unicode:"ε",defaultItalic:!0},"\\varepsilon":{unicode:"ε",defaultItalic:!0},"\\zeta":{unicode:"ζ",defaultItalic:!0},"\\eta":{unicode:"η",defaultItalic:!0},"\\theta":{unicode:"θ",defaultItalic:!0},"\\vartheta":{unicode:"ϑ",defaultItalic:!0},"\\iota":{unicode:"ι",defaultItalic:!0},"\\kappa":{unicode:"κ",defaultItalic:!0},"\\lambda":{unicode:"λ",defaultItalic:!0},"\\mu":{unicode:"μ",defaultItalic:!0},"\\nu":{unicode:"ν",defaultItalic:!0},"\\xi":{unicode:"ξ",defaultItalic:!0},"\\omicron":{unicode:"ο",defaultItalic:!0},"\\pi":{unicode:"π",defaultItalic:!0},"\\varpi":{unicode:"ϖ",defaultItalic:!0},"\\rho":{unicode:"ρ",defaultItalic:!0},"\\varrho":{unicode:"ϱ",defaultItalic:!0},"\\sigma":{unicode:"σ",defaultItalic:!0},"\\varsigma":{unicode:"ς",defaultItalic:!0},"\\tau":{unicode:"τ",defaultItalic:!0},"\\upsilon":{unicode:"υ",defaultItalic:!0},"\\phi":{unicode:"φ",defaultItalic:!0},"\\varphi":{unicode:"φ",defaultItalic:!0},"\\chi":{unicode:"χ",defaultItalic:!0},"\\psi":{unicode:"ψ",defaultItalic:!0},"\\omega":{unicode:"ω",defaultItalic:!0},"\\Gamma":{unicode:"Γ",defaultItalic:!1},"\\Delta":{unicode:"Δ",defaultItalic:!1},"\\Theta":{unicode:"Θ",defaultItalic:!1},"\\Lambda":{unicode:"Λ",defaultItalic:!1},"\\Pi":{unicode:"Π",defaultItalic:!1},"\\Sigma":{unicode:"Σ",defaultItalic:!1},"\\Upsilon":{unicode:"Υ",defaultItalic:!1},"\\Phi":{unicode:"Φ",defaultItalic:!1},"\\Chi":{unicode:"Χ",defaultItalic:!1},"\\Psi":{unicode:"Ψ",defaultItalic:!1},"\\Omega":{unicode:"Ω",defaultItalic:!1},"\\partial":{unicode:"∂",defaultItalic:!0},"\\nabla":{unicode:"∇",defaultItalic:!1},"\\infty":{unicode:"∞",defaultItalic:!1},"\\times":{unicode:"×",defaultItalic:!1},"\\divsymbol":{unicode:"÷",defaultItalic:!1},"\\pm":{unicode:"±",defaultItalic:!1},"\\mp":{unicode:"∓",defaultItalic:!1},"\\cdot":{unicode:"·",defaultItalic:!1},"\\ast":{unicode:"∗",defaultItalic:!1},"\\star":{unicode:"⋆",defaultItalic:!1},"\\circ":{unicode:"∘",defaultItalic:!1},"\\bullet":{unicode:"•",defaultItalic:!1},"=":{unicode:"=",defaultItalic:!1},"<":{unicode:"<",defaultItalic:!1},">":{unicode:">",defaultItalic:!1},"+":{unicode:"+",defaultItalic:!1},"-":{unicode:"-",defaultItalic:!1},"\\neq":{unicode:"≠",defaultItalic:!1},"\\sim":{unicode:"∼",defaultItalic:!1},"\\simeq":{unicode:"≃",defaultItalic:!1},"\\approx":{unicode:"≈",defaultItalic:!1},"\\equiv":{unicode:"≡",defaultItalic:!1},"\\cong":{unicode:"≅",defaultItalic:!1},"\\ncong":{unicode:"≇",defaultItalic:!1},"\\propto":{unicode:"∝",defaultItalic:!1},"\\leq":{unicode:"≤",defaultItalic:!1},"\\geq":{unicode:"≥",defaultItalic:!1},"\\nless":{unicode:"≮",defaultItalic:!1},"\\ngtr":{unicode:"≯",defaultItalic:!1},"\\nleq":{unicode:"≰",defaultItalic:!1},"\\ngeq":{unicode:"≱",defaultItalic:!1},"\\prec":{unicode:"≺",defaultItalic:!1},"\\succ":{unicode:"≻",defaultItalic:!1},"\\preceq":{unicode:"⪯",defaultItalic:!1},"\\succeq":{unicode:"⪰",defaultItalic:!1},"\\ll":{unicode:"≪",defaultItalic:!1},"\\gg":{unicode:"≫",defaultItalic:!1},"\\cap":{unicode:"∩",defaultItalic:!1},"\\cup":{unicode:"∪",defaultItalic:!1},"\\setminus":{unicode:"∖",defaultItalic:!1},"\\in":{unicode:"∈",defaultItalic:!1},"\\ni":{unicode:"∋",defaultItalic:!1},"\\notin":{unicode:"∉",defaultItalic:!1},"\\subset":{unicode:"⊂",defaultItalic:!1},"\\supset":{unicode:"⊃",defaultItalic:!1},"\\subseteq":{unicode:"⊆",defaultItalic:!1},"\\supseteq":{unicode:"⊇",defaultItalic:!1},"\\nsubseteq":{unicode:"⊈",defaultItalic:!1},"\\nsupseteq":{unicode:"⊉",defaultItalic:!1},"\\subsetneq":{unicode:"⊊",defaultItalic:!1},"\\supsetneq":{unicode:"⊋",defaultItalic:!1},"\\oplus":{unicode:"⊕",defaultItalic:!1},"\\ominus":{unicode:"⊖",defaultItalic:!1},"\\otimes":{unicode:"⊗",defaultItalic:!1},"\\oslash":{unicode:"⊘",defaultItalic:!1},"\\odot":{unicode:"⊙",defaultItalic:!1},"\\triangleleft":{unicode:"◁",defaultItalic:!1},"\\triangleright":{unicode:"▷",defaultItalic:!1},"\\wr":{unicode:"≀",defaultItalic:!1},"\\wedge":{unicode:"∧",defaultItalic:!1},"\\vee":{unicode:"∨",defaultItalic:!1},"\\vdash":{unicode:"⊢",defaultItalic:!1},"\\models":{unicode:"⊨",defaultItalic:!1},"\\top":{unicode:"⊤",defaultItalic:!1},"\\bot":{unicode:"⊥",defaultItalic:!1},"\\rightarrow":{unicode:"→",defaultItalic:!1},"\\leftarrow":{unicode:"←",defaultItalic:!1},"\\uparrow":{unicode:"↑",defaultItalic:!1},"\\downarrow":{unicode:"↓",defaultItalic:!1},"\\leftrightarrow":{unicode:"↔",defaultItalic:!1},"\\updownarrow":{unicode:"↕",defaultItalic:!1},"\\nearrow":{unicode:"↗",defaultItalic:!1},"\\searrow":{unicode:"↘",defaultItalic:!1},"\\Rightarrow":{unicode:"⇒",defaultItalic:!1},"\\Leftarrow":{unicode:"⇐",defaultItalic:!1},"\\Uparrow":{unicode:"⇑",defaultItalic:!1},"\\Downarrow":{unicode:"⇓",defaultItalic:!1},"\\Leftrightarrow":{unicode:"⇔",defaultItalic:!1},"\\Updownarrow":{unicode:"⇕",defaultItalic:!1},"\\longrightarrow":{unicode:"⟶",defaultItalic:!1},"\\longleftarrow":{unicode:"⟵",defaultItalic:!1},"\\longleftrightarrow":{unicode:"⟷",defaultItalic:!1},"\\Longrightarrow":{unicode:"⟹",defaultItalic:!1},"\\Longleftarrow":{unicode:"⟸",defaultItalic:!1},"\\Longleftrightarrow":{unicode:"⟺",defaultItalic:!1},"\\circlearrowleft":{unicode:"↺",defaultItalic:!1},"\\circlearrowright":{unicode:"↻",defaultItalic:!1},"\\curvearrowleft":{unicode:"↶",defaultItalic:!1},"\\curvearrowright":{unicode:"↷",defaultItalic:!1},"\\hookleftarrow":{unicode:"↩",defaultItalic:!1},"\\hookrightarrow":{unicode:"↪",defaultItalic:!1},"\\bowtie":{unicode:"⋈",defaultItalic:!1},"\\diamond":{unicode:"⋄",defaultItalic:!1},"\\asymp":{unicode:"≍",defaultItalic:!1},"\\triangleq":{unicode:"≜",defaultItalic:!1},"\\therefore":{unicode:"∴",defaultItalic:!1},"\\because":{unicode:"∵",defaultItalic:!1},"\\forall":{unicode:"∀",defaultItalic:!1},"\\exists":{unicode:"∃",defaultItalic:!1},"\\nexists":{unicode:"∄",defaultItalic:!1},"\\emptyset":{unicode:"∅",defaultItalic:!1},"\\varnothing":{unicode:"∅",defaultItalic:!1},"\\mathbb{R}":{unicode:"ℝ",defaultItalic:!1},"\\mathbb{Z}":{unicode:"ℤ",defaultItalic:!1},"\\mathbb{Q}":{unicode:"ℚ",defaultItalic:!1},"\\mathbb{N}":{unicode:"ℕ",defaultItalic:!1},"\\mathbb{C}":{unicode:"ℂ",defaultItalic:!1},"\\mathbb{H}":{unicode:"ℍ",defaultItalic:!1},"\\mathbb{P}":{unicode:"ℙ",defaultItalic:!1},"\\wp":{unicode:"℘",defaultItalic:!1},"\\aleph":{unicode:"ℵ",defaultItalic:!1},"\\beth":{unicode:"ℶ",defaultItalic:!1},"\\gimel":{unicode:"ℷ",defaultItalic:!1},"\\daleth":{unicode:"ℸ",defaultItalic:!1},"\\angle":{unicode:"∠",defaultItalic:!1},"\\measuredangle":{unicode:"∡",defaultItalic:!1},"\\sphericalangle":{unicode:"∢",defaultItalic:!1},"\\parallel":{unicode:"∥",defaultItalic:!1},"\\nparallel":{unicode:"∦",defaultItalic:!1},"\\triangle":{unicode:"△",defaultItalic:!1},"\\square":{unicode:"□",defaultItalic:!1},"\\blacksquare":{unicode:"■",defaultItalic:!1},"\\lozenge":{unicode:"◊",defaultItalic:!1},"\\blacklozenge":{unicode:"⧫",defaultItalic:!1},"\\bigcirc":{unicode:"○",defaultItalic:!1},"\\degree":{unicode:"°",defaultItalic:!1},"\\sum":{unicode:"∑",defaultItalic:!1,isLargeOperator:!0,dataAttribute:"sum",needsInlineScaling:!0},"\\prod":{unicode:"∏",defaultItalic:!1,isLargeOperator:!0,dataAttribute:"prod",needsInlineScaling:!0},"\\coprod":{unicode:"∐",defaultItalic:!1,isLargeOperator:!0,dataAttribute:"coprod",needsInlineScaling:!0},"\\bigcup":{unicode:"⋃",defaultItalic:!1,isLargeOperator:!0,dataAttribute:"bigcup",needsInlineScaling:!0},"\\bigcap":{unicode:"⋂",defaultItalic:!1,isLargeOperator:!0,dataAttribute:"bigcap",needsInlineScaling:!0},"\\bigvee":{unicode:"⋁",defaultItalic:!1,isLargeOperator:!0,dataAttribute:"bigvee",needsInlineScaling:!0},"\\bigwedge":{unicode:"⋀",defaultItalic:!1,isLargeOperator:!0,dataAttribute:"bigwedge",needsInlineScaling:!0},"\\bigoplus":{unicode:"⨁",defaultItalic:!1,isLargeOperator:!0,dataAttribute:"bigoplus",needsInlineScaling:!0},"\\bigotimes":{unicode:"⨂",defaultItalic:!1,isLargeOperator:!0,dataAttribute:"bigotimes",needsInlineScaling:!0},"\\bigodot":{unicode:"⨀",defaultItalic:!1,isLargeOperator:!0,dataAttribute:"bigodot",needsInlineScaling:!0},"\\biguplus":{unicode:"⨄",defaultItalic:!1,isLargeOperator:!0,dataAttribute:"biguplus",needsInlineScaling:!0},"\\int":{unicode:"∫",defaultItalic:!1,isLargeOperator:!0,dataAttribute:"int"},"\\oint":{unicode:"∮",defaultItalic:!1,isLargeOperator:!0,dataAttribute:"oint"}},c=Object.entries(s).reduce(function(e,n){var i=t(n,2),r=i[0],a=i[1];return e[r]=a.unicode,e},{}),l=Object.entries(s).reduce(function(e,n){var i=t(n,2),r=i[0];return e[i[1].unicode]=r,e},{}),u=Object.entries(s).filter(function(e){var n=t(e,2);return n[0],n[1].isLargeOperator}).map(function(e){var n=t(e,2),i=n[0];return n[1],i}),d=[{left:"(",right:")",leftDisplay:"(",rightDisplay:")"},{left:"[",right:"]",leftDisplay:"[",rightDisplay:"]"},{left:"{",right:"}",leftDisplay:"{",rightDisplay:"}"},{left:"\\{",right:"\\}",leftDisplay:"{",rightDisplay:"}"},{left:"\\langle",right:"\\rangle",leftDisplay:"⟨",rightDisplay:"⟩"},{left:"\\lfloor",right:"\\rfloor",leftDisplay:"⌊",rightDisplay:"⌋"},{left:"\\lceil",right:"\\rceil",leftDisplay:"⌈",rightDisplay:"⌉"},{left:"\\lvert",right:"\\rvert",leftDisplay:"|",rightDisplay:"|"},{left:"\\lVert",right:"\\rVert",leftDisplay:"‖",rightDisplay:"‖"},{left:"|",right:"|",leftDisplay:"|",rightDisplay:"|"},{left:"\\|",right:"\\|",leftDisplay:"‖",rightDisplay:"‖"}],p=["\\inti","\\intd","\\iinti","\\iintd","\\iiinti","\\iiintd","\\ointi","\\ointd","\\iintisub","\\iintdsub","\\iiintisub","\\iiintdsub","\\ointisub","\\ointdsub","\\iintilower","\\iintdlower","\\iiintilower","\\iiintdlower","\\intinolim","\\intdnolim","\\iintinolim","\\iintdnolim","\\iiintinolim","\\iiintdnolim","\\ointinolim","\\ointdnolim","\\intilim","\\intdlim","\\iintilim","\\iintdlim","\\iiintilim","\\iiintdlim"];function h(t){if(!t||0===t.length)return!1;var n,i=new Set,r=function(t){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=e(t))){n&&(t=n);var i=0,r=function(){};return{s:r,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return o=t.done,t},e:function(t){s=!0,a=t},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}(d);try{for(r.s();!(n=r.n()).done;){var a=n.value;(t.includes(a.left)||t.includes(a.right))&&i.add("".concat(a.left,"-").concat(a.right))}}catch(t){r.e(t)}finally{r.f()}return i.size>1}var f={fraction:["numerator","denominator"],"bevelled-fraction":["numerator","denominator"],nthroot:["radicand","index"],script:["base","superscript","subscript"],integral:["upperLimit","lowerLimit","integrand","differentialVariable"],derivative:["order","function","variable"],"large-operator":["lowerLimit","upperLimit","operand"],function:["functionName","functionConstraint","functionBase","functionArgument"],accent:["accentBase","accentLabel"],matrix:[],stack:[],cases:[]};function m(t){var e=f[t.type]||[];if("matrix"===t.type||"stack"===t.type||"cases"===t.type){var n=[];if(t.cells)for(var i=0;i<t.rows;i++)for(var r=0;r<t.cols;r++)n.push("cell_".concat(i,"_").concat(r));return n}return e.filter(function(e){return"superscript"===e?t.superscript:"subscript"===e?t.subscript:"upperLimit"===e?t.upperLimit:"lowerLimit"===e?t.lowerLimit:"order"===e?Array.isArray(t.order):"functionName"===e?["function","functionsub","functionlim"].includes(t.functionType||""):"functionConstraint"===e?t.functionConstraint:"functionBase"===e?t.functionBase:"accentLabel"!==e||t.accentLabel})}function v(t){return v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},v(t)}function y(t,e){if(t){if("string"==typeof t)return g(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?g(t,e):void 0}}function g(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=Array(e);n<e;n++)i[n]=t[n];return i}function b(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,w(i.key),i)}}function x(t,e,n){return(e=w(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function w(t){var e=function(t){if("object"!=v(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=v(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==v(e)?e:e+""}var k=function(){return t=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),x(this,"equation",[]),x(this,"elementIdCounter",0),this.clear()},e=[{key:"getEquation",value:function(){return this.equation}},{key:"setEquation",value:function(t){this.equation=t}},{key:"clear",value:function(){this.equation=[],this.elementIdCounter=0}},{key:"isEmpty",value:function(){return 0===this.equation.length}},{key:"generateElementId",value:function(){return"element-".concat(this.elementIdCounter++)}},{key:"insertElement",value:function(t,e,n){e.splice(n,0,t)}},{key:"removeElement",value:function(t,e){e>=0&&e<t.length&&t.splice(e,1)}},{key:"createTextElement",value:function(t){return{id:this.generateElementId(),type:"text",value:t}}},{key:"createFractionElement",value:function(){return{id:this.generateElementId(),type:"fraction",numerator:[],denominator:[]}}},{key:"createDisplayFractionElement",value:function(){return{id:this.generateElementId(),type:"fraction",numerator:[],denominator:[],displayMode:"display"}}},{key:"createBevelledFractionElement",value:function(){return{id:this.generateElementId(),type:"bevelled-fraction",numerator:[],denominator:[]}}},{key:"createSquareRootElement",value:function(){return{id:this.generateElementId(),type:"sqrt",radicand:[]}}},{key:"createNthRootElement",value:function(){return{id:this.generateElementId(),type:"nthroot",index:[],radicand:[]}}},{key:"createScriptElement",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return{id:this.generateElementId(),type:"script",base:[],superscript:t?[]:void 0,subscript:e?[]:void 0}}},{key:"createBracketElement",value:function(t,e){return{id:this.generateElementId(),type:"bracket",leftBracketSymbol:t,rightBracketSymbol:e,content:[]}}},{key:"createEvaluationBracketElement",value:function(t){var e="bar"===t?".":"[",n="bar"===t?"|":"]";return{id:this.generateElementId(),type:"bracket",leftBracketSymbol:e,rightBracketSymbol:n,content:[],superscript:[],subscript:[]}}},{key:"createLargeOperatorElement",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"inline",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"default";return{id:this.generateElementId(),type:"large-operator",operator:t,displayMode:e,limitMode:n,lowerLimit:[],upperLimit:[],operand:[]}}},{key:"createDerivativeElement",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"inline",n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return{id:this.generateElementId(),type:"derivative",order:t,displayMode:e,function:[],variable:[],isLongForm:n,isPartial:i}}},{key:"createIntegralElement",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"single",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"inline",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"italic",i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"default",a=void 0,o=void 0;if(i)switch(arguments.length>5&&void 0!==arguments[5]?arguments[5]:"both"){case"both":a=[],o=[];break;case"lower-only":a=[];break;case"upper-only":o=[]}return{id:this.generateElementId(),type:"integral",integralType:t,displayMode:e,integralStyle:n,isDefinite:i,limitMode:r,integrand:[],differentialVariable:[],lowerLimit:a,upperLimit:o}}},{key:"createMatrixElement",value:function(t,e){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"parentheses",i={},r=0;r<t;r++)for(var a=0;a<e;a++)i["cell_".concat(r,"_").concat(a)]=[];return{id:this.generateElementId(),type:"matrix",matrixType:n,rows:t,cols:e,cells:i}}},{key:"createStackElement",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n={},i=0;i<t;i++)for(var r=0;r<e;r++)n["cell_".concat(i,"_").concat(r)]=[];return{id:this.generateElementId(),type:"stack",stackType:"plain",rows:t,cols:e,cells:n}}},{key:"createCasesElement",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,n={},i=0;i<t;i++)for(var r=0;r<e;r++)n["cell_".concat(i,"_").concat(r)]=[];return{id:this.generateElementId(),type:"cases",casesType:"cases",rows:t,cols:e,cells:n}}},{key:"findElementById",value:function(t,e){var n,i=function(t){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!e){if(Array.isArray(t)||(e=y(t))){e&&(t=e);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,a=!0,o=!1;return{s:function(){e=e.call(t)},n:function(){var t=e.next();return a=t.done,t},e:function(t){o=!0,r=t},f:function(){try{a||null==e.return||e.return()}finally{if(o)throw r}}}}(t);try{for(i.s();!(n=i.n()).done;){var r=n.value;if(r.id===e)return r;if("fraction"===r.type||"bevelled-fraction"===r.type){var a=this.findElementById(r.numerator,e)||this.findElementById(r.denominator,e);if(a)return a}if("sqrt"===r.type){var o=this.findElementById(r.radicand,e);if(o)return o}if("nthroot"===r.type){var s=this.findElementById(r.index,e)||this.findElementById(r.radicand,e);if(s)return s}if("script"===r.type){var c=this.findElementById(r.base||[],e)||this.findElementById(r.superscript||[],e)||this.findElementById(r.subscript||[],e);if(c)return c}if("bracket"===r.type){var l=this.findElementById(r.content||[],e);if(l)return l}if("large-operator"===r.type){var u=this.findElementById(r.lowerLimit||[],e)||this.findElementById(r.upperLimit||[],e)||this.findElementById(r.operand||[],e);if(u)return u}if("derivative"===r.type){var d=this.findElementById(r.function||[],e)||this.findElementById(r.variable||[],e)||(Array.isArray(r.order)?this.findElementById(r.order,e):null);if(d)return d}if("integral"===r.type){var p=this.findElementById(r.integrand||[],e)||this.findElementById(r.differentialVariable||[],e)||this.findElementById(r.lowerLimit||[],e)||this.findElementById(r.upperLimit||[],e);if(p)return p}if(("matrix"===r.type||"stack"===r.type||"cases"===r.type)&&r.cells)for(var h in r.cells)if(h.startsWith("cell_")){var f=this.findElementById(r.cells[h],e);if(f)return f}if("accent"===r.type){var m=this.findElementById(r.accentBase||[],e)||this.findElementById(r.accentLabel||[],e);if(m)return m}if("function"===r.type){var v=this.findElementById(r.functionArgument||[],e)||this.findElementById(r.functionBase||[],e)||this.findElementById(r.functionConstraint||[],e)||this.findElementById(r.functionName||[],e);if(v)return v}}}catch(t){i.e(t)}finally{i.f()}return null}},{key:"updateParenthesesScaling",value:function(){this.updateParenthesesScalingRecursive(this.equation)}},{key:"updateBracketNesting",value:function(){this.updateBracketNestingRecursive(this.equation,0)}},{key:"calculateContentHeight",value:function(t){var e=document.createElement("div");e.style.position="absolute",e.style.visibility="hidden",e.style.whiteSpace="nowrap",e.style.fontSize="16px",e.style.fontFamily="Cambria Math, serif",document.body.appendChild(e);var n=document.createElement("span");n.textContent="x",n.style.fontSize="16px",e.appendChild(n);var i=n.getBoundingClientRect().height;e.removeChild(n);var r=document.createElement("span");r.style.display="inline-block";var a=function(t,e){t.forEach(function(t){if("text"===t.type){var n=document.createElement("span");n.textContent=t.value||"",e.appendChild(n)}else if("fraction"===t.type||"bevelled-fraction"===t.type){var i=document.createElement("span");i.style.display="inline-flex",i.style.flexDirection="column",i.style.alignItems="center",i.style.verticalAlign="middle";var r=document.createElement("span");r.style.fontSize="0.8em",t.numerator&&a(t.numerator,r);var o=document.createElement("span");o.style.borderTop="1px solid black",o.style.width="100%",o.style.height="0";var s=document.createElement("span");s.style.fontSize="0.8em",t.denominator&&a(t.denominator,s),i.appendChild(r),"fraction"===t.type&&i.appendChild(o),i.appendChild(s),e.appendChild(i)}else if("script"===t.type){var c=document.createElement("span");c.style.display="inline-block",c.style.position="relative";var l=document.createElement("span");if(t.base&&a(t.base,l),c.appendChild(l),t.superscript){var u=document.createElement("sup");u.style.fontSize="0.7em",a(t.superscript,u),c.appendChild(u)}if(t.subscript){var d=document.createElement("sub");d.style.fontSize="0.7em",a(t.subscript,d),c.appendChild(d)}e.appendChild(c)}else if("sqrt"===t.type||"nthroot"===t.type){var p=document.createElement("span");p.style.display="inline-block",p.style.borderTop="2px solid black",p.style.paddingTop="2px",p.style.paddingLeft="4px",p.style.paddingRight="4px",t.radicand&&a(t.radicand,p),e.appendChild(p)}else if("large-operator"===t.type||"integral"===t.type){var h=document.createElement("span");h.style.display="inline-flex",h.style.flexDirection="column",h.style.alignItems="center",h.style.fontSize="1.5em";var f=document.createElement("span");f.textContent="integral"===t.type?"∫":t.operator||"Σ",h.appendChild(f),e.appendChild(h)}else if("matrix"===t.type||"stack"===t.type||"cases"===t.type){var m=document.createElement("span");if(m.style.display="inline-table",m.style.verticalAlign="middle",t.cells){var v=Math.max.apply(Math,function(t){return function(t){if(Array.isArray(t))return g(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||y(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(Object.keys(t.cells).map(function(t){var e=t.match(/cell_(\d+)_/);return e?parseInt(e[1]):0})))+1;m.style.minHeight="".concat(1.5*v,"em")}e.appendChild(m)}})};a(t,r),e.appendChild(r);var o=r.getBoundingClientRect().height;return document.body.removeChild(e),o/i}},{key:"updateParenthesesScalingRecursive",value:function(t){var e,n,i=this,r=(e={},d.forEach(function(t){e[t.leftDisplay]=t.rightDisplay}),e),a=(n=new Set,d.forEach(function(t){n.add(t.leftDisplay)}),n),o=function(){var t=new Set;return d.forEach(function(e){t.add(e.rightDisplay)}),t}(),s=[],c=[];t.forEach(function(t){if("text"===t.type&&/[()]/.test(t.value||""))t.scaleFactor=1;else if("fraction"===t.type||"bevelled-fraction"===t.type)i.updateParenthesesScalingRecursive(t.numerator),i.updateParenthesesScalingRecursive(t.denominator);else if("sqrt"===t.type)i.updateParenthesesScalingRecursive(t.radicand);else if("nthroot"===t.type)t.index&&i.updateParenthesesScalingRecursive(t.index),i.updateParenthesesScalingRecursive(t.radicand);else if("script"===t.type)i.updateParenthesesScalingRecursive(t.base),t.superscript&&i.updateParenthesesScalingRecursive(t.superscript),t.subscript&&i.updateParenthesesScalingRecursive(t.subscript);else if("bracket"===t.type)i.updateParenthesesScalingRecursive(t.content),t.superscript&&i.updateParenthesesScalingRecursive(t.superscript),t.subscript&&i.updateParenthesesScalingRecursive(t.subscript);else if("large-operator"===t.type)t.lowerLimit&&i.updateParenthesesScalingRecursive(t.lowerLimit),t.upperLimit&&i.updateParenthesesScalingRecursive(t.upperLimit),t.operand&&i.updateParenthesesScalingRecursive(t.operand);else if("integral"===t.type)t.integrand&&i.updateParenthesesScalingRecursive(t.integrand),t.differentialVariable&&i.updateParenthesesScalingRecursive(t.differentialVariable),t.lowerLimit&&i.updateParenthesesScalingRecursive(t.lowerLimit),t.upperLimit&&i.updateParenthesesScalingRecursive(t.upperLimit);else if("derivative"===t.type)t.function&&i.updateParenthesesScalingRecursive(t.function),t.variable&&i.updateParenthesesScalingRecursive(t.variable),Array.isArray(t.order)&&i.updateParenthesesScalingRecursive(t.order);else if("matrix"===t.type||"stack"===t.type||"cases"===t.type){if(t.cells)for(var e in t.cells)t.cells.hasOwnProperty(e)&&i.updateParenthesesScalingRecursive(t.cells[e])}else"accent"===t.type?(t.accentBase&&i.updateParenthesesScalingRecursive(t.accentBase),t.accentLabel&&i.updateParenthesesScalingRecursive(t.accentLabel)):"function"===t.type&&(t.functionName&&i.updateParenthesesScalingRecursive(t.functionName),t.functionArgument&&i.updateParenthesesScalingRecursive(t.functionArgument),t.functionBase&&i.updateParenthesesScalingRecursive(t.functionBase),t.functionConstraint&&i.updateParenthesesScalingRecursive(t.functionConstraint))}),t.forEach(function(e,n){if("text"===e.type&&e.value&&a.has(e.value))s.push({element:e,index:n,bracketType:e.value});else if("text"===e.type&&e.value&&o.has(e.value)){for(var i=-1,l=s.length-1;l>=0;l--)if(r[s[l].bracketType]===e.value){i=l;break}if(i>=0){var u=s.splice(i,1)[0];c.push({open:u,close:{element:e,index:n},content:t.slice(u.index+1,n)})}}}),c.forEach(function(t){var e=i.calculateContentHeight(t.content),n=1;e>2.5?n=2:e>1.8?n=1.75:e>1.4?n=1.5:e>1.2&&(n=1.25),t.open.element.scaleFactor=n,t.close.element.scaleFactor=n})}},{key:"updateBracketNestingRecursive",value:function(t,e){var n=this;t.forEach(function(t){if("bracket"===t.type)n.updateBracketNestingRecursive(t.content,e+1);else if("fraction"===t.type||"bevelled-fraction"===t.type)n.updateBracketNestingRecursive(t.numerator,e),n.updateBracketNestingRecursive(t.denominator,e);else if("sqrt"===t.type)n.updateBracketNestingRecursive(t.radicand,e);else if("nthroot"===t.type)n.updateBracketNestingRecursive(t.index,e),n.updateBracketNestingRecursive(t.radicand,e);else if("script"===t.type)n.updateBracketNestingRecursive(t.base,e),t.superscript&&n.updateBracketNestingRecursive(t.superscript,e),t.subscript&&n.updateBracketNestingRecursive(t.subscript,e);else if("large-operator"===t.type)t.lowerLimit&&n.updateBracketNestingRecursive(t.lowerLimit,e),t.upperLimit&&n.updateBracketNestingRecursive(t.upperLimit,e),t.operand&&n.updateBracketNestingRecursive(t.operand,e);else if("integral"===t.type)t.integrand&&n.updateBracketNestingRecursive(t.integrand,e),t.differentialVariable&&n.updateBracketNestingRecursive(t.differentialVariable,e),t.lowerLimit&&n.updateBracketNestingRecursive(t.lowerLimit,e),t.upperLimit&&n.updateBracketNestingRecursive(t.upperLimit,e);else if("derivative"===t.type)t.function&&n.updateBracketNestingRecursive(t.function,e),t.variable&&n.updateBracketNestingRecursive(t.variable,e),Array.isArray(t.order)&&n.updateBracketNestingRecursive(t.order,e);else if("accent"===t.type)t.accentBase&&n.updateBracketNestingRecursive(t.accentBase,e),t.accentLabel&&n.updateBracketNestingRecursive(t.accentLabel,e);else if("function"===t.type)t.functionName&&n.updateBracketNestingRecursive(t.functionName,e),t.functionArgument&&n.updateBracketNestingRecursive(t.functionArgument,e),t.functionBase&&n.updateBracketNestingRecursive(t.functionBase,e),t.functionConstraint&&n.updateBracketNestingRecursive(t.functionConstraint,e);else if(("matrix"===t.type||"stack"===t.type||"cases"===t.type)&&t.cells)for(var i in t.cells)t.cells.hasOwnProperty(i)&&n.updateBracketNestingRecursive(t.cells[i],e)})}},{key:"createAccentElement",value:function(t,e,n,i){var r=i||("labeledoverbrace"===t||"labeledunderbrace"===t?[]:void 0);return{id:this.generateElementId(),type:"accent",accentType:t,accentPosition:e,accentBase:n||[],accentLabel:r}}},{key:"createFunctionElement",value:function(t){return{id:this.generateElementId(),type:"function",functionType:t,functionName:[],functionArgument:[],functionBase:[],functionConstraint:[]}}}],e&&b(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function L(t){return L="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},L(t)}function C(t){return function(t){if(Array.isArray(t))return E(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||I(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function S(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=I(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,r=function(){};return{s:r,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return o=t.done,t},e:function(t){s=!0,a=t},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function I(t,e){if(t){if("string"==typeof t)return E(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?E(t,e):void 0}}function E(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=Array(e);n<e;n++)i[n]=t[n];return i}function M(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,i)}return n}function P(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?M(Object(n),!0).forEach(function(e){T(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):M(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function B(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,A(i.key),i)}}function T(t,e,n){return(e=A(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function A(t){var e=function(t){if("object"!=L(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=L(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==L(e)?e:e+""}var O=function(){return t=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),T(this,"equationBuilder",null),T(this,"inputHandler",null),T(this,"FORMATTING_COMMANDS",[{command:"\\boldsymbol",length:11,applyFormatting:function(t){t.bold=!0,t.italic=!0}},{command:"\\mathbf",length:7,applyFormatting:function(t){t.bold=!0}},{command:"\\mathit",length:7,applyFormatting:function(t){t.italic=!0}},{command:"\\mathrm",length:7,applyFormatting:function(t){t.italic=!1}},{command:"\\textbf",length:7,applyFormatting:function(t){t.bold=!0}},{command:"\\textit",length:7,applyFormatting:function(t){t.italic=!0}}]),T(this,"DERIVATIVE_COMMANDS",[{command:"\\derivdfrac",length:11,displayMode:"display",isLongForm:!1},{command:"\\derivfrac",length:10,displayMode:"inline",isLongForm:!1},{command:"\\derivldfrac",length:12,displayMode:"display",isLongForm:!0},{command:"\\derivlfrac",length:11,displayMode:"inline",isLongForm:!0}]),T(this,"lastFormattingCommandEndIndex",null),T(this,"lastDerivativeCommandEndIndex",null),T(this,"lastStyleWrapperEndIndex",null),T(this,"lastAccentCommandEndIndex",null)},e=[{key:"setEquationBuilder",value:function(t){this.equationBuilder=t}},{key:"setInputHandler",value:function(t){this.inputHandler=t}},{key:"generateElementId",value:function(){return Math.random().toString(36).substr(2,9)}},{key:"parseGroupAndContent",value:function(t,e){var n=this.parseLatexGroup(t,e);return{elements:this.parseLatexToEquation(n.content),endIndex:n.endIndex}}},{key:"skipWhitespace",value:function(t,e){for(;e<t.length&&" "===t[e];)e++;return e}},{key:"convertToLatex",value:function(t){var e=this.findMaxNestingDepth(t);return this.toLatexRecursive(t,e).trim()}},{key:"parseFromLatex",value:function(t){return this.parseLatexToEquation(t)}},{key:"haveSameWrappers",value:function(t,e){if(t.wrappers||e.wrappers){if(!t.wrappers&&!e.wrappers)return!0;if(!t.wrappers||!e.wrappers)return!1;var n=function(n){var i=t.wrappers[n],r=e.wrappers[n];return!i&&!r||!(!i||!r)&&("underline"===n?i.type===r.type:"color"!==n||i.value===r.value)};return n("underline")&&n("cancel")&&n("color")&&n("textMode")}return!0}},{key:"findMaxNestingDepth",value:function(t){var e=function(t){var n=0;return t.forEach(function(t){"bracket"===t.type?(n=Math.max(n,t.nestingDepth||0),n=Math.max(n,e(t.content||[]))):[t.numerator,t.denominator,t.radicand,t.index,t.base,t.superscript,t.subscript,t.content,t.lowerLimit,t.upperLimit,t.operand].filter(Boolean).forEach(function(t){n=Math.max(n,e(t))})}),n};return e(t)}},{key:"toLatexRecursive",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i="",r=t,a=0;a<r.length;a++){var o=r[a];if(o.wrappers&&Object.keys(o.wrappers).length>0){for(var s=[],c=a;c<r.length&&this.haveSameWrappers(o,r[c]);)s.push(r[c]),c++;var u,p=s.map(function(t){var e=P({},t);return delete e.wrappers,e}),h=this.toLatexRecursive(p,e,n),f=S(o.wrapperOrder||["underline","cancel","color","textMode"]);try{for(f.s();!(u=f.n()).done;){var m=u.value;"underline"===m&&o.wrappers.underline?h="double"===o.wrappers.underline.type?"\\underline{\\underline{".concat(h,"}}"):"\\underline{".concat(h,"}"):"cancel"===m&&o.wrappers.cancel?h="\\cancel{".concat(h,"}"):"color"===m&&o.wrappers.color?h="\\textcolor{".concat(o.wrappers.color.value,"}{").concat(h,"}"):"textMode"===m&&o.wrappers.textMode&&(h="\\text{".concat(h,"}"))}}catch(t){f.e(t)}finally{f.f()}i+=h,a=c-1}else if("text"===o.type){for(var v=!0===o.textMode||o.wrappers&&o.wrappers.textMode,y="",g=a,b={bold:o.bold,italic:o.italic,color:o.color,underline:o.underline,cancel:o.cancel,wrappers:o.wrappers,textMode:o.textMode};g<r.length&&"text"===r[g].type&&this.hasEqualFormatting(r[g],b);){var x=r[g].value||"";if(v)y+=x=this.escapeLatexSpecialChars(x);else{var w=l[x];if(w){x=w;var k=g+1;k<r.length&&"text"===r[k].type&&/^[a-zA-Z]/.test(r[k].value||"")&&/\\[a-zA-Z]+$/.test(x)&&(x+=" ")}x=this.escapeLatexSpecialChars(x),/^[+\-=×÷]$/.test(x)?y+=" ".concat(x," "):y+=x}g++}var L=y;L=this.applyFormattingToLatex(L,b,n),v&&(L="\\text{".concat(L,"}")),i+=L,a=g-1}else if("fraction"===o.type){var C=this.toLatexRecursive(o.numerator,e,n),I=this.toLatexRecursive(o.denominator,e,n);"display"===o.displayMode?i+="\\dfrac{".concat(C||" ","}{").concat(I||" ","}"):i+="{\\textstyle \\frac{".concat(C||" ","}{").concat(I||" ","}}")}else if("bevelled-fraction"===o.type){var E=this.toLatexRecursive(o.numerator,e,n),M=this.toLatexRecursive(o.denominator,e,n);i+="{".concat(E||" ","}/{").concat(M||" ","}")}else if("sqrt"===o.type){var B=this.toLatexRecursive(o.radicand,e,n);i+="\\sqrt{".concat(B||" ","}")}else if("nthroot"===o.type){var T=this.toLatexRecursive(o.index,e,n),A=this.toLatexRecursive(o.radicand,e,n);i+="\\sqrt[".concat(T||" ","]{").concat(A||" ","}")}else if("script"===o.type){var O=this.toLatexRecursive(o.base,e,n);i+="{".concat(O||" ","}"),o.superscript&&o.subscript?i+="^{".concat(this.toLatexRecursive(o.superscript,e,n)||" ","}_{").concat(this.toLatexRecursive(o.subscript,e,n)||" ","}"):o.superscript?i+="^{".concat(this.toLatexRecursive(o.superscript,e,n)||" ","}"):o.subscript&&(i+="_{".concat(this.toLatexRecursive(o.subscript,e,n)||" ","}"))}else if("bracket"===o.type){var D=this.toLatexRecursive(o.content,e,n),q=this.getBracketLatexSymbols(o.leftBracketSymbol,o.rightBracketSymbol),R=q.latexLeft,F=q.latexRight,H="".concat(R).concat(D||" ").concat(F);if(o.superscript&&o.subscript){var j=this.toLatexRecursive(o.superscript,e,n),N=this.toLatexRecursive(o.subscript,e,n);H+="^{".concat(j||" ","}_{").concat(N||" ","}")}else if(o.superscript){var W=this.toLatexRecursive(o.superscript,e,n);H+="^{".concat(W||" ","}")}else if(o.subscript){var G=this.toLatexRecursive(o.subscript,e,n);H+="_{".concat(G||" ","}")}i+=H}else if("large-operator"===o.type){var z=this.convertOperatorToLatex(o.operator),_=this.toLatexRecursive(o.lowerLimit,e,n),U=this.toLatexRecursive(o.upperLimit,e,n),V=this.toLatexRecursive(o.operand,e,n),$=!0===o.isIndefiniteIntegral,K=z;"nolimits"===o.limitMode?K+="\\nolimits":"limits"===o.limitMode&&(K+="\\limits");var J,X=V?" {".concat(V,"}"):" {}";J=$?"".concat(K).concat(X):"".concat(K,"_{").concat(_||"","}^{").concat(U||"","}").concat(X),"display"===o.displayMode?i+="{\\displaystyle ".concat(J,"}"):i+="{\\textstyle ".concat(J,"}")}else if("integral"===o.type){var Z=this.toLatexRecursive(o.integrand,e,n),Q=this.toLatexRecursive(o.differentialVariable,e,n),Y="",tt="roman"===o.integralStyle,et=o.lowerLimit&&o.lowerLimit.length>0,nt=o.upperLimit&&o.upperLimit.length>0,it=et||nt,rt="isDefinite"in o&&o.isDefinite||it,at=et&&!nt;switch(o.integralType){case"double":Y=at?"limits"===o.limitMode?tt?"\\iintdlower":"\\iintilower":tt?"\\iintdsub":"\\iintisub":rt?"limits"===o.limitMode?tt?"\\iintdlim":"\\iintilim":tt?"\\iintdnolim":"\\iintinolim":tt?"\\iintd":"\\iinti";break;case"triple":Y=at?"limits"===o.limitMode?tt?"\\iiintdlower":"\\iiintilower":tt?"\\iiintdsub":"\\iiintisub":rt?"limits"===o.limitMode?tt?"\\iiintdlim":"\\iiintilim":tt?"\\iiintdnolim":"\\iiintinolim":tt?"\\iiintd":"\\iiinti";break;case"contour":Y=at?tt?"\\ointdsub":"\\ointisub":rt?tt?"\\ointdnolim":"\\ointinolim":tt?"\\ointd":"\\ointi";break;default:Y=rt?"limits"===o.limitMode?tt?"\\intdlim":"\\intilim":tt?"\\intdnolim":"\\intinolim":tt?"\\intd":"\\inti"}var ot="";if(Y.includes("sub")||Y.includes("lower")){var st=et?this.toLatexRecursive(o.lowerLimit,e,n):" ";ot="".concat(Y,"{").concat(Z||" ","}{").concat(Q||" ","}{").concat(st,"}")}else if(et&&nt){var ct=this.toLatexRecursive(o.lowerLimit,e,n),lt=this.toLatexRecursive(o.upperLimit,e,n);ot="".concat(Y,"{").concat(Z||" ","}{").concat(Q||" ","}{").concat(ct||" ","}{").concat(lt||" ","}")}else ot="".concat(Y,"{").concat(Z||" ","}{").concat(Q||" ","}");"display"===o.displayMode?i+=ot="{\\displaystyle ".concat(ot,"}"):i+="{\\textstyle ".concat(ot,"}")}else if("derivative"===o.type){var ut=this.toLatexRecursive(o.function,e,n),dt=this.toLatexRecursive(o.variable,e,n),pt=!0===o.isPartial;if(o.isLongForm)if(pt||this.shouldUsePhysicsPackageForDerivative()){var ht=pt?"\\pdv":"\\dv",ft="";if("number"==typeof o.order)ft=1===o.order?"".concat(ht,"{").concat(dt||"x","}"):"".concat(ht,"[").concat(o.order,"]{").concat(dt||"x","}");else{var mt=this.toLatexRecursive(o.order,e,n);ft="".concat(ht,"[").concat(mt||"n","]{").concat(dt||"x","}")}var vt,yt=ut||"",gt=!1,bt=S(d);try{for(bt.s();!(vt=bt.n()).done;){var xt=vt.value;if(yt.startsWith(xt.left)&&yt.endsWith(xt.right)){var wt=yt.slice(xt.left.length,-xt.right.length);yt="".concat(xt.left,"\\grande{").concat(wt,"}").concat(xt.right),gt=!0;break}}}catch(t){bt.e(t)}finally{bt.f()}gt||(yt=yt?"\\grande{".concat(yt,"}"):"\\grande{ }"),pt&&console.log("Long form export debug:",{dvCommand:ft,functionPart:yt,displayMode:o.displayMode,variableLatex:dt,order:o.order}),"display"===o.displayMode?i+="{\\displaystyle ".concat(ft).concat(yt,"}"):i+="{\\textstyle ".concat(ft).concat(yt,"}")}else{var kt=pt?"\\partial":"d",Lt="",Ct="";if("number"==typeof o.order)1===o.order?(Lt=kt,Ct="".concat(kt).concat(dt||"x")):(Lt="".concat(kt,"^{").concat(o.order,"}"),Ct="".concat(kt).concat(dt||"x","^{").concat(o.order,"}"));else{var St=this.toLatexRecursive(o.order,e,n);Lt="".concat(kt,"^{").concat(St||"n","}"),Ct="".concat(kt).concat(dt||"x","^{").concat(St||"n","}")}"display"===o.displayMode?i+="\\derivldfrac{".concat(Lt,"}{").concat(Ct,"}{").concat(ut||" ","}"):i+="\\derivlfrac{".concat(Lt,"}{").concat(Ct,"}{").concat(ut||" ","}")}else if(pt||this.shouldUsePhysicsPackageForDerivative()){var It=pt?"\\pdv":"\\dv",Et="";if("number"==typeof o.order)Et=1===o.order?"".concat(It,"{").concat(ut||" ","}{").concat(dt||" ","}"):"".concat(It,"[").concat(o.order,"]{").concat(ut||" ","}{").concat(dt||" ","}");else{var Mt=this.toLatexRecursive(o.order,e,n);Et="".concat(It,"[").concat(Mt||"n","]{").concat(ut||" ","}{").concat(dt||" ","}")}pt&&console.log("Export debug:",{functionLatex:ut,variableLatex:dt,dvCommand:Et,displayMode:o.displayMode,isLongForm:o.isLongForm,order:o.order}),"display"===o.displayMode?i+="{\\displaystyle ".concat(Et,"}"):i+="{\\textstyle ".concat(Et,"}")}else{var Pt=pt?"\\partial":"d",Bt="",Tt="";if("number"==typeof o.order)1===o.order?(Bt="".concat(Pt).concat(ut||" "),Tt="".concat(Pt).concat(dt||" ")):(Bt="".concat(Pt,"^{").concat(o.order,"}").concat(ut||" "),Tt="".concat(Pt).concat(dt||" ","^{").concat(o.order,"}"));else{var At=this.toLatexRecursive(o.order,e,n);Bt="".concat(Pt,"^{").concat(At||"n","}").concat(ut||" "),Tt="".concat(Pt).concat(dt||" ","^{").concat(At||"n","}")}"display"===o.displayMode?i+="\\derivdfrac{".concat(Bt,"}{").concat(Tt,"}"):i+="\\derivfrac{".concat(Bt,"}{").concat(Tt,"}")}}else"matrix"===o.type?i+=this.matrixToLatex(o,e,n):"stack"===o.type?i+=this.stackToLatex(o,e,n):"cases"===o.type?i+=this.casesToLatex(o,e,n):"accent"===o.type?i+=this.accentToLatex(o,e,n):"function"===o.type&&(i+=this.functionToLatex(o,e,n))}return i}},{key:"matrixToLatex",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=t.rows,r=t.cols,a=t.cells,o=t.matrixType;if(!i||!r||!a)return"";for(var s=[],c=0;c<i;c++){for(var l=[],u=0;u<r;u++){var d=a["cell_".concat(c,"_").concat(u)]||[],p=this.toLatexRecursive(d,e,n).trim();l.push(p||"")}s.push(l.join(" & "))}var h=s.join(" \\\\ "),f="";switch(o){case"parentheses":default:f="\\begin{pmatrix}".concat(h,"\\end{pmatrix}");break;case"brackets":f="\\begin{bmatrix}".concat(h,"\\end{bmatrix}");break;case"braces":f="\\begin{Bmatrix}".concat(h,"\\end{Bmatrix}");break;case"bars":f="\\begin{vmatrix}".concat(h,"\\end{vmatrix}");break;case"double-bars":f="\\begin{Vmatrix}".concat(h,"\\end{Vmatrix}");break;case"none":f="\\begin{matrix}".concat(h,"\\end{matrix}")}var m=P({},t);return delete m.bold,delete m.italic,this.applyFormattingToLatex(f,m,!1)}},{key:"stackToLatex",value:function(t,e){var n=t.rows,i=t.cols,r=t.cells;if(!n||!i||!r)return"\\text{Invalid Stack}";for(var a=[],o=0;o<n;o++){for(var s=[],c=0;c<i;c++){var l=r["cell_".concat(o,"_").concat(c)]||[],u=this.toLatexRecursive(l,e-1).trim();s.push(u)}a.push(s.join(" & "))}var d=a.join(" \\\\ "),p="\\begin{array}{".concat("c".repeat(i),"}").concat(d,"\\end{array}"),h=P({},t);return delete h.bold,delete h.italic,this.applyFormattingToLatex(p,h,!1)}},{key:"casesToLatex",value:function(t,e){var n=t.rows,i=t.cols,r=t.cells;if(!n||!i||!r)return"\\text{Invalid Cases}";for(var a=[],o=0;o<n;o++){for(var s=[],c=0;c<i;c++){var l=r["cell_".concat(o,"_").concat(c)]||[],u=this.toLatexRecursive(l,e-1).trim();s.push(u)}a.push(s.join(" & "))}var d=a.join(" \\\\ "),p="\\begin{cases}".concat(d,"\\end{cases}"),h=P({},t);return delete h.bold,delete h.italic,this.applyFormattingToLatex(p,h,!1)}},{key:"accentToLatex",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=this.toLatexRecursive(t.accentBase||[],e,n);switch(t.accentType){case"hat":default:return"\\hat{".concat(i,"}");case"tilde":return"\\tilde{".concat(i,"}");case"bar":return"\\bar{".concat(i,"}");case"dot":return"\\dot{".concat(i,"}");case"ddot":return"\\ddot{".concat(i,"}");case"vec":return"\\vec{".concat(i,"}");case"widehat":return"\\widehat{".concat(i,"}");case"widetilde":return"\\widetilde{".concat(i,"}");case"widebar":return"\\overline{".concat(i,"}");case"overrightarrow":return"\\overrightarrow{".concat(i,"}");case"overleftarrow":return"\\overleftarrow{".concat(i,"}");case"overleftrightarrow":return"\\overleftrightarrow{".concat(i,"}");case"overbrace":if(t.accentLabel&&t.accentLabel.length>0){var r=this.toLatexRecursive(t.accentLabel,e,n);return"\\overbrace{".concat(i,"}^{").concat(r,"}")}return"\\overbrace{".concat(i,"}");case"underbrace":if(t.accentLabel&&t.accentLabel.length>0){var a=this.toLatexRecursive(t.accentLabel,e,n);return"\\underbrace{".concat(i,"}_{").concat(a,"}")}return"\\underbrace{".concat(i,"}");case"labeledoverbrace":var o=this.toLatexRecursive(t.accentLabel||[],e,n);return"\\overbrace{".concat(i,"}^{").concat(o,"}");case"labeledunderbrace":var s=this.toLatexRecursive(t.accentLabel||[],e,n);return"\\underbrace{".concat(i,"}_{").concat(s,"}");case"overparen":return"\\overparen{".concat(i,"}");case"underparen":return"\\underparen{".concat(i,"}")}}},{key:"functionToLatex",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=t.functionType,r=this.toLatexRecursive(t.functionArgument||[],e,n);if(["function","functionsub","functionlim"].includes(i)){var a=this.toLatexRecursive(t.functionName||[],e,!0);if(!a)return r||"\\square";if("functionlim"===i){var o=this.toLatexRecursive(t.functionConstraint||[],e,n);return"{\\displaystyle \\operatorname*{".concat(a,"}_{").concat(o,"} ").concat(r,"}")}if("functionsub"===i){var s=this.toLatexRecursive(t.functionBase||[],e,n);return"\\operatorname{".concat(a,"}_{").concat(s,"} ").concat(r)}return"\\operatorname{".concat(a,"} ").concat(r)}if(["max","min","lim","argmax","argmin"].includes(i)){var c=this.toLatexRecursive(t.functionConstraint||[],e,n);return"{\\displaystyle \\operatorname*{".concat("argmax"===i?"argmax":"argmin"===i?"argmin":i,"}_{").concat(c,"} ").concat(r,"}")}if("logn"===i){var l=this.toLatexRecursive(t.functionBase||[],e,n);return"\\log_{".concat(l,"} ").concat(r)}return["asin","acos","atan","asinh","acosh","atanh"].includes(i)?"\\operatorname{".concat({asin:"sin",acos:"cos",atan:"tan",asinh:"sinh",acosh:"cosh",atanh:"tanh"}[i],"^{-1}} ").concat(r):"\\".concat(i," ").concat(r)}},{key:"shouldUsePhysicsPackageForDerivative",value:function(){return!(!this.inputHandler||"function"!=typeof this.inputHandler.getDifferentialStyleForLatex)&&this.inputHandler.getDifferentialStyleForLatex()}},{key:"parseLatexToEquation",value:function(t){for(var e=this,n=[],i=0,r=function(){if("\\displaystyle"===t.substr(i,13)){for(i+=13;i<t.length&&" "===t[i];)i++;if(e.isLargeOperator(t,i)){var r=e.parseLargeOperator(t,i,!0);r?(n.push(r.element),i=r.endIndex):i++}else if("\\dv"===t.substr(i,3)){i+=3;var a=e.parseDvCommand(t,i,"display",!1,!1);a&&(n.push(a.element),i=a.endIndex)}else if("\\pdv"===t.substr(i,4)){i+=4;var o=e.parseDvCommand(t,i,"display",!1,!0);o&&(n.push(o.element),i=o.endIndex)}else{var s=e.parseCustomIntegral(t,i);s?(s.element.displayMode="display",n.push(s.element),i=s.endIndex):n.push({id:e.generateElementId(),type:"text",value:"\\displaystyle"})}}else if("\\textstyle"===t.substr(i,10)){for(i+=10;i<t.length&&" "===t[i];)i++;if(e.isLargeOperator(t,i)){var c=e.parseLargeOperator(t,i,!1);c?(n.push(c.element),i=c.endIndex):i++}else if("\\dv"===t.substr(i,3)){i+=3;var l=e.parseDvCommand(t,i,"inline",!1,!1);l&&(n.push(l.element),i=l.endIndex)}else if("\\pdv"===t.substr(i,4)){i+=4;var u=e.parseDvCommand(t,i,"inline",!1,!0);u&&(n.push(u.element),i=u.endIndex)}else{var d=e.parseCustomIntegral(t,i);d&&(d.element.displayMode="inline",n.push(d.element),i=d.endIndex)}}else if(e.tryParseDerivativeCommand(t,i,n))i=e.lastDerivativeCommandEndIndex;else if("\\dfrac"===t.substr(i,6)){i+=6;var p=e.parseLatexGroup(t,i);i=p.endIndex;var h=e.parseLatexGroup(t,i);i=h.endIndex,n.push({id:e.generateElementId(),type:"fraction",displayMode:"display",numerator:e.parseLatexToEquation(p.content),denominator:e.parseLatexToEquation(h.content)})}else if("\\frac"===t.substr(i,5)){i+=5;var f=e.parseLatexGroup(t,i);i=f.endIndex;var m=e.parseLatexGroup(t,i);i=m.endIndex,n.push({id:e.generateElementId(),type:"fraction",displayMode:"inline",numerator:e.parseLatexToEquation(f.content),denominator:e.parseLatexToEquation(m.content)})}else if("\\begin"===t.substr(i,6)){var v=e.parseMatrixStackCasesEnvironment(t,i);v?(n.push(v.element),i=v.endIndex):(n.push({id:e.generateElementId(),type:"text",value:t[i]}),i++)}else if(e.isLargeOperator(t,i)){var y=e.parseLargeOperator(t,i,!1);y?(n.push(y.element),i=y.endIndex):i++}else if(e.tryParseStyleWrapper(t,i,n))i=e.lastStyleWrapperEndIndex;else if("\\dv"===t.substr(i,3)){i+=3;var g=e.parseDvCommand(t,i,"inline",!1,!1);g&&(n.push(g.element),i=g.endIndex)}else if("\\pdv"===t.substr(i,4)){i+=4;var b=e.parseDvCommand(t,i,"inline",!1,!0);b&&(n.push(b.element),i=b.endIndex)}else if(e.isBuiltinFunctionCommand(t,i)){var x=e.parseBuiltinFunctionCommand(t,i);x&&(n.push(x.element),i=x.endIndex)}else if("\\operatorname"===t.substr(i,13)){var w=e.parseOperatorName(t,i);w&&(n.push(w.element),i=w.endIndex)}else if(e.isCustomIntegralCommand(t,i)){var k=e.parseCustomIntegral(t,i);k?(n.push(k.element),i=k.endIndex):i++}else if("\\sqrt"===t.substr(i,5))if((i+=5)<t.length&&"["===t[i]){for(var L=i+1,S=L,I=1;S<t.length&&I>0;)"["===t[S]?I++:"]"===t[S]&&I--,S++;var E=t.substring(L,S-1);i=S;var M=e.parseLatexGroup(t,i);i=M.endIndex,n.push({id:e.generateElementId(),type:"nthroot",index:e.parseLatexToEquation(E),radicand:e.parseLatexToEquation(M.content)})}else{var P=e.parseLatexGroup(t,i);i=P.endIndex,n.push({id:e.generateElementId(),type:"sqrt",radicand:e.parseLatexToEquation(P.content)})}else if("^"===t[i]||"_"===t[i]){var B,T="^"===t[i];if(i++,n.length>0&&"script"===n[n.length-1].type)B=n.pop();else if(n.length>0){var A=n.pop();B={id:e.generateElementId(),type:"script",base:[A],superscript:void 0,subscript:void 0}}else B={id:e.generateElementId(),type:"script",base:[],superscript:void 0,subscript:void 0};var O=e.parseLatexGroup(t,i);i=O.endIndex,T?B.superscript=e.parseLatexToEquation(O.content):B.subscript=e.parseLatexToEquation(O.content),n.push(B)}else if("{"===t[i]){var D=e.parseLatexGroup(t,i);i=D.endIndex;var q=e.extractFromStyleWrapper(D.content,0);if(q&&q.hasWrapper){var R=e.parseLatexToEquation(q.content);q.styleType&&e.applyStyleModeToElements(R,q.styleType),n.push.apply(n,C(R))}else n.push.apply(n,C(e.parseLatexToEquation(D.content)))}else if(" "===t[i])i++;else if("\\"!==t[i]||e.isBracketCommand(t,i)||e.isLargeOperator(t,i))if("{\\text{^}}"===t.substr(i,10))n.push({id:e.generateElementId(),type:"text",value:"^"}),i+=10;else if("{\\_}"===t.substr(i,5))n.push({id:e.generateElementId(),type:"text",value:"_"}),i+=5;else if("\\textasciitilde"===t.substr(i,17))n.push({id:e.generateElementId(),type:"text",value:"~"}),i+=17,"{}"===t.substr(i,2)&&(i+=2);else if("\\{"===t.substr(i,2))n.push({id:e.generateElementId(),type:"text",value:"{"}),i+=2;else if("\\}"===t.substr(i,2))n.push({id:e.generateElementId(),type:"text",value:"}"}),i+=2;else if("\\#"===t.substr(i,2))n.push({id:e.generateElementId(),type:"text",value:"#"}),i+=2;else if("\\%"===t.substr(i,2))n.push({id:e.generateElementId(),type:"text",value:"%"}),i+=2;else if("\\left"===t.substr(i,5)){var F=e.parseBracketCommand(t,i);F?(n.push({id:e.generateElementId(),type:"bracket",leftBracketSymbol:F.leftSymbol,rightBracketSymbol:F.rightSymbol,content:e.parseLatexToEquation(F.content)}),i=F.endIndex):(n.push({id:e.generateElementId(),type:"text",value:t[i]}),i++)}else if(e.isBracketCommand(t,i)){var H=e.parseBracketCommand(t,i);if(H)n.push({id:e.generateElementId(),type:"bracket",leftBracketSymbol:H.leftSymbol,rightBracketSymbol:H.rightSymbol,content:e.parseLatexToEquation(H.content)}),i=H.endIndex;else{var j=e.skipBracketCommand(t,i);j>0?i+=j:(n.push({id:e.generateElementId(),type:"text",value:t[i]}),i++)}}else n.push({id:e.generateElementId(),type:"text",value:t[i]}),i++;else{var N=e.tryParseLatexSymbol(t,i,n);if(null!==N)i=N;else if(e.tryParseFormattingCommand(t,i,n))i=e.lastFormattingCommandEndIndex;else if("\\textcolor"===t.substr(i,10)){i+=10;var W=e.parseLatexGroup(t,i);i=W.endIndex;var G=e.parseLatexGroup(t,i);i=G.endIndex;var z=e.parseLatexToEquation(G.content);e.generateElementId(),e.applyWrapperToElements(z,"color",W.content),n.push.apply(n,C(z))}else if("\\color"===t.substr(i,6)){i+=6;var _=e.parseLatexGroup(t,i);i=_.endIndex;var U=e.parseLatexGroup(t,i);i=U.endIndex;var V=e.parseLatexToEquation(U.content);V.forEach(function(t){"text"===t.type&&(t.color=_.content)}),n.push.apply(n,C(V))}else if("\\underline"===t.substr(i,10)){i+=10;var $=e.parseLatexGroup(t,i);i=$.endIndex;var K=$.content.startsWith("\\underline{")&&$.content.endsWith("}");if(e.generateElementId(),K){var J=$.content.slice(11,-1),X=e.parseLatexToEquation(J);e.applyWrapperToElements(X,"underline","double"),n.push.apply(n,C(X))}else{var Z=e.parseLatexToEquation($.content);e.applyWrapperToElements(Z,"underline","single"),n.push.apply(n,C(Z))}}else if("\\cancel"===t.substr(i,7)){i+=7;var Q=e.parseLatexGroup(t,i);i=Q.endIndex;var Y=e.parseLatexToEquation(Q.content);e.applyWrapperToElements(Y,"cancel"),n.push.apply(n,C(Y))}else if(e.tryParseAccentCommand(t,i,n))i=e.lastAccentCommandEndIndex;else if("\\text{"===t.substr(i,6))if("\\text{＆}"===t.substr(i,9))n.push({id:e.generateElementId(),type:"text",value:"&"}),i+=9;else{i+=6;var tt=e.parseLatexGroup(t,i-1);i=tt.endIndex;for(var et=tt.content,nt=0;nt<et.length;nt++){var it=et[nt];n.push({id:e.generateElementId(),type:"text",value:it,textMode:!0,italic:!1})}}else i++}};i<t.length;)r();return n}},{key:"parseLatexGroup",value:function(t,e){if("{"!==t[e])return{content:t[e]||"",endIndex:e+1};for(var n=0,i=e;i<t.length;){if("{"===t[i])n++;else if("}"===t[i]&&0===--n)return{content:t.substring(e+1,i),endIndex:i+1};i++}return{content:t.substring(e+1),endIndex:t.length}}},{key:"isBracketCommand",value:function(t,e){return["\\left"].some(function(n){return t.substr(e,n.length)===n})}},{key:"skipBracketCommand",value:function(t,e){for(var n=0,i=["\\left","\\right"];n<i.length;n++){var r=i[n];if(t.substr(e,r.length)===r)return r.length}return 0}},{key:"parseBracketCommand",value:function(t,e){for(var n="",i=["\\left"],r=0;r<i.length;r++)if(t.substr(e,i[r].length)===i[r]){n=i[r];break}if(!n)return null;var a=e+n.length,o=this.extractBracketSymbol(t,a);if(!o)return null;a=o.endIndex;for(var s=o.symbol,c=a,l=1,u=a;u<t.length&&l>0;)if("\\right"===t.substr(u,6)){var d=this.extractBracketSymbol(t,u+6);if(d){if(0===--l){var p=t.substring(c,u);return{leftSymbol:s,rightSymbol:d.symbol,content:p,endIndex:d.endIndex}}u=d.endIndex}else u++}else this.isBracketCommand(t,u)?(l++,u++):u++;return null}},{key:"extractBracketSymbol",value:function(t,e){if(e>=t.length)return null;if("("===t[e])return{symbol:"(",endIndex:e+1};if(")"===t[e])return{symbol:")",endIndex:e+1};if("["===t[e])return{symbol:"[",endIndex:e+1};if("]"===t[e])return{symbol:"]",endIndex:e+1};if("|"===t[e])return{symbol:"|",endIndex:e+1};if("."===t[e])for(var n=0,i=["\\left","\\right"];n<i.length;n++){var r=i[n];if(e>=r.length&&t.substr(e-r.length,r.length)===r)return{symbol:".",endIndex:e+1}}return"\\{"===t.substr(e,2)?{symbol:"{",endIndex:e+2}:"\\}"===t.substr(e,2)?{symbol:"}",endIndex:e+2}:"\\|"===t.substr(e,2)?{symbol:"‖",endIndex:e+2}:"\\lfloor"===t.substr(e,7)?{symbol:"⌊",endIndex:e+7}:"\\rfloor"===t.substr(e,7)?{symbol:"⌋",endIndex:e+7}:"\\lceil"===t.substr(e,6)?{symbol:"⌈",endIndex:e+6}:"\\rceil"===t.substr(e,6)?{symbol:"⌉",endIndex:e+6}:"\\langle"===t.substr(e,7)?{symbol:"⟨",endIndex:e+7}:"\\rangle"===t.substr(e,7)?{symbol:"⟩",endIndex:e+7}:null}},{key:"getBracketLatexSymbols",value:function(t,e){var n=function(t,e){if(!t)return"";switch(t){case"(":return"\\left(";case")":return"\\right)";case"[":return"\\left[";case"]":return"\\right]";case"{":return"\\left\\{";case"}":return"\\right\\}";case"⌊":return"\\left\\lfloor";case"⌋":return"\\right\\rfloor";case"⌈":return"\\left\\lceil";case"⌉":return"\\right\\rceil";case"|":return e?"\\left|":"\\right|";case"‖":return e?"\\left\\|":"\\right\\|";case"⟨":return"\\left\\langle";case"⟩":return"\\right\\rangle";case".":return e?"\\left.":"\\right.";default:return t}};return{latexLeft:n(t,!0),latexRight:n(e,!1)}}},{key:"hasEqualFormatting",value:function(t,e){var n=t.bold===e.bold&&this.getEffectiveItalicFormatting(t.italic)===this.getEffectiveItalicFormatting(e.italic)&&t.color===e.color&&t.underline===e.underline&&t.cancel===e.cancel&&t.textMode===e.textMode;if(t.wrappers||e.wrappers){var i={id:"",type:"text",value:"",wrappers:e.wrappers};return n&&this.haveSameWrappers(t,i)}return n}},{key:"checkUniformFormatting",value:function(t){if(0===t.length)return null;var e=this.collectAllFormattings(t);if(0===e.length)return null;var n=e.map(function(t){return{cancel:t.cancel,underline:t.underline,color:t.color}}).filter(function(t){return t.cancel||t.underline||t.color});if(0===n.length)return null;var i,r=n[0],a=S(n);try{for(a.s();!(i=a.n()).done;){var o=i.value;if(o.cancel!==r.cancel||o.underline!==r.underline||o.color!==r.color)return null}}catch(t){a.e(t)}finally{a.f()}var s=this.countTextElements(t);return this.collectAllFormattings(t).filter(function(t){return t.cancel||t.underline||t.color}).length!==n.length||n.length<2||n.length<Math.ceil(.8*s)?null:r}},{key:"collectAllFormattings",value:function(t){var e,n=[],i=S(t);try{for(i.s();!(e=i.n()).done;){var r=e.value;if("text"===r.type)(r.cancel||r.underline||r.color||r.bold||void 0!==r.italic)&&n.push({bold:r.bold,italic:r.italic,color:r.color,underline:r.underline,cancel:r.cancel});else{var a,o=S([r.numerator,r.denominator,r.radicand,r.index,r.base,r.superscript,r.subscript,r.content,r.lowerLimit,r.upperLimit,r.operand,r.integrand,r.differentialVariable,r.function,r.variable,r.order].filter(Boolean));try{for(o.s();!(a=o.n()).done;){var s=a.value;Array.isArray(s)&&n.push.apply(n,C(this.collectAllFormattings(s)))}}catch(t){o.e(t)}finally{o.f()}if("matrix"===r.type&&r.cells)for(var c in r.cells)n.push.apply(n,C(this.collectAllFormattings(r.cells[c])))}}}catch(t){i.e(t)}finally{i.f()}return n}},{key:"countTextElements",value:function(t){var e,n=0,i=S(t);try{for(i.s();!(e=i.n()).done;){var r=e.value;if("text"===r.type)n++;else{var a,o=S([r.numerator,r.denominator,r.radicand,r.index,r.base,r.superscript,r.subscript,r.content,r.lowerLimit,r.upperLimit,r.operand,r.integrand,r.differentialVariable,r.function,r.variable,r.order].filter(Boolean));try{for(o.s();!(a=o.n()).done;){var s=a.value;Array.isArray(s)&&(n+=this.countTextElements(s))}}catch(t){o.e(t)}finally{o.f()}if("matrix"===r.type&&r.cells)for(var c in r.cells)n+=this.countTextElements(r.cells[c])}}}catch(t){i.e(t)}finally{i.f()}return n}},{key:"removeUniformFormattingFromElements",value:function(t,e){var n=this;return t.map(function(t){return n.removeUniformFormattingFromElement(t,e)})}},{key:"removeUniformFormattingFromElement",value:function(t,e){var n=this,i=JSON.parse(JSON.stringify(t));e.cancel&&i.cancel===e.cancel&&delete i.cancel,e.underline&&i.underline===e.underline&&delete i.underline,e.color&&i.color===e.color&&delete i.color;for(var r=0,a=["numerator","denominator","radicand","index","base","superscript","subscript","content","lowerLimit","upperLimit","operand","integrand","differentialVariable","function","variable","order"];r<a.length;r++){var o=a[r];i[o]&&Array.isArray(i[o])&&(i[o]=i[o].map(function(t){return n.removeUniformFormattingFromElement(t,e)}))}if("matrix"===i.type&&i.cells)for(var s in i.cells)i.cells[s]=i.cells[s].map(function(t){return n.removeUniformFormattingFromElement(t,e)});return i}},{key:"getEffectiveItalicFormatting",value:function(t){return!0===t?"mathit":!1===t?"mathrm":"plain"}},{key:"isOperatorSymbol",value:function(t){var e=t.trim(),n=Object.values(s).find(function(t){return t.unicode===e});if(n&&!n.defaultItalic)return!0;var i=s[e];return!(!i||i.defaultItalic)||t!==e&&1===e.length&&this.isOperatorSymbol(e)}},{key:"applyWrapperToElements",value:function(t,e,n){var i=this.generateElementId();t.forEach(function(t){t.wrappers||(t.wrappers={}),t.wrapperOrder||(t.wrapperOrder=[]),t.wrappers[e]||t.wrapperOrder.push(e),"cancel"===e?t.wrappers.cancel={id:i}:"underline"===e?t.wrappers.underline={id:i,type:n}:"color"===e&&(t.wrappers.color={id:i,value:n})})}},{key:"applyFormattingToLatex",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=t;return e.bold&&e.italic?i="\\boldsymbol{".concat(i,"}"):e.bold?i="\\mathbf{".concat(i,"}"):!0===e.italic?i="\\mathit{".concat(i,"}"):!1===e.italic&&(e.textMode||i.startsWith("\\")||this.isOperatorSymbol(i)||n||(i="\\mathrm{".concat(i,"}"))),e.underline&&(i="double"===e.underline?"\\underline{\\underline{".concat(i,"}}"):"\\underline{".concat(i,"}")),e.cancel&&(i="\\cancel{".concat(i,"}")),e.color&&(i="\\textcolor{".concat(e.color,"}{").concat(i,"}")),i}},{key:"convertOperatorToLatex",value:function(t){return l[t]||t}},{key:"isLatexCommand",value:function(t,e){if("\\"!==t[e])return!1;for(var n=e+1;n<t.length&&t[n].match(/[a-zA-Z]/);)n++;return n>e+1}},{key:"isLargeOperator",value:function(t,e){return u.some(function(n){if(t.substr(e,n.length)===n){var i=e+n.length;if(i>=t.length||!t[i].match(/[a-zA-Z]/))return!0}return!1})}},{key:"parseLargeOperator",value:function(t,e,n){var i,r="",a="",o=S(u);try{for(o.s();!(i=o.n()).done;){var s=i.value;if(t.substr(e,s.length)===s){r=s,a=c[s]||"";break}}}catch(t){o.e(t)}finally{o.f()}if(!r)return null;var l=e+r.length,d="limits",p=n?"display":"inline";"\\limits"===t.substr(l,7)?(d="limits",l+=7):"\\nolimits"===t.substr(l,9)&&(d="nolimits",l+=9);for(var h=[],f=[],m=[];l<t.length&&" "===t[l];)l++;if(l<t.length&&"_"===t[l]){l++;var v=this.parseLatexGroup(t,l);h=this.parseLatexToEquation(v.content),l=v.endIndex}for(;l<t.length&&" "===t[l];)l++;if(l<t.length&&"^"===t[l]){l++;var y=this.parseLatexGroup(t,l);f=this.parseLatexToEquation(y.content),l=y.endIndex}for(;l<t.length&&" "===t[l];)l++;if(l<t.length&&"{"===t[l]){var g=this.parseLatexGroup(t,l);m=this.parseLatexToEquation(g.content),l=g.endIndex}return{element:{id:this.generateElementId(),type:"large-operator",operator:a,limitMode:d,displayMode:p,lowerLimit:h,upperLimit:f,operand:m},endIndex:l}}},{key:"escapeLatexSpecialChars",value:function(t){var e=t;return e.startsWith("\\")?e:e=(e=(e=(e=(e=(e=(e=(e=e.replace(/\{/g,"\\{")).replace(/\}/g,"\\}")).replace(/#/g,"\\#")).replace(/&/g,"\\text{＆}")).replace(/%/g,"\\%")).replace(/~/g,"\\textasciitilde{}")).replace(/\^/g,"{\\text{^}}")).replace(/_/g,"{\\_}")}},{key:"tryParseLatexSymbol",value:function(t,e,n){var i=function(t,e){for(var n=Math.min(20,t.length-e);n>=2;n--){var i=t.substr(e,n);if(c[i])return n}return 0}(t,e);if(i>0){var r=t.substr(e,i),a=c[r];if(a)return n.push({id:this.generateElementId(),type:"text",value:a}),e+i}return null}},{key:"isCustomIntegralCommand",value:function(t,e){var n,i=S(p);try{for(i.s();!(n=i.n()).done;){var r=n.value;if(t.substr(e,r.length)===r){var a=t[e+r.length];if(!a||"{"===a||"["===a||" "===a||"\\"===a)return console.log("Found integral command:",r,"at index:",e),!0}}}catch(t){i.e(t)}finally{i.f()}return"\\"===t[e]&&t.substr(e,10).includes("int")&&console.log("Checking integral at",e,":",t.substr(e,15),"against commands:",p.slice(0,5)),!1}},{key:"parseFraction",value:function(t,e,n){var i=!1,r=e;if("\\dfrac"===t.substr(r,6))i=!0,r+=6;else{if("\\frac"!==t.substr(r,5))return null;r+=5}if(r>=t.length||"{"!==t[r])return null;var a=this.parseLatexGroup(t,r);if((r=a.endIndex)>=t.length||"{"!==t[r])return null;var o=this.parseLatexGroup(t,r);return r=o.endIndex,{element:{id:this.generateElementId(),type:"fraction",numerator:this.parseLatexToEquation(a.content),denominator:this.parseLatexToEquation(o.content),displayMode:n?"inline":i?"display":void 0},endIndex:r}}},{key:"parseCustomIntegral",value:function(t,e){var n=e;console.log("parseCustomIntegral called with:",t.substr(e,20));var i="single",r="italic",a=0,o=!1,s="default";if("\\iiintdnolim"===t.substr(n,12))i="triple",r="roman",a=12,o=!0,s="nolimits";else if("\\iiintinolim"===t.substr(n,12))i="triple",r="italic",a=12,o=!0,s="nolimits";else if("\\iiintdlim"===t.substr(n,10))i="triple",r="roman",a=10,o=!0,s="limits";else if("\\iiintilim"===t.substr(n,10))i="triple",r="italic",a=10,o=!0,s="limits";else if("\\iintdnolim"===t.substr(n,11))i="double",r="roman",a=11,o=!0,s="nolimits";else if("\\iintinolim"===t.substr(n,11))i="double",r="italic",a=11,o=!0,s="nolimits";else if("\\iintdlim"===t.substr(n,9))i="double",r="roman",a=9,o=!0,s="limits";else if("\\iintilim"===t.substr(n,9))i="double",r="italic",a=9,o=!0,s="limits";else if("\\ointdnolim"===t.substr(n,11))i="contour",r="roman",a=11,o=!0,s="nolimits";else if("\\ointinolim"===t.substr(n,11))i="contour",r="italic",a=11,o=!0,s="nolimits";else if("\\ointdlim"===t.substr(n,9))i="contour",r="roman",a=9,o=!0,s="limits";else if("\\ointilim"===t.substr(n,9))i="contour",r="italic",a=9,o=!0,s="limits";else if("\\intdnolim"===t.substr(n,10))i="single",r="roman",a=10,o=!0,s="nolimits";else if("\\intinolim"===t.substr(n,10))i="single",r="italic",a=10,o=!0,s="nolimits";else if("\\intdlim"===t.substr(n,8))i="single",r="roman",a=8,o=!0,s="limits";else if("\\intilim"===t.substr(n,8))i="single",r="italic",a=8,o=!0,s="limits";else if("\\iiintilower"===t.substr(n,12))i="triple",r="italic",a=12,o=!0,s="limits";else if("\\iiintdlower"===t.substr(n,12))i="triple",r="roman",a=12,o=!0,s="limits";else if("\\iiintisub"===t.substr(n,10))i="triple",r="italic",a=10,o=!0,s="nolimits";else if("\\iiintdsub"===t.substr(n,10))i="triple",r="roman",a=10,o=!0,s="nolimits";else if("\\iintilower"===t.substr(n,11))i="double",r="italic",a=11,o=!0,s="limits";else if("\\iintdlower"===t.substr(n,11))i="double",r="roman",a=11,o=!0,s="limits";else if("\\iintisub"===t.substr(n,9))i="double",r="italic",a=9,o=!0,s="nolimits";else if("\\iintdsub"===t.substr(n,9))i="double",r="roman",a=9,o=!0,s="nolimits";else if("\\ointisub"===t.substr(n,9))i="contour",r="italic",a=9,o=!0,s="nolimits";else if("\\ointdsub"===t.substr(n,9))i="contour",r="roman",a=9,o=!0,s="nolimits";else if("\\iiintd"===t.substr(n,7))i="triple",r="roman",a=7;else if("\\iiinti"===t.substr(n,7))i="triple",r="italic",a=7;else if("\\iintd"===t.substr(n,6))i="double",r="roman",a=6;else if("\\iinti"===t.substr(n,6))i="double",r="italic",a=6;else if("\\ointd"===t.substr(n,6))i="contour",r="roman",a=6;else if("\\ointi"===t.substr(n,6))i="contour",r="italic",a=6;else if("\\intd"===t.substr(n,5))i="single",r="roman",a=5;else{if("\\inti"!==t.substr(n,5))return null;i="single",r="italic",a=5}for(n+=a;n<t.length&&" "===t[n];)n++;var c=[],l=[],u=[],d=[];if(o){if(n>=t.length||"{"!==t[n])return null;var p=this.parseLatexGroup(t,n);for(c=this.parseLatexToEquation(p.content),n=p.endIndex;n<t.length&&" "===t[n];)n++;if(n>=t.length||"{"!==t[n])return null;var h=this.parseLatexGroup(t,n);for(l=this.parseLatexToEquation(h.content),n=h.endIndex;n<t.length&&" "===t[n];)n++;var f=t.substr(e,a);if(f.includes("sub")||f.includes("lower")){if(n>=t.length||"{"!==t[n])return null;var m=this.parseLatexGroup(t,n);u=this.parseLatexToEquation(m.content),n=m.endIndex}else{if(n>=t.length||"{"!==t[n])return null;var v=this.parseLatexGroup(t,n);for(u=this.parseLatexToEquation(v.content),n=v.endIndex;n<t.length&&" "===t[n];)n++;if(n>=t.length||"{"!==t[n])return null;var y=this.parseLatexGroup(t,n);d=this.parseLatexToEquation(y.content),n=y.endIndex}}else{if(n>=t.length||"{"!==t[n])return null;var g=this.parseLatexGroup(t,n);for(c=this.parseLatexToEquation(g.content),n=g.endIndex;n<t.length&&" "===t[n];)n++;if(n>=t.length||"{"!==t[n])return null;var b=this.parseLatexGroup(t,n);l=this.parseLatexToEquation(b.content),n=b.endIndex}var x={id:this.generateElementId(),type:"integral",integralType:i,integralStyle:r,isDefinite:o,limitMode:s,integrand:c,differentialVariable:l,displayMode:"inline"};return o&&(t.substr(e).includes("isub")||t.substr(e).includes("dsub")||t.substr(e).includes("ilower")||t.substr(e).includes("dlower")?x.lowerLimit=u:(x.lowerLimit=u,x.upperLimit=d)),{element:x,endIndex:n}}},{key:"parseDvCommand",value:function(t,e,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=e,o=1;if(a<t.length&&"["===t[a]){for(var s=a+1,c=s,l=1;c<t.length&&l>0;)"["===t[c]?l++:"]"===t[c]&&l--,c++;var u=t.substring(s,c-1),p=parseInt(u);o=isNaN(p)?this.parseLatexToEquation(u):p,a=c}var h=this.parseLatexGroup(t,a);a=h.endIndex;for(var f=!1,m="",v=h.content;a<t.length&&" "===t[a];)a++;if(a<t.length&&"}"!==t[a])if("{"===t[a]){var y=this.parseLatexGroup(t,a);m=h.content,v=y.content,a=y.endIndex,f=!1}else{var g,b=null,x=S(d);try{for(x.s();!(g=x.n()).done;){var w=g.value;if("{"!==w.left&&"\\{"!==w.left&&t.substr(a,w.left.length)===w.left){b=w;break}}}catch(t){x.e(t)}finally{x.f()}if(b){var k=a;for(a+=b.left.length;a<t.length&&" "===t[a];)a++;if("\\grande"===t.substr(a,7)){a+=7;var L=this.parseLatexGroup(t,a);for(m=L.content,a=L.endIndex;a<t.length&&" "===t[a];)a++;t.substr(a,b.right.length)===b.right&&(a+=b.right.length),f=!0}else a=k}else if("\\grande"===t.substr(a,7)){a+=7;var C=this.parseLatexGroup(t,a);m=C.content,a=C.endIndex,f=!0}}return i&&a<t.length&&"}"===t[a]&&a++,m||!f?(r&&console.log("parseDvCommand debug:",{firstGroupContent:h.content,functionContent:m,variableContent:v,isLongForm:f,displayMode:n,order:o,finalFunction:m||v,finalVariable:f?v:v||""}),{element:{id:this.generateElementId(),type:"derivative",order:o,function:this.parseLatexToEquation(m||v),variable:this.parseLatexToEquation(f?v:v||""),displayMode:n,isLongForm:f,isPartial:r},endIndex:a}):null}},{key:"parseDerivativeFraction",value:function(t,e,n){var i=t.match(/^d(\^{(.+)})?(.*)$/),r=e.match(/^d\s*(.+?)(\^{(.+)})?$/);if(i&&r){var a=i[2],o=r[3],s=i[3]||"",c=r[1]||"";if((s=s.trim()).match(/^{\s*\w+\s*}(.*)$/)){var l=s.match(/^{\s*(\w+)\s*}(.*)$/);l&&(s=l[1]+l[2])}var u=1;if(a){var d=parseInt(a);u=isNaN(d)?this.parseLatexToEquation(a):d}else if(o){var p=parseInt(o);u=isNaN(p)?this.parseLatexToEquation(o):p}return{id:this.generateElementId(),type:"derivative",order:u,displayMode:n,function:this.parseLatexToEquation(s),variable:this.parseLatexToEquation(c.replace(/\^{.+}$/,""))}}return null}},{key:"parseLongFormDerivative",value:function(t,e,n,i){var r=t.match(/^d(\^{(.+)})?$/),a=e.match(/^d(.+?)(\^{(.+)})?$/);if(r&&a){var o=r[2],s=a[3],c=a[1]||"",l=1;if(o){var u=parseInt(o);l=isNaN(u)?this.parseLatexToEquation(o):u}else if(s){var d=parseInt(s);l=isNaN(d)?this.parseLatexToEquation(s):d}return{id:this.generateElementId(),type:"derivative",order:l,displayMode:i,function:this.parseLatexToEquation(n),variable:this.parseLatexToEquation(c.replace(/\^{.+}$/,"")),isLongForm:!0}}return null}},{key:"tryParseDerivativeCommand",value:function(t,e,n){var i,r=S(this.DERIVATIVE_COMMANDS);try{for(r.s();!(i=r.n()).done;){var a=i.value;if(t.substr(e,a.length)===a.command){var o=e+a.length,s=this.parseLatexGroup(t,o);o=s.endIndex;var c=this.parseLatexGroup(t,o);if(o=c.endIndex,a.isLongForm){var l=this.parseLatexGroup(t,o);o=l.endIndex;var u=this.parseLongFormDerivative(s.content,c.content,l.content,a.displayMode);u?n.push(u):n.push({id:this.generateElementId(),type:"fraction",displayMode:a.displayMode,numerator:this.parseLatexToEquation(s.content),denominator:this.parseLatexToEquation(c.content)})}else{var d=this.parseDerivativeFraction(s.content,c.content,a.displayMode);d?n.push(d):n.push({id:this.generateElementId(),type:"fraction",displayMode:a.displayMode,numerator:this.parseLatexToEquation(s.content),denominator:this.parseLatexToEquation(c.content)})}return this.lastDerivativeCommandEndIndex=o,!0}}}catch(t){r.e(t)}finally{r.f()}return!1}},{key:"tryParseStyleWrapper",value:function(t,e,n){for(var i=0,r=[{pattern:"{\\displaystyle ",length:14,mode:"display"},{pattern:"{\\displaystyle",length:13,mode:"display"},{pattern:"{\\textstyle ",length:12,mode:"inline"},{pattern:"{\\textstyle",length:11,mode:"inline"}];i<r.length;i++){var a=r[i];if(t.substr(e,a.length)===a.pattern){console.log("tryParseStyleWrapper found style:",a.mode,"at index:",e,"latex:",t.substr(e,30));for(var o=e,s=e+a.length,c=1,l=s;l<t.length&&c>0;)"{"===t[l]?c++:"}"===t[l]&&c--,l++;s=this.skipWhitespace(t,s);var u=!1;if("display"===a.mode&&"\\dv"===t.substr(s,3)){console.log("tryParseStyleWrapper found \\dv command"),s+=3;var d=this.parseDvCommand(t,s,"display",!0,!1);d&&(n.push(d.element),s=d.endIndex,u=!0)}else if("\\pdv"===t.substr(s,4)){console.log("tryParseStyleWrapper found \\pdv command, mode:",a.mode),s+=4;var p=this.parseDvCommand(t,s,a.mode,!0,!0);p&&(n.push(p.element),s=p.endIndex,u=!0)}else if(this.isCustomIntegralCommand(t,s)){var h=this.parseCustomIntegral(t,s);h&&(h.element.displayMode=a.mode,n.push(h.element),s=h.endIndex,u=!0)}else if(this.isLargeOperator(t,s)){var f=this.parseLargeOperator(t,s,"display"===a.mode);f&&(n.push(f.element),s=f.endIndex,u=!0)}else if("inline"===a.mode&&"\\frac"===t.substr(s,5)){var m=this.parseFraction(t,s,!0);m&&(n.push(m.element),s=m.endIndex,u=!0)}if(u)return s<t.length&&"}"===t[s]&&s++,this.lastStyleWrapperEndIndex=s,!0;console.log("tryParseStyleWrapper fallback for style:",a.mode);var v=this.parseLatexGroup(t,o),y=v.content;console.log("Fallback parsing content:",y);var g=a.pattern.substring(1),b=[];if(y.startsWith(g)){var x=y.substring(g.length);b=this.parseLatexToEquation(x)}else b=this.parseLatexToEquation(y);var w,k=S(b);try{for(k.s();!(w=k.n()).done;){var L=w.value;"derivative"!==L.type&&"integral"!==L.type||(L.displayMode=a.mode,console.log("Applied display mode",a.mode,"to",L.type,"element"))}}catch(t){k.e(t)}finally{k.f()}return n.push.apply(n,C(b)),this.lastStyleWrapperEndIndex=v.endIndex,!0}}return!1}},{key:"tryParseFormattingCommand",value:function(t,e,n){var i,r=this,a=S(this.FORMATTING_COMMANDS);try{var o,s=function(){var a=i.value;if(t.substr(e,a.length)===a.command){var o=e+a.length,s=r.parseLatexGroup(t,o);o=s.endIndex;var c=r.parseLatexToEquation(s.content);return c.forEach(function(t){"text"===t.type&&a.applyFormatting(t)}),n.push.apply(n,C(c)),r.lastFormattingCommandEndIndex=o,{v:!0}}};for(a.s();!(i=a.n()).done;)if(o=s())return o.v}catch(t){a.e(t)}finally{a.f()}return!1}},{key:"tryParseAccentCommand",value:function(t,e,n){for(var i=0,r=[{command:"\\hat",length:4,type:"hat",position:"over"},{command:"\\tilde",length:6,type:"tilde",position:"over"},{command:"\\bar",length:4,type:"bar",position:"over"},{command:"\\dot",length:4,type:"dot",position:"over"},{command:"\\ddot",length:5,type:"ddot",position:"over"},{command:"\\vec",length:4,type:"vec",position:"over"},{command:"\\widehat",length:8,type:"widehat",position:"over"},{command:"\\widetilde",length:10,type:"widetilde",position:"over"},{command:"\\overline",length:9,type:"widebar",position:"over"},{command:"\\overrightarrow",length:15,type:"overrightarrow",position:"over"},{command:"\\overleftarrow",length:14,type:"overleftarrow",position:"over"},{command:"\\overleftrightarrow",length:19,type:"overleftrightarrow",position:"over"},{command:"\\overbrace",length:10,type:"overbrace",position:"over"},{command:"\\underbrace",length:11,type:"underbrace",position:"under"},{command:"\\overparen",length:10,type:"overparen",position:"over"},{command:"\\underparen",length:11,type:"underparen",position:"under"}];i<r.length;i++){var a=r[i];if(t.substr(e,a.length)===a.command){var o=e+a.length,s=this.parseLatexGroup(t,o);o=s.endIndex;var c=this.parseLatexToEquation(s.content),l=[],u=a.type;if("overbrace"===a.type&&o<t.length&&"^"===t[o]){if(o+1<t.length&&"{"===t[o+1]){var d=this.parseLatexGroup(t,o+1);o=d.endIndex,l=this.parseLatexToEquation(d.content),u="labeledoverbrace"}}else if("underbrace"===a.type&&o<t.length&&"_"===t[o]&&o+1<t.length&&"{"===t[o+1]){var p=this.parseLatexGroup(t,o+1);o=p.endIndex,l=this.parseLatexToEquation(p.content),u="labeledunderbrace"}var h={id:this.generateElementId(),type:"accent",accentType:u,accentPosition:a.position,accentBase:c,accentLabel:l.length>0?l:u.includes("labeled")?[]:void 0};return n.push(h),this.lastAccentCommandEndIndex=o,!0}}return!1}},{key:"extractFromStyleWrapper",value:function(t,e){if("{\\displaystyle"===t.substr(e,14)||"{\\textstyle"===t.substr(e,11)){for(var n="{\\displaystyle"===t.substr(e,14),i=1,r=e+(n?14:11);r<t.length&&" "===t[r];)r++;for(var a=r,o=e+1;o<t.length;o++)if("{"===t[o])i++;else if("}"===t[o]&&0===--i){a=o;break}return{content:t.substring(r,a),endIndex:a+1,hasWrapper:!0,styleType:n?"display":"inline"}}var s=t.trim();return s.startsWith("\\displaystyle ")?{content:s.substring(14),endIndex:e+t.length,hasWrapper:!0,styleType:"display"}:s.startsWith("\\textstyle ")?{content:s.substring(11),endIndex:e+t.length,hasWrapper:!0,styleType:"inline"}:null}},{key:"applyStyleModeToElements",value:function(t,e){var n=this;t.forEach(function(t){"integral"!==t.type&&"large-operator"!==t.type&&"derivative"!==t.type&&"fraction"!==t.type||(t.displayMode=e),n.applyStyleModeToElementsRecursively(t,e)})}},{key:"applyStyleModeToElementsRecursively",value:function(t,e){var n=this;t.content&&this.applyStyleModeToElements(t.content,e),t.numerator&&this.applyStyleModeToElements(t.numerator,e),t.denominator&&this.applyStyleModeToElements(t.denominator,e),t.operand&&this.applyStyleModeToElements(t.operand,e),t.lowerLimit&&this.applyStyleModeToElements(t.lowerLimit,e),t.upperLimit&&this.applyStyleModeToElements(t.upperLimit,e),t.integrand&&this.applyStyleModeToElements(t.integrand,e),t.differentialVariable&&this.applyStyleModeToElements(t.differentialVariable,e),t.function&&this.applyStyleModeToElements(t.function,e),t.variable&&this.applyStyleModeToElements(t.variable,e),t.base&&this.applyStyleModeToElements(t.base,e),t.subscript&&this.applyStyleModeToElements(t.subscript,e),t.superscript&&this.applyStyleModeToElements(t.superscript,e),t.radicand&&this.applyStyleModeToElements(t.radicand,e),t.index&&this.applyStyleModeToElements(t.index,e),t.functionArgument&&this.applyStyleModeToElements(t.functionArgument,e),t.functionBase&&this.applyStyleModeToElements(t.functionBase,e),t.functionConstraint&&this.applyStyleModeToElements(t.functionConstraint,e),t.functionName&&this.applyStyleModeToElements(t.functionName,e),t.accentBase&&this.applyStyleModeToElements(t.accentBase,e),t.accentLabel&&this.applyStyleModeToElements(t.accentLabel,e),t.cells&&Object.values(t.cells).forEach(function(t){n.applyStyleModeToElements(t,e)})}},{key:"isBuiltinFunctionCommand",value:function(t,e){var n,i=S(o);try{for(i.s();!(n=i.n()).done;){var r=n.value;if(t.substr(e,r.length)===r){var a=t[e+r.length];if(!a||!/[a-zA-Z]/.test(a))return!0}}}catch(t){i.e(t)}finally{i.f()}return!1}},{key:"parseBuiltinFunctionCommand",value:function(t,e){var n,i=e,r="",a=S(o);try{for(a.s();!(n=a.n()).done;){var s=n.value;if(t.substr(i,s.length)===s){var c=t[i+s.length];if(!c||!/[a-zA-Z]/.test(c)){r=s.substring(1),i+=s.length;break}}}}catch(t){a.e(t)}finally{a.f()}if(!r)return null;for(;i<t.length&&" "===t[i];)i++;var l=!1,u=[];if(i<t.length&&"_"===t[i]){i++;var d=this.parseLatexGroup(t,i);d&&(i=d.endIndex,u=this.parseLatexToEquation(d.content),l=!0)}for(;i<t.length&&" "===t[i];)i++;var p=[];if(i<t.length){var h=i;if("{"===t[i]){var f=this.parseLatexGroup(t,i);f&&(p=this.parseLatexToEquation(f.content),h=f.endIndex)}else{if("\\"===t[i])for(h=i+1;h<t.length&&/[a-zA-Z]/.test(t[h]);)h++;else h=i+1;h>i&&(p=this.parseLatexToEquation(t.substring(i,h)))}i=h}return{element:l&&"log"===r?{id:this.generateElementId(),type:"function",functionType:"logn",functionArgument:p,functionBase:u}:l&&["max","min","lim"].includes(r)?{id:this.generateElementId(),type:"function",functionType:r,functionArgument:p,functionConstraint:u}:{id:this.generateElementId(),type:"function",functionType:r,functionArgument:p},endIndex:i}}},{key:"parseOperatorName",value:function(t,e){var n=e,i="\\operatorname*"===t.substr(n,14),r=i?14:13;if(t.substr(n,r)!==(i?"\\operatorname*":"\\operatorname"))return null;n+=r;var a=this.parseLatexGroup(t,n);if(!a)return null;n=a.endIndex;var o,s=this.parseLatexToEquation(a.content);s.forEach(function(t){"text"===t.type&&(t.italic=!1)});var c=!1;if(n<t.length&&"_"===t[n]){n++;var l=this.parseLatexGroup(t,n);l&&(n=l.endIndex,o=this.parseLatexToEquation(l.content),c=!0)}var u=[];if(i&&c){for(;n<t.length&&" "===t[n];)n++;if(n<t.length&&"{"===t[n]){var d=this.parseLatexGroup(t,n);d&&(n=d.endIndex,u=this.parseLatexToEquation(d.content))}else{for(var p=n;n<t.length&&" "!==t[n]&&"\\"!==t[n]&&"{"!==t[n]&&"}"!==t[n];)n++;n>p&&(u=this.parseLatexToEquation(t.substring(p,n)))}return{element:{id:this.generateElementId(),type:"function",functionType:"functionlim",functionName:s,functionConstraint:o,functionArgument:u},endIndex:n}}for(;n<t.length&&" "===t[n];)n++;if(n<t.length&&"{"===t[n]){var h=this.parseLatexGroup(t,n);h&&(n=h.endIndex,u=this.parseLatexToEquation(h.content))}else{for(var f=n;n<t.length&&" "!==t[n]&&"\\"!==t[n]&&"{"!==t[n]&&"}"!==t[n]&&"$"!==t[n];)n++;n>f&&(u=this.parseLatexToEquation(t.substring(f,n)))}var m=c?"functionsub":"function";return{element:{id:this.generateElementId(),type:"function",functionType:m,functionName:s,functionArgument:u,functionBase:c?o:void 0,functionConstraint:void 0},endIndex:n}}},{key:"parseMatrixStackCasesEnvironment",value:function(t,e){for(var n=this,i=null,r=null,a=null,o=e,s=0,c=[{pattern:"\\begin{pmatrix}",end:"\\end{pmatrix}",type:"matrix",subtype:"parentheses"},{pattern:"\\begin{bmatrix}",end:"\\end{bmatrix}",type:"matrix",subtype:"brackets"},{pattern:"\\begin{Bmatrix}",end:"\\end{Bmatrix}",type:"matrix",subtype:"braces"},{pattern:"\\begin{vmatrix}",end:"\\end{vmatrix}",type:"matrix",subtype:"bars"},{pattern:"\\begin{Vmatrix}",end:"\\end{Vmatrix}",type:"matrix",subtype:"double-bars"},{pattern:"\\begin{matrix}",end:"\\end{matrix}",type:"matrix",subtype:"none"},{pattern:"\\begin{array}",end:"\\end{array}",type:"stack",subtype:"plain"},{pattern:"\\begin{cases}",end:"\\end{cases}",type:"cases",subtype:"cases"}];s<c.length;s++){var l=c[s];if(t.substr(e,l.pattern.length)===l.pattern){i=l.type,r=l.subtype,a=l.end,o=e+l.pattern.length;break}}if(!i||!a)return null;if("stack"===i&&"{"===t.substr(o,1)){var u=t.indexOf("}",o);-1!==u&&(o=u+1)}var d=t.indexOf(a,o);if(-1===d)return null;var p=t.substring(o,d).trim().split("\\\\").map(function(t){return t.trim()}).filter(function(t){return t.length>0}),h={};p.forEach(function(t,e){t.split("&").map(function(t){return t.trim()}).forEach(function(t,i){var r="cell_".concat(e,"_").concat(i);h[r]=n.parseLatexToEquation(t)})});var f=p.length,m=p.length>0?p[0].split("&").length:1;return{element:"matrix"===i?{id:this.generateElementId(),type:"matrix",matrixType:r,rows:f,cols:m,cells:h}:"stack"===i?{id:this.generateElementId(),type:"stack",stackType:"plain",rows:f,cols:m,cells:h}:{id:this.generateElementId(),type:"cases",casesType:"cases",rows:f,cols:m,cells:h},endIndex:d+a.length}}}],e&&B(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function D(t){return D="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},D(t)}function q(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,i)}return n}function R(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?q(Object(n),!0).forEach(function(e){H(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):q(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function F(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,j(i.key),i)}}function H(t,e,n){return(e=j(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function j(t){var e=function(t){if("object"!=D(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=D(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==D(e)?e:e+""}var N=function(){return t=function t(e,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),H(this,"activeContextPath",null),H(this,"cursorPosition",0),H(this,"selection",{startPosition:0,endPosition:0,contextPath:"",isActive:!1}),this.equationBuilder=e,this.latexConverter=n},e=[{key:"getActiveContextPath",value:function(){return this.activeContextPath}},{key:"setActiveContextPath",value:function(t){this.activeContextPath=t}},{key:"getCursorPosition",value:function(){return this.cursorPosition}},{key:"setCursorPosition",value:function(t){this.cursorPosition=t}},{key:"isActive",value:function(){return null!==this.activeContextPath}},{key:"exitEditingMode",value:function(){this.activeContextPath=null}},{key:"enterRootContext",value:function(){this.activeContextPath="root",this.cursorPosition=this.equationBuilder.getEquation().length}},{key:"enterContextPath",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.activeContextPath=t,this.cursorPosition=e}},{key:"getContext",value:function(t){if("root"===t)return{array:this.equationBuilder.getEquation(),parent:null};var e=t.split("/"),n=e.pop(),i=e.pop(),r=this.equationBuilder.findElementById(this.equationBuilder.getEquation(),i);if(!r)return null;if("derivative"===r.type)return"function"===n?{array:r.function||[],parent:r}:"variable"===n?{array:r.variable||[],parent:r}:"order"===n&&Array.isArray(r.order)?{array:r.order,parent:r}:null;if("integral"===r.type)return"integrand"===n?{array:r.integrand||[],parent:r}:"differentialVariable"===n?{array:r.differentialVariable||[],parent:r}:"lowerLimit"===n?{array:r.lowerLimit||[],parent:r}:"upperLimit"===n?{array:r.upperLimit||[],parent:r}:null;if("matrix"===r.type||"stack"===r.type||"cases"===r.type){if(n.match(/^cell_(\d+)_(\d+)$/)&&r.cells){var a=n;if(r.cells[a])return{array:r.cells[a],parent:r}}return null}if("accent"===r.type)return"accentBase"===n?{array:r.accentBase||[],parent:r}:"accentLabel"===n?{array:r.accentLabel||[],parent:r}:null;if("function"===r.type)return"functionArgument"===n?{array:r.functionArgument||[],parent:r}:"functionBase"===n?{array:r.functionBase||[],parent:r}:"functionConstraint"===n?{array:r.functionConstraint||[],parent:r}:"functionName"===n?{array:r.functionName||[],parent:r}:null;var o=r[n];return o?{array:o,parent:r}:null}},{key:"getCurrentContext",value:function(){return this.activeContextPath?this.getContext(this.activeContextPath):null}},{key:"moveCursor",value:function(t){if(!this.activeContextPath)return!1;var e=this.getContext(this.activeContextPath);if(!e)return!1;var n=this.cursorPosition+t;return n>=0&&n<=e.array.length?(this.cursorPosition=n,!0):"root"!==this.activeContextPath&&(this.navigateMatrixHorizontal(t)||this.navigateOutOfContext(1===t?"forward":"backward"),!0)}},{key:"navigateTab",value:function(){if(this.activeContextPath&&"root"!==this.activeContextPath){var t=this.activeContextPath.split("/"),e=t.pop(),n=t[t.length-1],i=t.slice(0,-1).join("/"),r=this.getContext(this.activeContextPath);if(r&&r.parent){var a=m(r.parent),o=a.indexOf(e);if(-1!==o){var s=(o+1)%a.length;this.activeContextPath="".concat(i,"/").concat(n,"/").concat(a[s]),this.cursorPosition=0}else this.navigateOutOfContext("forward")}}}},{key:"exitStructure",value:function(t){this.navigateOutOfContext(t)}},{key:"enterAdjacentStructure",value:function(t){if(this.activeContextPath&&"root"===this.activeContextPath){var e=this.getContext(this.activeContextPath);if(e){var n="left"===t?this.cursorPosition-1:this.cursorPosition;if(!(n<0||n>=e.array.length)){var i=e.array[n];if(i.type in f){var r=m(i);if(0===r.length)return;var a=r["right"===t?0:r.length-1];this.activeContextPath="root/".concat(i.id,"/").concat(a),this.cursorPosition=0}}}}}},{key:"navigateUpDown",value:function(t){var e="ArrowUp"===t?"ArrowUp":"ArrowDown";if(this.activeContextPath&&"root"!==this.activeContextPath){var n=this.activeContextPath.split("/"),i=n.pop(),r=n[n.length-1],a=n.slice(0,-1).join("/"),o=this.getContext(this.activeContextPath);if(o&&o.parent){var s=o.parent;if("fraction"===s.type)"ArrowDown"===e&&"numerator"===i?(this.activeContextPath="".concat(a,"/").concat(r,"/denominator"),this.cursorPosition=0):"ArrowUp"===e&&"denominator"===i?(this.activeContextPath="".concat(a,"/").concat(r,"/numerator"),this.cursorPosition=0):this.navigateOutOfContext("ArrowDown"===e?"forward":"backward");else if("integral"===s.type)"ArrowDown"===e?"isDefinite"in s&&s.isDefinite&&"upperLimit"===i?(this.activeContextPath="".concat(a,"/").concat(r,"/lowerLimit"),this.cursorPosition=0):"isDefinite"in s&&s.isDefinite&&"lowerLimit"===i?(this.activeContextPath="".concat(a,"/").concat(r,"/integrand"),this.cursorPosition=0):"integrand"===i?(this.activeContextPath="".concat(a,"/").concat(r,"/differentialVariable"),this.cursorPosition=0):this.navigateOutOfContext("forward"):"ArrowUp"===e?"differentialVariable"===i?(this.activeContextPath="".concat(a,"/").concat(r,"/integrand"),this.cursorPosition=0):"integrand"===i&&"isDefinite"in s&&s.isDefinite?(this.activeContextPath="".concat(a,"/").concat(r,"/lowerLimit"),this.cursorPosition=0):"isDefinite"in s&&s.isDefinite&&"lowerLimit"===i?(this.activeContextPath="".concat(a,"/").concat(r,"/upperLimit"),this.cursorPosition=0):this.navigateOutOfContext("backward"):this.navigateOutOfContext("ArrowDown"===e?"forward":"backward");else if("derivative"===s.type)"ArrowDown"===e?"function"===i?(this.activeContextPath="".concat(a,"/").concat(r,"/variable"),this.cursorPosition=0):"order"===i?(this.activeContextPath="".concat(a,"/").concat(r,"/function"),this.cursorPosition=0):this.navigateOutOfContext("forward"):"ArrowUp"===e?"variable"===i?(this.activeContextPath="".concat(a,"/").concat(r,"/function"),this.cursorPosition=0):"function"===i&&Array.isArray(s.order)?(this.activeContextPath="".concat(a,"/").concat(r,"/order"),this.cursorPosition=0):this.navigateOutOfContext("backward"):this.navigateOutOfContext("ArrowDown"===e?"forward":"backward");else if("script"===s.type)"ArrowDown"===e?"base"===i&&s.superscript?(this.activeContextPath="".concat(a,"/").concat(r,"/superscript"),this.cursorPosition=0):"superscript"===i&&s.subscript?(this.activeContextPath="".concat(a,"/").concat(r,"/subscript"),this.cursorPosition=0):this.navigateOutOfContext("forward"):"ArrowUp"===e&&("subscript"===i&&s.superscript?(this.activeContextPath="".concat(a,"/").concat(r,"/superscript"),this.cursorPosition=0):"superscript"===i&&s.base?(this.activeContextPath="".concat(a,"/").concat(r,"/base"),this.cursorPosition=s.base.length):this.navigateOutOfContext("backward"));else if("large-operator"===s.type)"ArrowDown"===e?"lowerLimit"===i&&s.upperLimit?(this.activeContextPath="".concat(a,"/").concat(r,"/upperLimit"),this.cursorPosition=0):"upperLimit"===i&&s.operand?(this.activeContextPath="".concat(a,"/").concat(r,"/operand"),this.cursorPosition=0):this.navigateOutOfContext("forward"):"ArrowUp"===e&&("operand"===i&&s.upperLimit?(this.activeContextPath="".concat(a,"/").concat(r,"/upperLimit"),this.cursorPosition=0):"upperLimit"===i&&s.lowerLimit?(this.activeContextPath="".concat(a,"/").concat(r,"/lowerLimit"),this.cursorPosition=s.lowerLimit.length):this.navigateOutOfContext("backward"));else if("matrix"===s.type||"stack"===s.type||"cases"===s.type){var c=i.match(/^cell_(\d+)_(\d+)$/);if(c&&s.rows&&s.cols){var l=parseInt(c[1]),u=parseInt(c[2]);"ArrowDown"===e?l<s.rows-1?(this.activeContextPath="".concat(a,"/").concat(r,"/cell_").concat(l+1,"_").concat(u),this.cursorPosition=0):this.navigateOutOfContext("forward"):"ArrowUp"===e&&(l>0?(this.activeContextPath="".concat(a,"/").concat(r,"/cell_").concat(l-1,"_").concat(u),this.cursorPosition=0):this.navigateOutOfContext("backward"))}}else if("function"===s.type){var d=["function","functionsub","functionlim"].includes(s.functionType||"");"ArrowDown"===e?d&&"functionName"===i?s.functionConstraint?(this.activeContextPath="".concat(a,"/").concat(r,"/functionConstraint"),this.cursorPosition=0):s.functionBase?(this.activeContextPath="".concat(a,"/").concat(r,"/functionBase"),this.cursorPosition=0):(this.activeContextPath="".concat(a,"/").concat(r,"/functionArgument"),this.cursorPosition=0):"functionConstraint"===i&&s.functionBase?(this.activeContextPath="".concat(a,"/").concat(r,"/functionBase"),this.cursorPosition=0):"functionConstraint"===i&&!s.functionBase||"functionBase"===i?(this.activeContextPath="".concat(a,"/").concat(r,"/functionArgument"),this.cursorPosition=0):this.navigateOutOfContext("forward"):"ArrowUp"===e&&("functionArgument"===i&&s.functionBase?(this.activeContextPath="".concat(a,"/").concat(r,"/functionBase"),this.cursorPosition=0):"functionArgument"===i&&!s.functionBase&&s.functionConstraint?(this.activeContextPath="".concat(a,"/").concat(r,"/functionConstraint"),this.cursorPosition=0):"functionArgument"!==i||s.functionBase||s.functionConstraint||!d?"functionBase"===i&&s.functionConstraint?(this.activeContextPath="".concat(a,"/").concat(r,"/functionConstraint"),this.cursorPosition=0):"functionBase"===i&&!s.functionConstraint&&d||"functionConstraint"===i&&d?(this.activeContextPath="".concat(a,"/").concat(r,"/functionName"),this.cursorPosition=0):this.navigateOutOfContext("backward"):(this.activeContextPath="".concat(a,"/").concat(r,"/functionName"),this.cursorPosition=0))}else this.navigateOutOfContext("ArrowDown"===e?"forward":"backward")}}}},{key:"navigateMatrixHorizontal",value:function(t){if(!this.activeContextPath||"root"===this.activeContextPath)return!1;var e=this.activeContextPath.split("/"),n=e.pop(),i=e[e.length-1],r=e.slice(0,-1).join("/"),a=this.getContext(this.activeContextPath);if(!a||!a.parent||"matrix"!==a.parent.type&&"stack"!==a.parent.type&&"cases"!==a.parent.type)return!1;var o=n.match(/^cell_(\d+)_(\d+)$/);if(!o||!a.parent.rows||!a.parent.cols)return!1;var s=parseInt(o[1]),c=parseInt(o[2]);if(1===t){if(c<a.parent.cols-1)return this.activeContextPath="".concat(r,"/").concat(i,"/cell_").concat(s,"_").concat(c+1),this.cursorPosition=0,!0}else if(-1===t&&c>0)return this.activeContextPath="".concat(r,"/").concat(i,"/cell_").concat(s,"_").concat(c-1),this.cursorPosition=0,!0;return!1}},{key:"navigateOutOfContext",value:function(t){if(this.activeContextPath&&"root"!==this.activeContextPath){var e=this.activeContextPath.split("/");e.pop();var n=e.pop(),i=e.join("/"),r=this.getContext(i);if(r&&n){var a=r.array.findIndex(function(t){return t.id===n});-1!==a&&(this.activeContextPath=i,this.cursorPosition="forward"===t?a+1:a)}}}},{key:"handleBackspace",value:function(){if(!this.activeContextPath)return!1;var t=this.getContext(this.activeContextPath);return!!t&&(this.cursorPosition>0?(this.equationBuilder.removeElement(t.array,this.cursorPosition-1),this.cursorPosition--,!0):"root"!==this.activeContextPath&&(this.navigateOutOfContext("backward"),!0))}},{key:"handleDelete",value:function(){if(!this.activeContextPath)return!1;var t=this.getContext(this.activeContextPath);return!!t&&this.cursorPosition<t.array.length&&(this.equationBuilder.removeElement(t.array,this.cursorPosition),!0)}},{key:"insertTextAtCursor",value:function(t){if(!this.activeContextPath)return!1;var e=this.getContext(this.activeContextPath);if(!e)return!1;try{var n;if(this.activeContextPath.includes("function")&&"derivative"===(null===(n=e.parent)||void 0===n?void 0:n.type)){var i=this.getContextText(e.array);if(h(i.slice(0,this.cursorPosition)+t+i.slice(this.cursorPosition)))return this.showMixedBracketsError(),!1}var r=this.equationBuilder.createTextElement(t);return this.equationBuilder.insertElement(r,e.array,this.cursorPosition),this.cursorPosition++,!0}catch(t){return!1}}},{key:"getContextText",value:function(t){return t.map(function(t){return t.value||""}).join("")}},{key:"showMixedBracketsError",value:function(){var t=document.createElement("div");t.textContent="Mixed brackets are not supported for derivatives.",t.style.cssText="\n      position: fixed;\n      top: 20px;\n      left: 50%;\n      transform: translateX(-50%);\n      background: #f44336;\n      color: white;\n      padding: 12px 16px;\n      border-radius: 4px;\n      z-index: 10000;\n      font-size: 14px;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.3);\n      font-family: Arial, sans-serif;\n    ",document.body.appendChild(t),setTimeout(function(){t.parentNode&&t.parentNode.removeChild(t)},3e3)}},{key:"insertElementAtCursor",value:function(t){if(!this.activeContextPath)return!1;var e=this.getContext(this.activeContextPath);return!!e&&(this.equationBuilder.insertElement(t,e.array,this.cursorPosition),this.cursorPosition++,!0)}},{key:"getSelection",value:function(){return R({},this.selection)}},{key:"setSelection",value:function(t,e,n){var i=n||this.activeContextPath||"root";this.selection={startPosition:Math.min(t,e),endPosition:Math.max(t,e),contextPath:i,isActive:!0}}},{key:"clearSelection",value:function(){this.selection.isActive=!1}},{key:"hasSelection",value:function(){return this.selection.isActive&&this.selection.startPosition!==this.selection.endPosition}},{key:"selectStructureAtCursor",value:function(){if(!this.activeContextPath)return!1;var t=this.getContext(this.activeContextPath);if(!t)return!1;if(this.cursorPosition>0&&this.cursorPosition<=t.array.length){var e=t.array[this.cursorPosition-1];if(e&&"text"!==e.type)return this.setSelection(this.cursorPosition-1,this.cursorPosition),!0}return!1}},{key:"selectCurrentContext",value:function(){if(!this.activeContextPath)return!1;var t=this.getContext(this.activeContextPath);return!!t&&(this.setSelection(0,t.array.length),!0)}},{key:"selectParentStructure",value:function(){if(!this.activeContextPath||"root"===this.activeContextPath)return!1;var t=this.activeContextPath.split("/");t.pop();var e=t.pop(),n=t.join("/"),i=this.getContext(n);if(!i||!e)return!1;var r=i.array.findIndex(function(t){return t.id===e});return-1!==r&&(this.activeContextPath=n,this.setSelection(r,r+1),this.cursorPosition=r+1,!0)}},{key:"extendSelectionToStructure",value:function(t){if(this.activeContextPath){var e=this.getContext(this.activeContextPath);if(e)if(this.selection.isActive){var n=this.cursorPosition;if(t>0&&this.cursorPosition<e.array.length){var i=e.array[this.cursorPosition];n=i&&"text"!==i.type?this.cursorPosition+1:this.cursorPosition+t}else if(t<0&&this.cursorPosition>0){var r=Math.max(0,this.cursorPosition+t),a=e.array[r];n=a&&"text"!==a.type?r:this.cursorPosition+t}if(this.cursorPosition===this.selection.endPosition?this.selection.endPosition=Math.max(0,Math.min(e.array.length,n)):this.cursorPosition===this.selection.startPosition&&(this.selection.startPosition=Math.max(0,Math.min(e.array.length,n))),this.cursorPosition=n,this.selection.startPosition>this.selection.endPosition){var o=this.selection.startPosition;this.selection.startPosition=this.selection.endPosition,this.selection.endPosition=o}this.selection.startPosition===this.selection.endPosition&&this.clearSelection()}else if(t>0&&this.cursorPosition<e.array.length){var s=e.array[this.cursorPosition];s&&"text"!==s.type?(this.setSelection(this.cursorPosition,this.cursorPosition+1),this.cursorPosition=this.cursorPosition+1):this.extendSelection(t)}else if(t<0&&this.cursorPosition>0){var c=e.array[this.cursorPosition-1];c&&"text"!==c.type?(this.setSelection(this.cursorPosition-1,this.cursorPosition),this.cursorPosition=this.cursorPosition-1):this.extendSelection(t)}}}},{key:"extendSelection",value:function(t){if(this.selection.isActive){if(this.cursorPosition===this.selection.endPosition?(this.selection.endPosition=Math.max(0,this.selection.endPosition+t),this.cursorPosition=this.selection.endPosition):this.cursorPosition===this.selection.startPosition?(this.selection.startPosition=Math.max(0,this.selection.startPosition+t),this.cursorPosition=this.selection.startPosition):t>0?(this.selection.endPosition=Math.max(0,this.cursorPosition+t),this.cursorPosition=this.selection.endPosition):(this.selection.startPosition=Math.max(0,this.cursorPosition+t),this.cursorPosition=this.selection.startPosition),this.selection.startPosition>this.selection.endPosition){var e=this.selection.startPosition;this.selection.startPosition=this.selection.endPosition,this.selection.endPosition=e}this.selection.startPosition===this.selection.endPosition&&this.clearSelection()}else{var n=this.cursorPosition,i=this.cursorPosition+t;this.setSelection(n,i),this.cursorPosition=i}}},{key:"deleteSelection",value:function(){if(!this.hasSelection()||!this.activeContextPath)return!1;var t=this.getContext(this.activeContextPath);if(!t)return!1;var e=this.selection.endPosition-this.selection.startPosition;return t.array.splice(this.selection.startPosition,e),this.cursorPosition=this.selection.startPosition,this.clearSelection(),!0}},{key:"extractSelection",value:function(){if(!this.hasSelection()||!this.activeContextPath)return[];var t=this.getContext(this.activeContextPath);if(!t)return[];var e=t.array.splice(this.selection.startPosition,this.selection.endPosition-this.selection.startPosition);return this.cursorPosition=this.selection.startPosition,this.clearSelection(),e}},{key:"getSelectionFormatting",value:function(){if(!this.hasSelection()||!this.activeContextPath)return null;var t=this.getContext(this.activeContextPath);if(!t)return null;for(var e={bold:{true:0,false:0},italic:{true:0,false:0},underline:{},cancel:{true:0,false:0},color:{}},n=0,i=this.selection.startPosition;i<this.selection.endPosition;i++)if(i<t.array.length){var r=t.array[i];if("text"===r.type){var a,o,s;n++;var c=r.bold||!1;e.bold[c]++;var l=r.italic||!1;e.italic[l]++;var u="none";null!==(a=r.wrappers)&&void 0!==a&&a.underline?u=r.wrappers.underline.type:r.underline&&(u=r.underline),e.underline[u]=(e.underline[u]||0)+1;var d=!1;null!==(o=r.wrappers)&&void 0!==o&&o.cancel?d=!0:r.cancel&&(d=r.cancel),e.cancel[d]++;var p="default";null!==(s=r.wrappers)&&void 0!==s&&s.color?p=r.wrappers.color.value:r.color&&(p=r.color),e.color[p]=(e.color[p]||0)+1}}if(0===n)return null;var h={};e.bold.true===n?h.bold=!0:e.bold.false===n&&(h.bold=!1),e.italic.true===n?h.italic=!0:e.italic.false===n&&(h.italic=!1);var f=Object.keys(e.underline);1===f.length&&e.underline[f[0]]===n&&(h.underline=f[0]),e.cancel.true===n?h.cancel=!0:e.cancel.false===n&&(h.cancel=!1);var m=Object.keys(e.color);return 1===m.length&&e.color[m[0]]===n&&(h.color="default"===m[0]?void 0:m[0]),h}},{key:"removeWrapperFormattingFromSelection",value:function(t){if(!this.hasSelection()||!this.activeContextPath)return!1;var e=this.selection.contextPath||this.activeContextPath,n=this.getContext(e);if(!n)return!1;for(var i=this.selection.startPosition;i<this.selection.endPosition;i++)if(i<n.array.length){var r=n.array[i];r.wrappers&&(delete r.wrappers[t],r.wrapperOrder&&(r.wrapperOrder=r.wrapperOrder.filter(function(e){return e!==t})),0===Object.keys(r.wrappers).length&&(delete r.wrappers,delete r.wrapperOrder))}return this.clearSelection(),!0}},{key:"applyWrapperFormattingToSelection",value:function(t){if(!this.hasSelection()||!this.activeContextPath)return!1;var e=this.selection.contextPath||this.activeContextPath,n=this.getContext(e);if(!n)return!1;for(var i={cancel:this.equationBuilder.generateElementId(),underline:this.equationBuilder.generateElementId(),color:this.equationBuilder.generateElementId(),textMode:this.equationBuilder.generateElementId()},r=this.selection.startPosition;r<this.selection.endPosition;r++)if(r<n.array.length){var a=n.array[r];a.wrappers||(a.wrappers={}),void 0!==t.cancel&&(t.cancel?(a.wrappers.cancel={id:i.cancel},a.wrapperOrder&&a.wrapperOrder.includes("cancel")||(a.wrapperOrder=a.wrapperOrder||[],a.wrapperOrder.push("cancel"))):(delete a.wrappers.cancel,a.wrapperOrder&&(a.wrapperOrder=a.wrapperOrder.filter(function(t){return"cancel"!==t})))),void 0!==t.underline&&(t.underline?a.wrappers.underline?a.wrappers.underline={id:i.underline,type:t.underline}:(a.wrappers.underline={id:i.underline,type:t.underline},a.wrapperOrder=a.wrapperOrder||[],a.wrapperOrder.push("underline")):(delete a.wrappers.underline,a.wrapperOrder&&(a.wrapperOrder=a.wrapperOrder.filter(function(t){return"underline"!==t})))),void 0!==t.color&&(t.color?(a.wrappers.color={id:i.color,value:t.color},a.wrapperOrder&&a.wrapperOrder.includes("color")||(a.wrapperOrder=a.wrapperOrder||[],a.wrapperOrder.push("color"))):(delete a.wrappers.color,a.wrapperOrder&&(a.wrapperOrder=a.wrapperOrder.filter(function(t){return"color"!==t})))),void 0!==t.textMode&&(t.textMode?(a.wrappers.textMode={id:i.textMode},a.wrapperOrder&&a.wrapperOrder.includes("textMode")||(a.wrapperOrder=a.wrapperOrder||[],a.wrapperOrder.push("textMode"))):(delete a.wrappers.textMode,a.wrapperOrder&&(a.wrapperOrder=a.wrapperOrder.filter(function(t){return"textMode"!==t})))),0===Object.keys(a.wrappers).length&&(delete a.wrappers,delete a.wrapperOrder)}return this.clearSelection(),!0}},{key:"applyFormattingToSelection",value:function(t){if(!this.hasSelection()||!this.activeContextPath)return!1;var e=this.selection.contextPath||this.activeContextPath,n=this.getContext(e);if(!n)return!1;for(var i=0,r=this.selection.startPosition;r<this.selection.endPosition;r++)if(r<n.array.length){var a=n.array[r];if("text"===a.type){if(/[+\-×÷=<>≤≥≠]/.test(a.value||"")&&void 0!==t.bold){var o=R({},t);delete o.bold,this.applyFormattingToElement(a,o)}else this.applyFormattingToElement(a,t);i++}else if("matrix"===a.type){if(void 0!==t.bold||void 0!==t.italic){var s={bold:t.bold,italic:t.italic};this.applyFormattingToStructureContents(a,s),i++}var c=R({},t);delete c.bold,delete c.italic,Object.keys(c).length>0&&(this.applyFormattingToElement(a,c),i++)}else{void 0!==t.underline&&(this.applyStructureUnderline(a,t.underline),i++);var l=R({},t);delete l.underline,Object.keys(l).length>0&&(this.applyFormattingToStructureContents(a,l),i++)}}return i>0}},{key:"applyFormattingToElement",value:function(t,e){Object.keys(e).forEach(function(n){void 0!==e[n]&&(t[n]=e[n])})}},{key:"isSelectionBold",value:function(){if(!this.hasSelection()||!this.activeContextPath)return!1;var t=this.getContext(this.activeContextPath);if(!t)return!1;for(var e=!1,n=this.selection.startPosition;n<this.selection.endPosition;n++)if(n<t.array.length){var i=t.array[n];if("text"===i.type&&(e=!0,!i.bold))return!1}return e}},{key:"isSelectionItalic",value:function(){if(!this.hasSelection()||!this.activeContextPath)return!1;var t=this.getContext(this.activeContextPath);if(!t)return!1;for(var e=!1,n=this.selection.startPosition;n<this.selection.endPosition;n++)if(n<t.array.length){var i=t.array[n];if("text"===i.type){if(e=!0,!0===i.italic)continue;if(void 0===i.italic&&/^[a-zA-Z]$/.test(i.value||""))continue;return!1}}return e}},{key:"isSelectionCancel",value:function(){if(!this.hasSelection()||!this.activeContextPath)return!1;var t=this.getContext(this.activeContextPath);if(!t)return!1;for(var e=!1,n=this.selection.startPosition;n<this.selection.endPosition;n++)if(n<t.array.length){var i;if(e=!0,null!==(i=t.array[n].wrappers)&&void 0!==i&&i.cancel)continue;return!1}return e}},{key:"isSelectionUnderlined",value:function(){if(!this.hasSelection()||!this.activeContextPath)return!1;var t=this.getContext(this.activeContextPath);if(!t)return!1;for(var e,n=!1,i=this.selection.startPosition;i<this.selection.endPosition;i++)if(i<t.array.length){var r,a=t.array[i];n=!0;var o;if(null===(r=a.wrappers)||void 0===r||!r.underline)return!1;if(o=a.wrappers.underline.type,e){if(e!==o)return!1}else e=o}return!(!n||!e)&&e}},{key:"getElementContextPath",value:function(t,e){return"root"===this.activeContextPath?"root/".concat(t,"/").concat(e):"".concat(this.activeContextPath,"/").concat(t,"/").concat(e)}},{key:"applyStructureUnderline",value:function(t,e){void 0!==e&&(t.underline=e)}},{key:"applyFormattingToStructureContents",value:function(t,e){var n=this,i=function(t){t&&t.forEach(function(t){if("text"===t.type)if(/[+\-×÷=<>≤≥≠]/.test(t.value||"")&&void 0!==e.bold){var i=R({},e);delete i.bold,n.applyFormattingToElement(t,i)}else n.applyFormattingToElement(t,e);else n.applyFormattingToStructureContents(t,e)})};i(t.numerator),i(t.denominator),i(t.radicand),i(t.index),i(t.base),i(t.superscript),i(t.subscript),i(t.content),i(t.upperLimit),i(t.lowerLimit),i(t.operand),i(t.function),i(t.variable),Array.isArray(t.order)&&i(t.order),i(t.integrand),i(t.differentialVariable),i(t.functionArgument),i(t.functionBase),i(t.functionConstraint),i(t.functionName),t.cells&&"object"===D(t.cells)&&Object.keys(t.cells).forEach(function(e){e.startsWith("cell_")&&i(t.cells[e])})}}],e&&F(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function W(t){return W="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},W(t)}function G(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var i,r,a,o,s=[],c=!0,l=!1;try{if(a=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;c=!1}else for(;!(c=(i=a.call(n)).done)&&(s.push(i.value),s.length!==e);c=!0);}catch(t){l=!0,r=t}finally{try{if(!c&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(l)throw r}}return s}}(t,e)||function(t,e){if(t){if("string"==typeof t)return z(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?z(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function z(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=Array(e);n<e;n++)i[n]=t[n];return i}function _(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,V(i.key),i)}}function U(t,e,n){return(e=V(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function V(t){var e=function(t){if("object"!=W(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=W(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==W(e)?e:e+""}var $=function(){return e=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),U(this,"scaleRatios",new Map),U(this,"currentFontKey","")},(n=[{key:"operators",get:function(){return Object.entries(s).filter(function(t){var e=G(t,2),n=(e[0],e[1]);return n.isLargeOperator&&n.needsInlineScaling}).map(function(t){var e=G(t,2),n=(e[0],e[1]);return{symbol:n.unicode,name:n.dataAttribute}})}},{key:"measureAndSetScaleRatios",value:function(){var t=this;return new Promise(function(e){var n=t.getCurrentFontKey();if(t.scaleRatios.has(n)){var i=t.scaleRatios.get(n);return t.applyScaleRatios(i),void e(i)}var r=new Map,a=0,o=function(){if(a>=t.operators.length)return t.scaleRatios.set(n,r),t.applyScaleRatios(r),void e(r);var i=t.operators[a],s=t.createMeasurementElements(i.symbol),c=s.nolimitsElement,l=s.displaylimitsElement,u=s.container;requestAnimationFrame(function(){try{var e=t.getOperatorSize(c),n=t.getOperatorSize(l),s=e.height/n.height;r.set(i.name,s),u.remove(),a++,o()}catch(t){r.set(i.name,.6),u.remove(),a++,o()}})};o()})}},{key:"createMeasurementElements",value:function(t){var e=document.createElement("div");e.style.position="absolute",e.style.left="-9999px",e.style.top="-9999px",e.style.visibility="hidden",e.style.pointerEvents="none";var n=document.createElement("div");n.className="visual-equation-container",n.innerHTML='\n      <math>\n        <mrow>\n          <msubsup>\n            <mo class="test-nolimits-operator">'.concat(t,"</mo>\n            <mrow><mi>□</mi></mrow>\n            <mrow><mi>□</mi></mrow>\n          </msubsup>\n        </mrow>\n      </math>\n    ");var i=document.createElement("div");return i.className="visual-equation-container",i.innerHTML='\n      <math>\n        <mrow displaystyle="true">\n          <munderover>\n            <mo class="test-displaystyle-operator">'.concat(t,"</mo>\n            <mrow><mi>□</mi></mrow>\n            <mrow><mi>□</mi></mrow>\n          </munderover>\n        </mrow>\n      </math>\n    "),e.appendChild(n),e.appendChild(i),document.body.appendChild(e),{nolimitsElement:n,displaylimitsElement:i,container:e}}},{key:"getOperatorSize",value:function(t){var e=t.querySelector("mo");if(!e)throw new Error("Operator element not found");var n=e.getBoundingClientRect();return{width:n.width,height:n.height}}},{key:"getCurrentFontKey",value:function(){var t=window.getComputedStyle(document.body),e=t.getPropertyValue("font-family"),n=t.getPropertyValue("font-size");return"".concat(e,"-").concat(n)}},{key:"applyScaleRatios",value:function(t){t.forEach(function(t,e){document.documentElement.style.setProperty("--inline-limits-scale-".concat(e),t.toString())}),this.ensureScaleCSSRules()}},{key:"ensureScaleCSSRules",value:function(){var e="inline-limits-dynamic-scale",n=document.getElementById(e);if(!n){(n=document.createElement("style")).id=e;var i=Object.entries(s).filter(function(e){var n=t(e,2),i=(n[0],n[1]);return i.isLargeOperator&&i.needsInlineScaling}).map(function(e){var n=t(e,2);return n[0],n[1].dataAttribute}).filter(Boolean).map(function(t){return'\n        .equation-display mrow[displaystyle="true"] .inline-limits[data-operator="'.concat(t,'"] > mo,\n        .visual-equation-container mrow[displaystyle="true"] .inline-limits[data-operator="').concat(t,'"] > mo {\n          transform: scale(var(--inline-limits-scale-').concat(t,", 0.6)) !important;\n        }")}).join("\n");n.textContent="\n        /* Dynamic scaling for inline-limits operators */\n        ".concat(i,"\n      "),document.head.appendChild(n)}}},{key:"invalidateCache",value:function(){this.scaleRatios.clear()}}])&&_(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,n}();function K(t){return K="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},K(t)}function J(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,Z(i.key),i)}}function X(t,e,n){return(e=Z(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function Z(t){var e=function(t){if("object"!=K(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=K(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==K(e)?e:e+""}var Q=function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),X(this,"globalFontSize",12),X(this,"inputHandler",null),this.contextManager=e},e=[{key:"setInputHandler",value:function(t){this.inputHandler=t}},{key:"setGlobalFontSize",value:function(t){this.globalFontSize=t}},{key:"getGlobalFontSize",value:function(){return this.globalFontSize}},{key:"renderEquation",value:function(t){return null===this.contextManager.getActiveContextPath()&&0===t.length?'<span class="empty-state">Click here and start typing your equation</span>':this.generateMathML(t,"root")}},{key:"updateDisplay",value:function(t,e){var n=this,i=this.contextManager.getActiveContextPath();if(null===i&&0===e.length)return t.innerHTML='<span class="empty-state">Click here and start typing your equation</span>',void t.classList.remove("active");t.classList.toggle("active",null!==i);var r=this.generateMathML(e,"root"),a='\n      <div class="visual-equation-container" style="font-size: '.concat(1.5*this.globalFontSize,'px; position: relative;">\n        ').concat(r,'\n        <div class="wrapper-overlays" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;"></div>\n      </div>\n    ');t.innerHTML=a,requestAnimationFrame(function(){n.createWrapperOverlays(t,e)})}},{key:"generateMathML",value:function(t,e){var n=this,i=this.contextManager.getActiveContextPath(),r=this.contextManager.getCursorPosition(),a=this.contextManager.getSelection(),o=i===e?"active-context":"",s=o?' class="'.concat(o,'"'):"",c='<math><mrow data-context-path="'.concat(e,'"').concat(s,">");return 0===t.length&&e===i&&(c+='<mspace class="cursor" data-context-path="'+e+'" data-position="0" />'),t.forEach(function(t,o){e===i&&o===r&&(c+='<mspace class="cursor" data-context-path="'+e+'" data-position="'+o+'" />');var s="root"===e?"root/".concat(t.id):"".concat(e,"/").concat(t.id),l=a.isActive&&a.contextPath===e&&o>=a.startPosition&&o<a.endPosition;c+=n.elementToMathML(t,s,o,l)}),e===i&&t.length===r&&(c+='<mspace class="cursor" data-context-path="'+e+'" data-position="'+t.length+'" />'),c+="</mrow></math>"}},{key:"elementToMathML",value:function(t,e,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=this.contextManager.getActiveContextPath()===e;switch(t.type){case"text":return this.textToMathML(t,r,e,n,i);case"fraction":return this.fractionToMathML(t,e,r,n,i);case"bevelled-fraction":return this.bevelledFractionToMathML(t,e,r,n,i);case"sqrt":return this.sqrtToMathML(t,e,r,n,i);case"nthroot":return this.nthRootToMathML(t,e,r,n,i);case"script":return this.scriptToMathML(t,e,r,n,i);case"bracket":return this.bracketToMathML(t,e,r,n,i);case"large-operator":return this.largeOperatorToMathML(t,e,r,n,i);case"derivative":return this.derivativeToMathML(t,e,r,n,i);case"integral":return this.integralToMathML(t,e,r,n,i);case"matrix":return this.matrixToMathML(t,e,r,n,i);case"stack":return this.stackToMathML(t,e,r,n,i);case"cases":return this.casesToMathML(t,e,r,n,i);case"accent":return this.accentToMathML(t,e,r,n,i);case"function":return this.functionToMathML(t,e,r,n,i);default:return""}}},{key:"textToMathML",value:function(t,e,n,i){var r,o=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=t.value||"&#x25A1;",c=!0===t.textMode||t.wrappers&&t.wrappers.textMode;"\\,"===s&&(s="&#8201;"),c&&" "===s&&(s="&#160;");var l=/[+\-−×÷=<>≤≥≠±∓·∗⋆∘•∼≃≈≡≅≇∝≮≯≰≱≺≻⪯⪰≪≫∩∪∖∈∋∉⊂⊃⊆⊇⊈⊉⊊⊋⊕⊖⊗⊘⊙◁▷≀∧∨⊢⊨⊤⊥⋈⋄≍≜∴∵]/.test(s),u=/[a-zA-Z]/.test(s),d=/[0-9]/.test(s),p=(/[^\w\s]/.test(s),"mi");c?p="mtext":l?p="mo":d&&(p="mn");var h="";t.color&&(h+="color: ".concat(t.color,";")),null!==(r=t.wrappers)&&void 0!==r&&null!==(r=r.color)&&void 0!==r&&r.value&&(h+="color: ".concat(t.wrappers.color.value,";")),t.bold&&(h+="font-weight: bold;"),o&&(h+="background-color: #0078d4; color: white; border-radius: 2px; padding: 1px 2px;"),h&&'style="'.concat(h,'"');var f="";if("mi"===p){var m=!1,v=a.includes(s);!0===t.italic?m=!0:!1===t.italic||v?m=!1:!u||t.bold||!1===t.italic||c||(m=!0),m||(f='mathvariant="normal"')}else"mtext"===p?f='mathvariant="normal"':!0===t.italic?h+="font-style: italic;":!1===t.italic?h+="font-style: normal;":!u||t.bold||!1===t.italic||c||(h+="font-style: italic;");var y=[];e&&y.push("active-element"),o&&y.push("selected"),this.contextManager.getActiveContextPath()===n&&y.push("active-context");var g=y.length>0?'class="'.concat(y.join(" "),'"'):"",b='data-context-path="'.concat(n,'" data-position="').concat(i,'" data-element-id="').concat(t.id,'"'),x=h?'style="'.concat(h,'"'):"";return"<".concat(p," ").concat(x," ").concat(f," ").concat(g," ").concat(b,">").concat(s,"</").concat(p,">")}},{key:"buildStructureStyle",value:function(t,e){var n,i="";return t.color&&(i+="color: ".concat(t.color,";")),null!==(n=t.wrappers)&&void 0!==n&&null!==(n=n.color)&&void 0!==n&&n.value&&(i+="color: ".concat(t.wrappers.color.value,";")),t.bold&&(i+="font-weight: bold;"),e&&(i+="background-color: #0078d4; color: white; border-radius: 3px; padding: 2px;"),i?'style="'.concat(i,'"'):""}},{key:"fractionToMathML",value:function(t,e,n,i){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=this.generateMathMLContent("".concat(e,"/numerator"),t.numerator),o=this.generateMathMLContent("".concat(e,"/denominator"),t.denominator),s=[];n&&s.push("active-element"),r&&s.push("selected-structure"),"display"===t.displayMode&&s.push("display-fraction");var c=s.length>0?'class="'.concat(s.join(" "),'"'):"",l=this.buildStructureStyle(t,r),u='data-context-path="'.concat(e,'" data-position="').concat(i,'" data-element-id="').concat(t.id,'"'),d="display"===t.displayMode?'displaystyle="true"':"";return"<mfrac ".concat(d," ").concat(c," ").concat(l," ").concat(u,'>\n      <mrow data-context-path="').concat(e,'/numerator">').concat(a,'</mrow>\n      <mrow data-context-path="').concat(e,'/denominator">').concat(o,"</mrow>\n    </mfrac>")}},{key:"bevelledFractionToMathML",value:function(t,e,n,i){var r=this.generateMathMLContent("".concat(e,"/numerator"),t.numerator),a=this.generateMathMLContent("".concat(e,"/denominator"),t.denominator),o=n?'class="active-element"':"",s='data-context-path="'.concat(e,'" data-position="').concat(i,'"');return"<mrow ".concat(o," ").concat(s,'>\n      <mrow data-context-path="').concat(e,'/numerator">').concat(r,'</mrow>\n      <mo>/</mo>\n      <mrow data-context-path="').concat(e,'/denominator">').concat(a,"</mrow>\n    </mrow>")}},{key:"sqrtToMathML",value:function(t,e,n,i){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=this.generateMathMLContent("".concat(e,"/radicand"),t.radicand),o=[];n&&o.push("active-element"),r&&o.push("selected-structure");var s=o.length>0?'class="'.concat(o.join(" "),'"'):"",c=this.buildStructureStyle(t,r),l='data-context-path="'.concat(e,'" data-position="').concat(i,'" data-element-id="').concat(t.id,'"');return"<msqrt ".concat(s," ").concat(c," ").concat(l,'>\n      <mrow data-context-path="').concat(e,'/radicand">').concat(a,"</mrow>\n    </msqrt>")}},{key:"nthRootToMathML",value:function(t,e,n,i){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=this.generateMathMLContent("".concat(e,"/index"),t.index),o=this.generateMathMLContent("".concat(e,"/radicand"),t.radicand),s=[];n&&s.push("active-element"),r&&s.push("selected-structure");var c=s.length>0?'class="'.concat(s.join(" "),'"'):"",l=this.buildStructureStyle(t,r),u='data-context-path="'.concat(e,'" data-position="').concat(i,'" data-element-id="').concat(t.id,'"');return"<mroot ".concat(c," ").concat(l," ").concat(u,'>\n      <mrow data-context-path="').concat(e,'/radicand">').concat(o,'</mrow>\n      <mrow data-context-path="').concat(e,'/index">').concat(a,"</mrow>\n    </mroot>")}},{key:"scriptToMathML",value:function(t,e,n,i){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=this.generateMathMLContent("".concat(e,"/base"),t.base),o=[];n&&o.push("active-element"),r&&o.push("selected-structure");var s=o.length>0?'class="'.concat(o.join(" "),'"'):"",c=this.buildStructureStyle(t,r),l='data-context-path="'.concat(e,'" data-position="').concat(i,'" data-element-id="').concat(t.id,'"');if(t.superscript&&t.subscript){var u=this.generateMathMLContent("".concat(e,"/superscript"),t.superscript),d=this.generateMathMLContent("".concat(e,"/subscript"),t.subscript);return"<msubsup ".concat(s," ").concat(c," ").concat(l,'>\n        <mrow data-context-path="').concat(e,'/base">').concat(a,'</mrow>\n        <mrow data-context-path="').concat(e,'/subscript">').concat(d,'</mrow>\n        <mrow data-context-path="').concat(e,'/superscript">').concat(u,"</mrow>\n      </msubsup>")}if(t.superscript){var p=this.generateMathMLContent("".concat(e,"/superscript"),t.superscript);return"<msup ".concat(s," ").concat(c," ").concat(l,'>\n        <mrow data-context-path="').concat(e,'/base">').concat(a,'</mrow>\n        <mrow data-context-path="').concat(e,'/superscript">').concat(p,"</mrow>\n      </msup>")}if(t.subscript){var h=this.generateMathMLContent("".concat(e,"/subscript"),t.subscript);return"<msub ".concat(s," ").concat(c," ").concat(l,'>\n        <mrow data-context-path="').concat(e,'/base">').concat(a,'</mrow>\n        <mrow data-context-path="').concat(e,'/subscript">').concat(h,"</mrow>\n      </msub>")}return'<mrow data-context-path="'.concat(e,'">').concat(a,"</mrow>")}},{key:"bracketToMathML",value:function(t,e,n,i){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=this.generateMathMLContent("".concat(e,"/content"),t.content),o=t.leftBracketSymbol?'<mo stretchy="true" symmetric="true">'.concat(t.leftBracketSymbol,"</mo>"):"",s=t.rightBracketSymbol?'<mo stretchy="true" symmetric="true">'.concat(t.rightBracketSymbol,"</mo>"):"",c=[];n&&c.push("active-element"),r&&c.push("selected-structure");var l=c.length>0?'class="'.concat(c.join(" "),'"'):"",u='data-context-path="'.concat(e,'" data-position="').concat(i,'"'),d="<mrow ".concat(l," ").concat(u,">\n      ").concat(o,'\n      <mrow data-context-path="').concat(e,'/content">').concat(a,"</mrow>\n      ").concat(s,"\n    </mrow>");if(t.superscript&&t.subscript){var p=this.generateMathMLContent("".concat(e,"/superscript"),t.superscript),h=this.generateMathMLContent("".concat(e,"/subscript"),t.subscript);return"<msubsup ".concat(l," ").concat(u,">\n        ").concat(d,'\n        <mrow data-context-path="').concat(e,'/subscript">').concat(h,'</mrow>\n        <mrow data-context-path="').concat(e,'/superscript">').concat(p,"</mrow>\n      </msubsup>")}if(t.superscript){var f=this.generateMathMLContent("".concat(e,"/superscript"),t.superscript);return"<msup ".concat(l," ").concat(u,">\n        ").concat(d,'\n        <mrow data-context-path="').concat(e,'/superscript">').concat(f,"</mrow>\n      </msup>")}if(t.subscript){var m=this.generateMathMLContent("".concat(e,"/subscript"),t.subscript);return"<msub ".concat(l," ").concat(u,">\n        ").concat(d,'\n        <mrow data-context-path="').concat(e,'/subscript">').concat(m,"</mrow>\n      </msub>")}return d}},{key:"largeOperatorToMathML",value:function(t,e,n,i){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=t.operator||"&#x2211;",o=this.generateMathMLContent("".concat(e,"/operand"),t.operand),s=[];n&&s.push("active-element"),r&&s.push("selected-structure");var c=s.length>0?'class="'.concat(s.join(" "),'"'):"",l=this.buildStructureStyle(t,r),u='data-context-path="'.concat(e,'" data-position="').concat(i,'" data-element-id="').concat(t.id,'"'),d=!0===t.isIndefiniteIntegral,p="display"===t.displayMode||"limits"===t.limitMode?'displaystyle="true"':"",h=this.getOperatorDataAttribute(a),f="";if(d)f="<mo ".concat(c," ").concat(u,">").concat(a,"</mo>");else if("limits"===t.limitMode){var m=this.generateMathMLContent("".concat(e,"/upperLimit"),t.upperLimit),v=this.generateMathMLContent("".concat(e,"/lowerLimit"),t.lowerLimit),y=["display"===t.displayMode?"display-limits":"inline-limits"];r&&y.push("selected-structure"),f='<munderover class="'.concat(y.join(" "),'" ').concat(h," ").concat(u,">\n        <mo>").concat(a,'</mo>\n        <mrow data-context-path="').concat(e,'/lowerLimit">').concat(v,'</mrow>\n        <mrow data-context-path="').concat(e,'/upperLimit">').concat(m,"</mrow>\n      </munderover>")}else{var g=this.generateMathMLContent("".concat(e,"/upperLimit"),t.upperLimit),b=this.generateMathMLContent("".concat(e,"/lowerLimit"),t.lowerLimit);f="<msubsup ".concat(c," ").concat(u,">\n        <mo>").concat(a,'</mo>\n        <mrow data-context-path="').concat(e,'/lowerLimit">').concat(b,'</mrow>\n        <mrow data-context-path="').concat(e,'/upperLimit">').concat(g,"</mrow>\n      </msubsup>")}var x=[];r&&x.push("selected-structure");var w=x.length>0?' class="'.concat(x.join(" "),'"'):"";return"<mrow ".concat(p," ").concat(h).concat(w," ").concat(l,' data-element-id="').concat(t.id,'">\n      ').concat(f,'\n      <mrow data-context-path="').concat(e,'/operand">').concat(o,"</mrow>\n    </mrow>")}},{key:"getOperatorDataAttribute",value:function(t){var e=l[t],n=e?e.substring(1):"unknown";return'data-operator="'.concat(n,'"')}},{key:"derivativeToMathML",value:function(t,e,n,i){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=[];n&&a.push("active-element"),r&&a.push("selected-structure");var o=a.length>0?'class="'.concat(a.join(" "),'"'):"",s='data-context-path="'.concat(e,'" data-position="').concat(i,'" data-element-id="').concat(t.id,'"'),c="display"===t.displayMode?'displaystyle="true"':"",l=this.getDifferentialStylePreference()||t.isPartial?"":'mathvariant="normal"',u=t.isPartial?"∂":"d";if(t.isLongForm)return this.derivativeLongFormToMathML(t,e,n,i,r,c,l,u);var d=this.generateMathMLContent("".concat(e,"/function"),t.function),p=this.generateMathMLContent("".concat(e,"/variable"),t.variable),h="",f="";if("number"==typeof t.order)1===t.order?(h="<mi ".concat(l,">").concat(u,"</mi>").concat(d),f="<mi ".concat(l,">").concat(u,"</mi>").concat(p)):(h="<msup>\n          <mi ".concat(l,">").concat(u,"</mi>\n          <mn>").concat(t.order,"</mn>\n        </msup>").concat(d),f="<mi ".concat(l,">").concat(u,"</mi><msup>\n          ").concat(p,"\n          <mn>").concat(t.order,"</mn>\n        </msup>"));else{var m=this.generateMathMLContent("".concat(e,"/order"),t.order);h="<msup>\n        <mi ".concat(l,">").concat(u,'</mi>\n        <mrow data-context-path="').concat(e,'/order">').concat(m,"</mrow>\n      </msup>").concat(d);var v=t.order&&t.order.length>0?t.order.map(function(t){return t.value||""}).join(""):"";f="<mi ".concat(l,">").concat(u,"</mi><msup>\n        ").concat(p,"\n        <mi>").concat(v||"&#x25A1;","</mi>\n      </msup>")}return"<mfrac ".concat(c," ").concat(o," ").concat(s,'>\n      <mrow data-context-path="').concat(e,'/function">').concat(h,'</mrow>\n      <mrow data-context-path="').concat(e,'/variable">').concat(f,"</mrow>\n    </mfrac>")}},{key:"getDifferentialStylePreference",value:function(){return!this.inputHandler||"function"!=typeof this.inputHandler.getDifferentialStyleForLatex||!this.inputHandler.getDifferentialStyleForLatex()}},{key:"derivativeLongFormToMathML",value:function(t,e,n,i,r,a,o){var s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:"d",c=[];n&&c.push("active-element"),r&&c.push("selected-structure");var l=c.length>0?'class="'.concat(c.join(" "),'"'):"",u='data-context-path="'.concat(e,'" data-position="').concat(i,'" data-element-id="').concat(t.id,'"'),d=this.generateMathMLContent("".concat(e,"/function"),t.function),p=this.generateMathMLContent("".concat(e,"/variable"),t.variable),h="";if("number"==typeof t.order)h=1===t.order?"<mfrac ".concat(a,">\n          <mi ").concat(o,">").concat(s,'</mi>\n          <mrow data-context-path="').concat(e,'/variable">\n            <mi ').concat(o,">").concat(s,"</mi>\n            ").concat(p,"\n          </mrow>\n        </mfrac>"):"<mfrac ".concat(a,">\n          <msup>\n            <mi ").concat(o,">").concat(s,"</mi>\n            <mn>").concat(t.order,'</mn>\n          </msup>\n          <mrow data-context-path="').concat(e,'/variable">\n            <mi ').concat(o,">").concat(s,"</mi>\n            <msup>\n              ").concat(p,"\n              <mn>").concat(t.order,"</mn>\n            </msup>\n          </mrow>\n        </mfrac>");else{var f=this.generateMathMLContent("".concat(e,"/order"),t.order),m=t.order&&t.order.length>0?t.order.map(function(t){return t.value||""}).join(""):"";h="<mfrac ".concat(a,">\n        <msup>\n          <mi ").concat(o,">").concat(s,'</mi>\n          <mrow data-context-path="').concat(e,'/order">').concat(f,'</mrow>\n        </msup>\n        <mrow data-context-path="').concat(e,'/variable">\n          <mi ').concat(o,">").concat(s,"</mi>\n          <msup>\n            ").concat(p,"\n            <mi>").concat(m||"&#x25A1;","</mi>\n          </msup>\n        </mrow>\n      </mfrac>")}return"<mrow ".concat(l," ").concat(u,">\n      ").concat(h,'\n      <mrow data-context-path="').concat(e,'/function">').concat(d,"</mrow>\n    </mrow>")}},{key:"integralToMathML",value:function(t,e,n,i){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=[];n&&a.push("active-element"),r&&a.push("selected-structure");var o=a.length>0?'class="'.concat(a.join(" "),'"'):"",s='data-context-path="'.concat(e,'" data-position="').concat(i,'" data-element-id="').concat(t.id,'"'),c="display"===t.displayMode?'displaystyle="true"':"",l=function(t){switch(t){case"single":default:return"∫";case"double":return"∬";case"triple":return"∭";case"contour":return"∮"}}(t.integralType||"single"),u="italic"===t.integralStyle?"":'mathvariant="normal"',d=this.generateMathMLContent("".concat(e,"/integrand"),t.integrand),p=this.generateMathMLContent("".concat(e,"/differentialVariable"),t.differentialVariable),h="";if(t.isDefinite){var f=void 0!==t.upperLimit,m=void 0!==t.lowerLimit,v=f?this.generateMathMLContent("".concat(e,"/upperLimit"),t.upperLimit):"",y=m?this.generateMathMLContent("".concat(e,"/lowerLimit"),t.lowerLimit):"",g="limits"===t.limitMode||"default"===t.limitMode&&"display"===t.displayMode;h=f&&m?g?"<munderover>\n            <mo>".concat(l,'</mo>\n            <mrow data-context-path="').concat(e,'/lowerLimit">').concat(y,'</mrow>\n            <mrow data-context-path="').concat(e,'/upperLimit">').concat(v,"</mrow>\n          </munderover>"):"<msubsup>\n            <mo>".concat(l,'</mo>\n            <mrow data-context-path="').concat(e,'/lowerLimit">').concat(y,'</mrow>\n            <mrow data-context-path="').concat(e,'/upperLimit">').concat(v,"</mrow>\n          </msubsup>"):m?g?"<munder>\n            <mo>".concat(l,'</mo>\n            <mrow data-context-path="').concat(e,'/lowerLimit">').concat(y,"</mrow>\n          </munder>"):"<msub>\n            <mo>".concat(l,'</mo>\n            <mrow data-context-path="').concat(e,'/lowerLimit">').concat(y,"</mrow>\n          </msub>"):f?g?"<mover>\n            <mo>".concat(l,'</mo>\n            <mrow data-context-path="').concat(e,'/upperLimit">').concat(v,"</mrow>\n          </mover>"):"<msup>\n            <mo>".concat(l,'</mo>\n            <mrow data-context-path="').concat(e,'/upperLimit">').concat(v,"</mrow>\n          </msup>"):"<mo>".concat(l,"</mo>")}else h="<mo>".concat(l,"</mo>");return"<mrow ".concat(c," ").concat(o," ").concat(s,">\n      ").concat(h,'\n      <mrow data-context-path="').concat(e,'/integrand">').concat(d,'</mrow>\n      <mspace width="0.2em"/>\n      <mi ').concat(u,'>d</mi>\n      <mrow data-context-path="').concat(e,'/differentialVariable">').concat(p,"</mrow>\n    </mrow>")}},{key:"matrixToMathML",value:function(t,e,n,i){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=t.rows,o=t.cols,s=t.cells,c=t.matrixType;if(!a||!o||!s)return"<mtext>Invalid Matrix</mtext>";for(var l="<mtable>",u=0;u<a;u++){l+="<mtr>";for(var d=0;d<o;d++){var p="".concat(e,"/cell_").concat(u,"_").concat(d),h=s["cell_".concat(u,"_").concat(d)]||[],f=this.generateMathMLContent(p,h);l+="<mtd>".concat(f,"</mtd>")}l+="</mtr>"}return l+="</mtable>",this.wrapMatrixWithBrackets(l,c||"parentheses",e,i,r,t)}},{key:"stackToMathML",value:function(t,e,n,i){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=t.rows,o=t.cols,s=t.cells;if(!a||!o||!s)return"<mtext>Invalid Stack</mtext>";for(var c="<mtable>",l=0;l<a;l++){c+="<mtr>";for(var u=0;u<o;u++){var d="".concat(e,"/cell_").concat(l,"_").concat(u),p=s["cell_".concat(l,"_").concat(u)]||[],h=this.generateMathMLContent(d,p);c+="<mtd>".concat(h,"</mtd>")}c+="</mtr>"}c+="</mtable>";var f=[];r&&f.push("selected-structure");var m=f.length>0?'class="'.concat(f.join(" "),'"'):"",v='data-context-path="'.concat(e,'" data-position="').concat(i,'" data-element-id="').concat(t.id,'"');return"<mrow ".concat(m," ").concat(v,">").concat(c,"</mrow>")}},{key:"casesToMathML",value:function(t,e,n,i){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=t.rows,o=t.cols,s=t.cells;if(!a||!o||!s)return"<mtext>Invalid Cases</mtext>";for(var c="<mtable>",l=0;l<a;l++){c+="<mtr>";for(var u=0;u<o;u++){var d="".concat(e,"/cell_").concat(l,"_").concat(u),p=s["cell_".concat(l,"_").concat(u)]||[],h=this.generateMathMLContent(d,p);c+="<mtd>".concat(h,"</mtd>")}c+="</mtr>"}return c+="</mtable>",this.wrapCasesWithBrace(c,e,i,r,t)}},{key:"wrapCasesWithBrace",value:function(t,e,n,i,r){var a=[];i&&a.push("selected-structure");var o=a.length>0?'class="'.concat(a.join(" "),'"'):"",s=this.buildStructureStyle(r,i),c='data-context-path="'.concat(e,'" data-position="').concat(n,'" data-element-id="').concat(r.id,'"');return"<mrow ".concat(o," ").concat(s," ").concat(c,'>\n      <mo stretchy="true">{</mo>\n      ').concat(t,"\n    </mrow>")}},{key:"wrapMatrixWithBrackets",value:function(t,e,n,i,r,a){var o=[];r&&o.push("selected-structure");var s=o.length>0?'class="'.concat(o.join(" "),'"'):"",c=this.buildStructureStyle(a,r),l='data-context-path="'.concat(n,'" data-position="').concat(i,'" data-element-id="').concat(a.id,'"');switch(e){case"parentheses":return"<mrow ".concat(s," ").concat(c," ").concat(l,'>\n          <mo stretchy="true">(</mo>\n          ').concat(t,'\n          <mo stretchy="true">)</mo>\n        </mrow>');case"brackets":return"<mrow ".concat(s," ").concat(c," ").concat(l,'>\n          <mo stretchy="true">[</mo>\n          ').concat(t,'\n          <mo stretchy="true">]</mo>\n        </mrow>');case"braces":return"<mrow ".concat(s," ").concat(c," ").concat(l,'>\n          <mo stretchy="true">{</mo>\n          ').concat(t,'\n          <mo stretchy="true">}</mo>\n        </mrow>');case"bars":return"<mrow ".concat(s," ").concat(c," ").concat(l,'>\n          <mo stretchy="true">|</mo>\n          ').concat(t,'\n          <mo stretchy="true">|</mo>\n        </mrow>');case"double-bars":return"<mrow ".concat(s," ").concat(c," ").concat(l,'>\n          <mo stretchy="true">∥</mo>\n          ').concat(t,'\n          <mo stretchy="true">∥</mo>\n        </mrow>');default:return"<mrow ".concat(s," ").concat(c," ").concat(l,">").concat(t,"</mrow>")}}},{key:"accentToMathML",value:function(t,e,n,i){var r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a="".concat(e,"/").concat(t.id,"/accentBase"),o=this.generateMathMLContent(a,t.accentBase),s=[];r&&s.push("selected-structure");var c,l=s.length>0?'class="'.concat(s.join(" "),'"'):"",u=this.buildStructureStyle(t,r),d='data-context-path="'.concat(e,'" data-position="').concat(i,'" data-element-id="').concat(t.id,'"'),p=this.getAccentSymbol(t.accentType||"hat"),h=this.isStretchyAccent(t.accentType||"hat"),f=h?' stretchy="true"':"";if(c=h?"<mrow ".concat('style="background-color: #f0f0f0; border-radius: 2px; padding: 1px 2px; display: inline-block;"',' data-context-path="').concat(a,'">').concat(o,"</mrow>"):'<mrow data-context-path="'.concat(a,'">').concat(o,"</mrow>"),"under"===t.accentPosition){if("underbrace"===t.accentType&&t.accentLabel&&t.accentLabel.length>0||"labeledunderbrace"===t.accentType){var m="".concat(e,"/").concat(t.id,"/accentLabel"),v=this.generateMathMLContent(m,t.accentLabel);return"<munder ".concat(l," ").concat(u," ").concat(d,">\n          <munder>\n            ").concat(c,"\n            <mo").concat(f,">").concat(p,"</mo>\n          </munder>\n          ").concat(v,"\n        </munder>")}return"<munder ".concat(l," ").concat(u," ").concat(d,">\n          ").concat(c,"\n          <mo").concat(f,">").concat(p,"</mo>\n        </munder>")}if("overbrace"===t.accentType&&t.accentLabel&&t.accentLabel.length>0||"labeledoverbrace"===t.accentType){var y="".concat(e,"/").concat(t.id,"/accentLabel"),g=this.generateMathMLContent(y,t.accentLabel);return"<mover ".concat(l," ").concat(u," ").concat(d,">\n          <mover>\n            ").concat(c,"\n            <mo").concat(f,">").concat(p,"</mo>\n          </mover>\n          ").concat(g,"\n        </mover>")}return"<mover ".concat(l," ").concat(u," ").concat(d,">\n          ").concat(c,"\n          <mo").concat(f,">").concat(p,"</mo>\n        </mover>")}},{key:"getAccentSymbol",value:function(t){switch(t){case"hat":case"widehat":default:return"^";case"tilde":return"~";case"bar":case"widebar":return"‾";case"dot":return"·";case"ddot":return"¨";case"vec":return"→";case"widetilde":return"∼";case"overrightarrow":return"⟶";case"overleftarrow":return"⟵";case"overleftrightarrow":return"⟷";case"overbrace":case"labeledoverbrace":return"⏞";case"underbrace":case"labeledunderbrace":return"⏟";case"overparen":return"⏜";case"underparen":return"⏝"}}},{key:"isStretchyAccent",value:function(t){switch(t){case"widehat":case"widetilde":case"widebar":case"overrightarrow":case"overleftarrow":case"overleftrightarrow":case"overbrace":case"underbrace":case"labeledoverbrace":case"labeledunderbrace":case"overparen":case"underparen":return!0;default:return!1}}},{key:"createWrapperOverlays",value:function(t,e){var n=this,i=t.querySelector(".wrapper-overlays");if(i){i.innerHTML="";var r=new Map,a=new Map;this.findElementsWithWrappers(e,function(t,e){if(t.wrappers){if(t.wrappers.underline){var n=t.wrappers.underline.id;r.has(n)||r.set(n,{elements:[],type:t.wrappers.underline.type}),r.get(n).elements.push(e)}if(t.wrappers.cancel){var i=t.wrappers.cancel.id;a.has(i)||a.set(i,[]),a.get(i).push(e)}}}),r.forEach(function(t,e){n.createGroupedUnderlineOverlay(i,t.elements,t.type)}),a.forEach(function(t,e){n.createGroupedCancelOverlay(i,t)})}}},{key:"findElementsWithWrappers",value:function(t,e){var n=this;t.forEach(function(t){if(t.wrappers&&Object.keys(t.wrappers).length>0){var i=document.querySelector('[data-element-id="'.concat(t.id,'"]'));i&&e(t,i)}t.numerator&&n.findElementsWithWrappers(t.numerator,e),t.denominator&&n.findElementsWithWrappers(t.denominator,e),t.base&&n.findElementsWithWrappers(t.base,e),t.superscript&&n.findElementsWithWrappers(t.superscript,e),t.subscript&&n.findElementsWithWrappers(t.subscript,e),t.radicand&&n.findElementsWithWrappers(t.radicand,e),t.index&&n.findElementsWithWrappers(t.index,e),t.content&&n.findElementsWithWrappers(t.content,e),t.function&&n.findElementsWithWrappers(t.function,e),t.variable&&n.findElementsWithWrappers(t.variable,e),t.integrand&&n.findElementsWithWrappers(t.integrand,e),t.differentialVariable&&n.findElementsWithWrappers(t.differentialVariable,e),t.operand&&n.findElementsWithWrappers(t.operand,e),t.upperLimit&&n.findElementsWithWrappers(t.upperLimit,e),t.lowerLimit&&n.findElementsWithWrappers(t.lowerLimit,e),t.accentBase&&n.findElementsWithWrappers(t.accentBase,e),t.accentLabel&&n.findElementsWithWrappers(t.accentLabel,e),t.cells&&Object.values(t.cells).forEach(function(t){n.findElementsWithWrappers(t,e)})})}},{key:"createGroupedUnderlineOverlay",value:function(t,e,n){if(0!==e.length){var i=t.getBoundingClientRect(),r=1/0,a=-1/0,o=-1/0;e.forEach(function(t){var e=t.getBoundingClientRect();r=Math.min(r,e.left),a=Math.max(a,e.right),o=Math.max(o,e.bottom)});var s=r-i.left,c=a-r,l=o-i.top+1;if("double"===n){var u=document.createElement("div");u.style.cssText="\n        position: absolute;\n        left: ".concat(s,"px;\n        top: ").concat(l,"px;\n        width: ").concat(c,"px;\n        height: 1px;\n        background-color: currentColor;\n        pointer-events: none;\n      ");var d=document.createElement("div");d.style.cssText="\n        position: absolute;\n        left: ".concat(s,"px;\n        top: ").concat(l+3,"px;\n        width: ").concat(c,"px;\n        height: 1px;\n        background-color: currentColor;\n        pointer-events: none;\n      "),t.appendChild(u),t.appendChild(d)}else{var p=document.createElement("div");p.style.cssText="\n        position: absolute;\n        left: ".concat(s,"px;\n        top: ").concat(l,"px;\n        width: ").concat(c,"px;\n        height: 1px;\n        background-color: currentColor;\n        pointer-events: none;\n      "),t.appendChild(p)}}}},{key:"createGroupedCancelOverlay",value:function(t,e){if(0!==e.length){var n=t.getBoundingClientRect(),i=1/0,r=-1/0,a=1/0,o=-1/0;e.forEach(function(t){var e=t.getBoundingClientRect();i=Math.min(i,e.left),r=Math.max(r,e.right),a=Math.min(a,e.top),o=Math.max(o,e.bottom)});var s=i-n.left,c=a-n.top,l=r-i,u=o-a,d=document.createElementNS("http://www.w3.org/2000/svg","svg");d.style.cssText="\n      position: absolute;\n      left: ".concat(s,"px;\n      top: ").concat(c,"px;\n      width: ").concat(l,"px;\n      height: ").concat(u,"px;\n      pointer-events: none;\n      overflow: visible;\n    ");var p=document.createElementNS("http://www.w3.org/2000/svg","line");p.setAttribute("x1",String(l)),p.setAttribute("x2","0"),p.setAttribute("y1","0"),p.setAttribute("y2",String(u)),p.setAttribute("stroke","black"),p.setAttribute("stroke-width","1.5"),d.appendChild(p),t.appendChild(d)}}},{key:"functionToMathML",value:function(t,e,n,i){var a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o="".concat(e,"/").concat(t.id),s=[];n&&s.push("active-element"),a&&s.push("selected-structure");var c=s.length>0?'class="'.concat(s.join(" "),'"'):"",l='data-context-path="'.concat(o,'" data-position="').concat(i,'" data-element-id="').concat(t.id,'" ').concat(c),u=t.functionType||"",d=this.generateMathMLContent("".concat(o,"/functionArgument"),t.functionArgument),p=this.generateMathMLContent("".concat(o,"/functionBase"),t.functionBase),h=this.generateMathMLContent("".concat(o,"/functionConstraint"),t.functionConstraint),f=r[u]||u;if(["function","functionsub","functionlim"].includes(u)){var m=this.generateMathMLContent("".concat(o,"/functionName"),t.functionName);if("function"===u)return"<mrow ".concat(l,">\n          ").concat(m,"\n          <mrow>").concat(d,"</mrow>\n        </mrow>");if("functionsub"===u)return"<mrow ".concat(l,">\n          <msub>\n            ").concat(m,"\n            <mrow>").concat(p,"</mrow>\n          </msub>\n          <mrow>").concat(d,"</mrow>\n        </mrow>");if("functionlim"===u)return"<mrow ".concat(l,">\n          <munder>\n            ").concat(m,"\n            <mrow>").concat(h,"</mrow>\n          </munder>\n          <mrow>").concat(d,"</mrow>\n        </mrow>")}if("simple"===f){var v={sin:"sin",cos:"cos",tan:"tan",sec:"sec",csc:"csc",cot:"cot",asin:"sin⁻¹",acos:"cos⁻¹",atan:"tan⁻¹",log:"log",ln:"ln",sinh:"sinh",cosh:"cosh",tanh:"tanh",asinh:"sinh⁻¹",acosh:"cosh⁻¹",atanh:"tanh⁻¹"}[u]||u;return"<mrow ".concat(l,'>\n        <mo mathvariant="normal">').concat(v,"</mo>\n        <mrow>").concat(d,"</mrow>\n      </mrow>")}if("functionsub"===f)return"<mrow ".concat(l,'>\n        <msub>\n          <mo mathvariant="normal">log</mo>\n          <mrow>').concat(p,"</mrow>\n        </msub>\n        <mrow>").concat(d,"</mrow>\n      </mrow>");if("functionlim"===f){var y={max:"max",min:"min",lim:"lim",argmax:"argmax",argmin:"argmin"}[u]||u;return"<mrow ".concat(l,'>\n        <munder>\n          <mo mathvariant="normal">').concat(y,"</mo>\n          <mrow>").concat(h,"</mrow>\n        </munder>\n        <mrow>").concat(d,"</mrow>\n      </mrow>")}return"<mrow ".concat(l,"><mrow>").concat(d,"</mrow></mrow>")}},{key:"generateMathMLContent",value:function(t,e){if(!e||0===e.length){var n=this.contextManager.getActiveContextPath();return n===t?'<mspace class="cursor" data-context-path="'.concat(t,'" data-position="0" />'):'<mi class="placeholder-square'.concat(n===t?" active-context":"",'" data-context-path="').concat(t,'" data-position="0">&#x25A1;</mi>')}return this.generateMathML(e,t)}}],e&&J(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function Y(t){return Y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Y(t)}function tt(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,nt(i.key),i)}}function et(t,e,n){return(e=nt(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function nt(t){var e=function(t){if("object"!=Y(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=Y(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Y(e)?e:e+""}var it=function(){return t=function t(e,n,i,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),et(this,"isDragging",!1),et(this,"dragStartPosition",0),et(this,"differentialStyle","italic"),et(this,"isInlineStyle",!1),et(this,"isTextMode",!1),this.equationBuilder=e,this.contextManager=n,this.displayRenderer=i,this.displayElement=r},e=[{key:"handleKeyPress",value:function(t){var e=this,n=t.key;"Backspace"===n?(t.preventDefault(),this.handleBackspace()):"Delete"===n?(t.preventDefault(),this.handleDelete()):"ArrowLeft"===n?(t.preventDefault(),t.ctrlKey&&t.shiftKey?this.contextManager.extendSelectionToStructure(-1):t.shiftKey?this.contextManager.extendSelection(-1):t.ctrlKey?(this.contextManager.clearSelection(),this.contextManager.enterAdjacentStructure("left"),setTimeout(function(){e.focusHiddenInput(),e.scrollCursorIntoView()},10)):(this.contextManager.clearSelection(),this.contextManager.moveCursor(-1)),this.updateDisplay()):"ArrowRight"===n?(t.preventDefault(),t.ctrlKey&&t.shiftKey?this.contextManager.extendSelectionToStructure(1):t.shiftKey?this.contextManager.extendSelection(1):t.ctrlKey?(this.contextManager.clearSelection(),this.contextManager.enterAdjacentStructure("right"),setTimeout(function(){e.focusHiddenInput(),e.scrollCursorIntoView()},10)):(this.contextManager.clearSelection(),this.contextManager.moveCursor(1)),this.updateDisplay()):"ArrowUp"===n||"ArrowDown"===n?(t.preventDefault(),t.ctrlKey&&t.shiftKey?"ArrowUp"===n?this.contextManager.selectParentStructure():this.contextManager.selectCurrentContext():(t.shiftKey||this.contextManager.clearSelection(),this.contextManager.navigateUpDown(n)),this.updateDisplay()):"Tab"===n?(t.preventDefault(),this.contextManager.clearSelection(),this.contextManager.navigateTab(),this.updateDisplay()):t.ctrlKey&&"a"===n.toLowerCase()?(t.preventDefault(),this.selectAll()):t.ctrlKey&&"b"===n.toLowerCase()?(t.preventDefault(),this.toggleBold()):t.ctrlKey&&t.shiftKey&&"t"===n.toLowerCase()?(t.preventDefault(),this.toggleTextMode()):t.ctrlKey&&t.shiftKey&&" "===n?(t.preventDefault(),this.selectEntireMatrix()):t.ctrlKey&&" "===n&&(t.preventDefault(),this.contextManager.selectStructureAtCursor()&&this.updateDisplay())}},{key:"handleInput",value:function(t){var e=t.target,n=e.value.slice(-1);if(e.value="",this.contextManager.isActive()&&n){var i=n,r=this.contextManager.getActiveContextPath().endsWith("/functionName");this.isTextMode||r||("+"===n?i="+":"-"===n&&(i="−"));var a=this.sanitizeInputChar(i);if(a){var o=this.equationBuilder.createTextElement(a);if(this.isTextMode)o.textMode=!0,o.italic=!1;else if(r)o.italic=!1;else{var s=this.getDefaultItalicForSymbol(a,a);void 0!==s&&(o.italic=s)}this.contextManager.insertElementAtCursor(o),this.updateDisplay()}}}},{key:"handleDisplayClick",value:function(t){t.stopPropagation();var e=t.target,n=this.displayElement.getBoundingClientRect(),i=t.clientX-n.left;if(!(t.clientY-n.top>this.displayElement.clientHeight||i>this.displayElement.clientWidth)){for(var r=null,a=e;a;){var o=a.dataset.contextPath;if(o&&("root"===o||o.endsWith("/numerator")||o.endsWith("/denominator")||o.endsWith("/radicand")||o.endsWith("/index")||o.endsWith("/base")||o.endsWith("/superscript")||o.endsWith("/subscript")||o.match(/\/cell_\d+_\d+$/)||o.endsWith("/content")||o.endsWith("/lowerLimit")||o.endsWith("/upperLimit")||o.endsWith("/operand")||o.endsWith("/function")||o.endsWith("/variable")||o.endsWith("/order")||o.endsWith("/integrand")||o.endsWith("/differentialVariable")||o.endsWith("/accentBase")||o.endsWith("/accentLabel")||o.endsWith("/functionArgument")||o.endsWith("/functionBase")||o.endsWith("/functionConstraint")||o.endsWith("/functionName"))){r=a;break}a=a.parentElement}if(r||!(r=e.closest(".equation-container"))&&e.classList.contains("equation-container")&&(r=e),e.closest(".format-btn")||e.closest(".tab-panel")||e.closest(".underline-dropdown-container")||e.closest(".underline-dropdown")||e.closest(".color-dropdown-container")||e.closest(".color-panel")||e.closest(".font-size-container")||e.closest(".font-size-dropdown")||!1===this.isDragging&&"mousedown"!==t.type&&(this.contextManager.clearSelection(),this.onSelectionChange&&this.onSelectionChange()),r){var s=r.dataset.contextPath;if(s){"root"===s?this.contextManager.enterRootContext():this.contextManager.enterContextPath(s);var c=this.contextManager.getContext(s);if(c){var l=this.getClickPosition(t,r,c.array);this.contextManager.setCursorPosition(l),this.dragStartPosition=l}}else{this.contextManager.enterRootContext();var u=this.getClickPosition(t,r,this.equationBuilder.getEquation());this.contextManager.setCursorPosition(u),this.dragStartPosition=u}}else{this.contextManager.enterRootContext();var d=this.equationBuilder.getEquation();if(0===d.length)this.contextManager.setCursorPosition(0),this.dragStartPosition=0;else{var p=this.displayElement.querySelector('[data-context-path="root"]');if(p){var h=this.getClickPosition(t,p,d);this.contextManager.setCursorPosition(h),this.dragStartPosition=h}else this.contextManager.setCursorPosition(d.length),this.dragStartPosition=d.length}}this.focusHiddenInput(),this.updateDisplay()}}},{key:"handleDocumentClick",value:function(t){var e=this.displayElement,n=document.querySelector(".tab-panel"),i=t.target,r=i.closest(".format-btn")||i.closest(".underline-dropdown-container")||i.closest(".underline-dropdown")||i.closest(".color-dropdown-container")||i.closest(".color-panel")||i.closest(".font-size-container")||i.closest(".font-size-dropdown");this.contextManager.isActive()&&e&&!e.contains(i)&&n&&!n.contains(i)&&!r&&(this.contextManager.exitEditingMode(),this.blurHiddenInput(),this.updateDisplay())}},{key:"handleFontSizeChange",value:function(t){var e=t.target,n=parseInt(e.value);!isNaN(n)&&n>=6&&n<=144&&(this.displayRenderer.setGlobalFontSize(n),this.updateDisplay())}},{key:"insertSymbol",value:function(t){this.contextManager.isActive()||this.contextManager.enterRootContext();var e=this.convertLatexToUnicode(t),n=this.equationBuilder.createTextElement(e),i=this.getDefaultItalicForSymbol(t,e);void 0!==i&&(n.italic=i),this.contextManager.insertElementAtCursor(n),this.updateDisplay(),this.focusHiddenInput()}},{key:"getDefaultItalicForSymbol",value:function(t,e){var n=s[t];if(n)return n.defaultItalic;if(t===e){if(/^[a-zA-Z]$/.test(e))return;if(/^[0-9]$/.test(e))return;if(/^[+\-=<>(){}[\]|]$/.test(e))return!1}}},{key:"convertLatexToUnicode",value:function(t){return c[t]||t}},{key:"insertFraction",value:function(){this.contextManager.isActive()||this.contextManager.enterRootContext();var t=this.equationBuilder.createFractionElement();this.contextManager.insertElementAtCursor(t);var e=this.contextManager.getElementContextPath(t.id,"numerator");this.contextManager.enterContextPath(e,0),this.updateDisplay(),this.equationBuilder.updateParenthesesScaling(),this.focusHiddenInput()}},{key:"insertDisplayFraction",value:function(){this.contextManager.isActive()||this.contextManager.enterRootContext();var t=this.equationBuilder.createDisplayFractionElement();this.contextManager.insertElementAtCursor(t);var e=this.contextManager.getElementContextPath(t.id,"numerator");this.contextManager.enterContextPath(e,0),this.updateDisplay(),this.equationBuilder.updateParenthesesScaling(),this.focusHiddenInput()}},{key:"insertBevelledFraction",value:function(){this.contextManager.isActive()||this.contextManager.enterRootContext();var t=this.equationBuilder.createBevelledFractionElement();this.contextManager.insertElementAtCursor(t);var e=this.contextManager.getElementContextPath(t.id,"numerator");this.contextManager.enterContextPath(e,0),this.updateDisplay(),this.equationBuilder.updateParenthesesScaling()}},{key:"insertSquareRoot",value:function(){this.contextManager.isActive()||this.contextManager.enterRootContext();var t=this.equationBuilder.createSquareRootElement();this.contextManager.insertElementAtCursor(t);var e=this.contextManager.getElementContextPath(t.id,"radicand");this.contextManager.enterContextPath(e,0),this.updateDisplay(),this.focusHiddenInput()}},{key:"insertNthRoot",value:function(){this.contextManager.isActive()||this.contextManager.enterRootContext();var t=this.equationBuilder.createNthRootElement();this.contextManager.insertElementAtCursor(t);var e=this.contextManager.getElementContextPath(t.id,"index");this.contextManager.enterContextPath(e,0),this.updateDisplay(),this.focusHiddenInput()}},{key:"insertScript",value:function(t){this.contextManager.isActive()||this.contextManager.enterRootContext();var e=this.equationBuilder.createScriptElement("superscript"===t,"subscript"===t);this.contextManager.insertElementAtCursor(e);var n=this.contextManager.getElementContextPath(e.id,"base");this.contextManager.enterContextPath(n,0),this.updateDisplay()}},{key:"insertSuperscriptSubscript",value:function(){this.contextManager.isActive()||this.contextManager.enterRootContext();var t=this.equationBuilder.createScriptElement(!0,!0);this.contextManager.insertElementAtCursor(t);var e=this.contextManager.getElementContextPath(t.id,"base");this.contextManager.enterContextPath(e,0),this.updateDisplay()}},{key:"insertBracket",value:function(t,e){this.contextManager.isActive()||this.contextManager.enterRootContext();var n=this.equationBuilder.createBracketElement(t,e);this.contextManager.insertElementAtCursor(n),this.equationBuilder.updateBracketNesting();var i=this.contextManager.getElementContextPath(n.id,"content");this.contextManager.enterContextPath(i,0),this.updateDisplay(),this.focusHiddenInput()}},{key:"insertCustomBrackets",value:function(t,e){this.contextManager.isActive()||this.contextManager.enterRootContext();var n=this.contextManager.getActiveContextPath();if(n&&n.includes("function")){var i,r=this.contextManager.getContext(n);if(r&&"derivative"===(null===(i=r.parent)||void 0===i?void 0:i.type)&&h(r.array.map(function(t){return t.value||""}).join("")+t+e))return void this.contextManager.showMixedBracketsError()}var a=this.equationBuilder.createBracketElement(t,e);this.contextManager.insertElementAtCursor(a),this.equationBuilder.updateBracketNesting();var o=this.contextManager.getElementContextPath(a.id,"content");this.contextManager.enterContextPath(o,0),this.updateDisplay(),this.focusHiddenInput()}},{key:"insertSummation",value:function(){this.contextManager.isActive()||this.contextManager.enterRootContext();var t=this.equationBuilder.createScriptElement(!0,!0),e=this.equationBuilder.createTextElement("∑");t.base=[e],this.contextManager.insertElementAtCursor(t);var n=this.contextManager.getElementContextPath(t.id,"subscript");this.contextManager.enterContextPath(n,0),this.updateDisplay(),this.focusHiddenInput()}},{key:"insertLargeOperator",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"inline",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"default";this.contextManager.isActive()||this.contextManager.enterRootContext();var i=this.equationBuilder.createLargeOperatorElement(t,e,n);this.contextManager.insertElementAtCursor(i);var r=this.contextManager.getElementContextPath(i.id,"operand");this.contextManager.enterContextPath(r,0),this.updateDisplay(),this.focusHiddenInput()}},{key:"insertAccent",value:function(t,e){if(this.contextManager.isActive()||this.contextManager.enterRootContext(),this.contextManager.hasSelection()){var n=this.contextManager.extractSelection(),i=this.equationBuilder.createAccentElement(t,e,n);if(this.contextManager.insertElementAtCursor(i),"labeledoverbrace"===t||"labeledunderbrace"===t){var r=this.contextManager.getElementContextPath(i.id,"accentLabel");this.contextManager.enterContextPath(r,0)}}else{var a=this.equationBuilder.createAccentElement(t,e,[]);this.contextManager.insertElementAtCursor(a);var o=this.contextManager.getElementContextPath(a.id,"accentBase");this.contextManager.enterContextPath(o,0)}this.updateDisplay(),this.focusHiddenInput()}},{key:"insertIntegral",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"single",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"inline",n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"default",r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"both";this.contextManager.isActive()||this.contextManager.enterRootContext();var a=this.equationBuilder.createIntegralElement(t,e,"roman"===this.differentialStyle?"roman":"italic",n,i,r);this.contextManager.insertElementAtCursor(a);var o=this.contextManager.getElementContextPath(a.id,"integrand");this.contextManager.enterContextPath(o,0),this.updateDisplay(),this.focusHiddenInput()}},{key:"insertSingleIntegral",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"inline";this.insertIntegral("single",t,!1)}},{key:"insertDoubleIntegral",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"inline";this.insertIntegral("double",t,!1)}},{key:"insertTripleIntegral",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"inline";this.insertIntegral("triple",t,!1)}},{key:"insertTripleIntegralSubscript",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"inline";this.insertIntegral("triple",t,!0,"nolimits","lower-only")}},{key:"insertTripleIntegralLower",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"inline";this.insertIntegral("triple",t,!0,"limits","lower-only")}},{key:"insertDoubleIntegralSubscript",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"inline";this.insertIntegral("double",t,!0,"nolimits","lower-only")}},{key:"insertDoubleIntegralLower",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"inline";this.insertIntegral("double",t,!0,"limits","lower-only")}},{key:"insertContourIntegral",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"inline";this.insertIntegral("contour",t,!1)}},{key:"insertContourIntegralSubscript",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"inline";this.insertIntegral("contour",t,!0,"nolimits","lower-only")}},{key:"insertContourIntegralLower",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"inline";this.insertIntegral("contour",t,!0,"limits","lower-only")}},{key:"insertDefiniteIntegral",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"single",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"inline",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"nolimits";this.insertIntegral(t,e,!0,n)}},{key:"insertIndefiniteIntegral",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"inline";this.insertSingleIntegral(t)}},{key:"updateDisplay",value:function(){var t=this;this.equationBuilder.updateBracketNesting(),this.displayRenderer.updateDisplay(this.displayElement,this.equationBuilder.getEquation()),this.contextManager.isActive()&&setTimeout(function(){t.focusHiddenInput(),t.scrollCursorIntoView()},0)}},{key:"focusHiddenInput",value:function(){var t=document.getElementById("hiddenInput");t&&t.focus()}},{key:"blurHiddenInput",value:function(){var t=document.getElementById("hiddenInput");t&&t.blur()}},{key:"scrollCursorIntoView",value:function(){var t=this.displayElement.querySelector(".cursor");t&&t.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}},{key:"isMatrixCellPath",value:function(t){return/\/cell_\d+_\d+$/.test(t)}},{key:"getMatrixElementFromCellPath",value:function(t){var e=t.match(/^(.*?)\/cell_\d+_\d+$/);if(!e)return null;for(var n,i=e[1],r=i.split("/"),a=this.equationBuilder.getEquation(),o=function(){var t=r[s],e=a.find(function(e){return e.id===t});if(!e)return{v:null};if(s===r.length-1){if("matrix"===e.type)return{v:{matrixPath:i,matrixElement:e}}}else{var n=r[s+1];if(!(a=e[n]))return{v:null}}},s="root"===r[0]?1:0;s<r.length;s++)if(n=o())return n.v;return null}},{key:"selectEntireMatrix",value:function(){var t=this.contextManager.getActiveContextPath();t&&this.isMatrixCellPath(t)&&this.getMatrixElementFromCellPath(t)&&this.contextManager.selectStructureAtCursor()&&this.updateDisplay()}},{key:"handleMouseDown",value:function(t){this.isDragging=!1,this.handleDisplayClick(t)}},{key:"handleMouseMove",value:function(t){if(1===t.buttons&&this.contextManager.isActive()){this.isDragging=!0;var e=t.target,n=e.closest("[data-context-path]");if(n||(n=e.closest(".equation-container")),n){var i=n.dataset.contextPath;if(i===this.contextManager.getActiveContextPath()){var r=this.contextManager.getContext(i);if(r){var a=this.getClickPosition(t,n,r.array);this.contextManager.setSelection(this.dragStartPosition,a,i);var o=this.contextManager.getSelection();this.contextManager.setCursorPosition(o.endPosition),this.updateDisplay()}}}}}},{key:"handleMouseUp",value:function(t){if(!this.isDragging){var e=t.target;e.closest(".format-btn")||e.closest(".tab-panel")||e.closest(".underline-dropdown-container")||e.closest(".underline-dropdown")||e.closest(".color-dropdown-container")||e.closest(".color-panel")||e.closest(".font-size-container")||e.closest(".font-size-dropdown")||this.contextManager.clearSelection()}this.isDragging=!1,this.onSelectionChange&&this.onSelectionChange()}},{key:"getClickPosition",value:function(t,e,n){if(0===n.length)return 0;var i=t.clientX,r=e.getBoundingClientRect(),a=(e.dataset.contextPath,Array.from(e.querySelectorAll("mi, mo, mn, mfrac, msqrt, msup, msub, msubsup, mroot")).filter(function(t){var e=t;return!e.classList.contains("cursor")&&void 0!==e.dataset.position}));if(0===a.length)return i-r.left<r.width/2?0:n.length;if(a.sort(function(t,e){var n=t.getBoundingClientRect(),i=e.getBoundingClientRect();return n.left-i.left}),i>a[a.length-1].getBoundingClientRect().right+10)return n.length;for(var o=0;o<a.length;o++){var s=a[o],c=s.getBoundingClientRect(),l=c.left,u=c.left+c.width/2;if(c.right,i<=l+2){var d=parseInt(s.dataset.position||"0",10);return Math.max(0,Math.min(d,n.length))}if(i<u){var p=parseInt(s.dataset.position||"0",10);return Math.max(0,Math.min(p,n.length))}if(o===a.length-1&&i>=u){var h=parseInt(s.dataset.position||"0",10);return Math.max(0,Math.min(h+1,n.length))}}return n.length}},{key:"selectAll",value:function(){if(this.contextManager.isActive()){var t=this.contextManager.getCurrentContext();t&&(this.contextManager.setSelection(0,t.array.length),this.updateDisplay())}}},{key:"toggleBold",value:function(){this.contextManager.hasSelection()&&(this.contextManager.isSelectionBold()?this.contextManager.applyFormattingToSelection({bold:!1}):this.contextManager.applyFormattingToSelection({bold:!0}),this.contextManager.clearSelection(),this.updateDisplay())}},{key:"toggleItalic",value:function(){this.contextManager.hasSelection()&&(this.contextManager.isSelectionItalic()?this.contextManager.applyFormattingToSelection({italic:!1}):this.contextManager.applyFormattingToSelection({italic:!0}),this.contextManager.clearSelection(),this.updateDisplay())}},{key:"toggleCancel",value:function(){this.contextManager.hasSelection()&&(this.contextManager.isSelectionCancel()?this.contextManager.removeWrapperFormattingFromSelection("cancel"):this.contextManager.applyWrapperFormattingToSelection({cancel:!0}),this.updateDisplay())}},{key:"setUnderlineStyle",value:function(t){this.contextManager.hasSelection()&&("none"===t||this.contextManager.isSelectionUnderlined()===t?this.contextManager.removeWrapperFormattingFromSelection("underline"):this.contextManager.applyWrapperFormattingToSelection({underline:t}),this.updateDisplay())}},{key:"getSelectionFormatting",value:function(){return this.contextManager.getSelectionFormatting()}},{key:"setTextColor",value:function(t){this.contextManager.hasSelection()&&("black"===t||"#000000"===t?this.contextManager.removeWrapperFormattingFromSelection("color"):this.contextManager.applyWrapperFormattingToSelection({color:t}),this.updateDisplay())}},{key:"toggleTextMode",value:function(){this.isTextMode=!this.isTextMode,this.contextManager.hasSelection()&&(this.isTextMode?this.contextManager.applyWrapperFormattingToSelection({textMode:!0}):this.contextManager.removeWrapperFormattingFromSelection("textMode")),this.updateDisplay()}},{key:"getTextMode",value:function(){return this.isTextMode}},{key:"handleBackspace",value:function(){this.contextManager.hasSelection()?(this.contextManager.deleteSelection(),this.equationBuilder.updateBracketNesting(),this.updateDisplay(),this.equationBuilder.updateParenthesesScaling()):this.contextManager.handleBackspace()&&(this.equationBuilder.updateBracketNesting(),this.updateDisplay(),this.equationBuilder.updateParenthesesScaling())}},{key:"handleDelete",value:function(){this.contextManager.hasSelection()?(this.contextManager.deleteSelection(),this.equationBuilder.updateBracketNesting(),this.updateDisplay(),this.equationBuilder.updateParenthesesScaling()):this.contextManager.handleDelete()&&(this.equationBuilder.updateBracketNesting(),this.updateDisplay(),this.equationBuilder.updateParenthesesScaling())}},{key:"sanitizeInputChar",value:function(t){var e=t.charCodeAt(0);if("\\"===t)return"";if(" "===t){var n=this.contextManager.getActiveContextPath().endsWith("/functionName");return this.isTextMode||n?t:""}return e<32||127===e?"":t}},{key:"setDifferentialStyle",value:function(t){this.differentialStyle=t}},{key:"setInlineStyle",value:function(t){this.isInlineStyle=t}},{key:"updateExistingEquationStyle",value:function(t){this.updateDisplay()}},{key:"updateExistingDifferentialStyle",value:function(t){var e=this.equationBuilder.getEquation();this.updateDifferentialStyleRecursive(e,t),this.updateDisplay()}},{key:"updateDifferentialStyleRecursive",value:function(t,e){var n=this;t.forEach(function(t){"text"===t.type&&"d"===t.value&&("roman"===e?t.italic=!1:delete t.italic),t.numerator&&n.updateDifferentialStyleRecursive(t.numerator,e),t.denominator&&n.updateDifferentialStyleRecursive(t.denominator,e),t.radicand&&n.updateDifferentialStyleRecursive(t.radicand,e),t.index&&n.updateDifferentialStyleRecursive(t.index,e),t.base&&n.updateDifferentialStyleRecursive(t.base,e),t.superscript&&n.updateDifferentialStyleRecursive(t.superscript,e),t.subscript&&n.updateDifferentialStyleRecursive(t.subscript,e),t.content&&n.updateDifferentialStyleRecursive(t.content,e),t.lowerLimit&&n.updateDifferentialStyleRecursive(t.lowerLimit,e),t.upperLimit&&n.updateDifferentialStyleRecursive(t.upperLimit,e),t.operand&&n.updateDifferentialStyleRecursive(t.operand,e)})}},{key:"insertDerivative",value:function(t,e){var n;this.contextManager.isActive()||this.contextManager.enterRootContext(),n="first"===t?1:"second"===t?2:[];var i,r=this.equationBuilder.createDerivativeElement(n,"inline"===e?"inline":"display");this.contextManager.insertElementAtCursor(r),"nth"===t?(i=this.contextManager.getElementContextPath(r.id,"order"),this.contextManager.enterContextPath(i,0)):(i=this.contextManager.getElementContextPath(r.id,"function"),this.contextManager.enterContextPath(i,0)),this.updateDisplay(),this.equationBuilder.updateParenthesesScaling(),this.focusHiddenInput()}},{key:"insertDerivativeLongForm",value:function(t,e){var n;this.contextManager.isActive()||this.contextManager.enterRootContext(),n="first"===t?1:[];var i,r=this.equationBuilder.createDerivativeElement(n,"inline"===e?"inline":"display",!0);this.contextManager.insertElementAtCursor(r),"nth"===t?(i=this.contextManager.getElementContextPath(r.id,"order"),this.contextManager.enterContextPath(i,0)):(i=this.contextManager.getElementContextPath(r.id,"variable"),this.contextManager.enterContextPath(i,0)),this.updateDisplay(),this.equationBuilder.updateParenthesesScaling(),this.focusHiddenInput()}},{key:"getDifferentialStyleForLatex",value:function(){return"roman"===this.differentialStyle}},{key:"insertPartialDerivative",value:function(t,e){var n;this.contextManager.isActive()||this.contextManager.enterRootContext(),n="first"===t?1:"second"===t?2:[];var i,r=this.equationBuilder.createDerivativeElement(n,e||(this.isInlineStyle?"inline":"display"),!1,!0);this.contextManager.insertElementAtCursor(r),"nth"===t?(i=this.contextManager.getElementContextPath(r.id,"order"),this.contextManager.enterContextPath(i,0)):(i=this.contextManager.getElementContextPath(r.id,"variable"),this.contextManager.enterContextPath(i,0)),this.updateDisplay(),this.equationBuilder.updateParenthesesScaling(),this.focusHiddenInput()}},{key:"insertPartialDerivativeLongForm",value:function(t,e){var n;this.contextManager.isActive()||this.contextManager.enterRootContext(),n="first"===t?1:[];var i,r=this.equationBuilder.createDerivativeElement(n,e||(this.isInlineStyle?"inline":"display"),!0,!0);this.contextManager.insertElementAtCursor(r),"nth"===t?(i=this.contextManager.getElementContextPath(r.id,"order"),this.contextManager.enterContextPath(i,0)):(i=this.contextManager.getElementContextPath(r.id,"variable"),this.contextManager.enterContextPath(i,0)),this.updateDisplay(),this.equationBuilder.updateParenthesesScaling(),this.focusHiddenInput()}},{key:"createMatrix",value:function(t,e,n){this.contextManager.isActive()||this.contextManager.enterRootContext();var i=this.equationBuilder.createMatrixElement(t,e,n),r=this.contextManager.getActiveContextPath()||"root";this.contextManager.insertElementAtCursor(i);var a="".concat(r,"/").concat(i.id);this.contextManager.enterContextPath("".concat(a,"/cell_0_0"),0),this.updateDisplay(),this.equationBuilder.updateParenthesesScaling(),this.focusHiddenInput()}},{key:"insertStack",value:function(t,e){this.contextManager.isActive()||this.contextManager.enterRootContext();var n=this.equationBuilder.createStackElement(t,e),i=this.contextManager.getActiveContextPath()||"root";this.contextManager.insertElementAtCursor(n);var r="".concat(i,"/").concat(n.id);this.contextManager.enterContextPath("".concat(r,"/cell_0_0"),0),this.updateDisplay(),this.equationBuilder.updateParenthesesScaling(),this.focusHiddenInput()}},{key:"insertCases",value:function(t,e){this.contextManager.isActive()||this.contextManager.enterRootContext();var n=this.equationBuilder.createCasesElement(t,e),i=this.contextManager.getActiveContextPath()||"root";this.contextManager.insertElementAtCursor(n);var r="".concat(i,"/").concat(n.id);this.contextManager.enterContextPath("".concat(r,"/cell_0_0"),0),this.updateDisplay(),this.equationBuilder.updateParenthesesScaling(),this.focusHiddenInput()}},{key:"insertFunction",value:function(t){this.contextManager.isActive()||this.contextManager.enterRootContext();var e=this.equationBuilder.createFunctionElement(t);this.contextManager.insertElementAtCursor(e);var n=r[t];if(n){if("simple"===n){var i=this.contextManager.getElementContextPath(e.id,"functionArgument");this.contextManager.enterContextPath(i,0)}else if("functionsub"===n){var a=this.contextManager.getElementContextPath(e.id,"functionBase");this.contextManager.enterContextPath(a,0)}else if("functionlim"===n){var o=this.contextManager.getElementContextPath(e.id,"functionConstraint");this.contextManager.enterContextPath(o,0)}else if("function"===n){var s=this.contextManager.getElementContextPath(e.id,"functionName");this.contextManager.enterContextPath(s,0)}this.updateDisplay(),this.focusHiddenInput()}else console.warn("Unknown function type: ".concat(t))}},{key:"insertEvaluationBracket",value:function(t){this.contextManager.isActive()||this.contextManager.enterRootContext();var e=this.equationBuilder.createEvaluationBracketElement(t);this.contextManager.insertElementAtCursor(e),this.equationBuilder.updateBracketNesting();var n=this.contextManager.getElementContextPath(e.id,"content");this.contextManager.enterContextPath(n,0),this.updateDisplay(),this.focusHiddenInput()}}],e&&tt(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function rt(t){return rt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},rt(t)}function at(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,st(i.key),i)}}function ot(t,e,n){return(e=st(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function st(t){var e=function(t){if("object"!=rt(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=rt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==rt(e)?e:e+""}var ct=function(){return t=function t(e,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),ot(this,"isDragging",!1),ot(this,"startX",0),ot(this,"scrollLeft",0),this.tabNav=e,this.tabContent=n,this.tabNavContainer=e.parentElement,this.leftScrollBtn=document.getElementById("tabScrollLeft"),this.rightScrollBtn=document.getElementById("tabScrollRight"),this.setupEventListeners(),this.updateScrollButtons()},e=[{key:"setupEventListeners",value:function(){var t=this;this.tabNav.addEventListener("click",function(e){var n=e.target.closest(".tab-btn");if(n){var i=n.dataset.tab;i&&t.activateTab(i)}}),this.leftScrollBtn.addEventListener("click",function(){t.scrollTabs(-100)}),this.rightScrollBtn.addEventListener("click",function(){t.scrollTabs(100)}),this.tabNav.addEventListener("scroll",function(){t.updateScrollButtons()}),this.tabNav.addEventListener("mousedown",function(e){t.isDragging=!0,t.startX=e.pageX-t.tabNav.offsetLeft,t.scrollLeft=t.tabNav.scrollLeft,t.tabNav.style.cursor="grabbing",e.preventDefault()}),document.addEventListener("mousemove",function(e){if(t.isDragging){e.preventDefault();var n=2*(e.pageX-t.tabNav.offsetLeft-t.startX);t.tabNav.scrollLeft=t.scrollLeft-n}}),document.addEventListener("mouseup",function(){t.isDragging=!1,t.tabNav.style.cursor="default"}),this.tabNav.addEventListener("selectstart",function(e){t.isDragging&&e.preventDefault()})}},{key:"activateTab",value:function(t){this.tabNav.querySelectorAll(".tab-btn").forEach(function(t){return t.classList.remove("active")}),document.querySelectorAll(".tab-pane").forEach(function(t){return t.classList.remove("active")});var e=this.tabNav.querySelector('[data-tab="'.concat(t,'"]'));e&&e.classList.add("active");var n=document.getElementById(t);n&&n.classList.add("active")}},{key:"getActiveTabId",value:function(){var t=this.tabNav.querySelector(".tab-btn.active");return t&&t.dataset.tab||null}},{key:"setActiveTab",value:function(t){this.activateTab(t)}},{key:"scrollTabs",value:function(t){this.tabNav.scrollBy({left:t,behavior:"smooth"})}},{key:"updateScrollButtons",value:function(){var t=this.tabNav,e=t.scrollLeft,n=t.scrollWidth,i=t.clientWidth;this.leftScrollBtn&&(this.leftScrollBtn.disabled=e<=0),this.rightScrollBtn&&(this.rightScrollBtn.disabled=e>=n-i-1)}}],e&&at(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function lt(t){return lt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},lt(t)}function ut(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=Array(e);n<e;n++)i[n]=t[n];return i}function dt(){var t,e,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",r=n.toStringTag||"@@toStringTag";function a(n,i,r,a){var c=i&&i.prototype instanceof s?i:s,l=Object.create(c.prototype);return pt(l,"_invoke",function(n,i,r){var a,s,c,l=0,u=r||[],d=!1,p={p:0,n:0,v:t,a:h,f:h.bind(t,4),d:function(e,n){return a=e,s=0,c=t,p.n=n,o}};function h(n,i){for(s=n,c=i,e=0;!d&&l&&!r&&e<u.length;e++){var r,a=u[e],h=p.p,f=a[2];n>3?(r=f===i)&&(c=a[(s=a[4])?5:(s=3,3)],a[4]=a[5]=t):a[0]<=h&&((r=n<2&&h<a[1])?(s=0,p.v=i,p.n=a[1]):h<f&&(r=n<3||a[0]>i||i>f)&&(a[4]=n,a[5]=i,p.n=f,s=0))}if(r||n>1)return o;throw d=!0,i}return function(r,u,f){if(l>1)throw TypeError("Generator is already running");for(d&&1===u&&h(u,f),s=u,c=f;(e=s<2?t:c)||!d;){a||(s?s<3?(s>1&&(p.n=-1),h(s,c)):p.n=c:p.v=c);try{if(l=2,a){if(s||(r="next"),e=a[r]){if(!(e=e.call(a,c)))throw TypeError("iterator result is not an object");if(!e.done)return e;c=e.value,s<2&&(s=0)}else 1===s&&(e=a.return)&&e.call(a),s<2&&(c=TypeError("The iterator does not provide a '"+r+"' method"),s=1);a=t}else if((e=(d=p.n<0)?c:n.call(i,p))!==o)break}catch(e){a=t,s=1,c=e}finally{l=1}}return{value:e,done:d}}}(n,r,a),!0),l}var o={};function s(){}function c(){}function l(){}e=Object.getPrototypeOf;var u=[][i]?e(e([][i]())):(pt(e={},i,function(){return this}),e),d=l.prototype=s.prototype=Object.create(u);function p(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,l):(t.__proto__=l,pt(t,r,"GeneratorFunction")),t.prototype=Object.create(d),t}return c.prototype=l,pt(d,"constructor",l),pt(l,"constructor",c),c.displayName="GeneratorFunction",pt(l,r,"GeneratorFunction"),pt(d),pt(d,r,"Generator"),pt(d,i,function(){return this}),pt(d,"toString",function(){return"[object Generator]"}),(dt=function(){return{w:a,m:p}})()}function pt(t,e,n,i){var r=Object.defineProperty;try{r({},"",{})}catch(t){r=0}pt=function(t,e,n,i){if(e)r?r(t,e,{value:n,enumerable:!i,configurable:!i,writable:!i}):t[e]=n;else{var a=function(e,n){pt(t,e,function(t){return this._invoke(e,n,t)})};a("next",0),a("throw",1),a("return",2)}},pt(t,e,n,i)}function ht(t,e,n,i,r,a,o){try{var s=t[a](o),c=s.value}catch(t){return void n(t)}s.done?e(c):Promise.resolve(c).then(i,r)}function ft(t){return function(){var e=this,n=arguments;return new Promise(function(i,r){var a=t.apply(e,n);function o(t){ht(a,i,r,o,s,"next",t)}function s(t){ht(a,i,r,o,s,"throw",t)}o(void 0)})}}function mt(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,vt(i.key),i)}}function vt(t){var e=function(t){if("object"!=lt(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=lt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==lt(e)?e:e+""}var yt=function(){return t=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)},e=[{key:"renderLatexToSvg",value:(i=ft(dt().m(function t(e){var n,i,r,a,o,s;return dt().w(function(t){for(;;)switch(t.n){case 0:if(t.p=0,n=document.getElementById("mathjax-renderer")){t.n=1;break}throw new Error("MathJax renderer element not found.");case 1:return i=e.includes("\\displaystyle"),r=i?"\\[".concat(e,"\\]"):"\\(".concat(e,"\\)"),n.innerHTML=r,MathJax.texReset(),t.n=2,MathJax.typesetPromise([n]);case 2:if(a=n.querySelector("mjx-container"),o=null==a?void 0:a.querySelector("svg")){t.n=3;break}throw new Error("Failed to find SVG in MathJax output.");case 3:return s=o.cloneNode(!0),n.innerHTML="",t.a(2,s);case 4:throw t.p=4,t.v,new Error("Failed to convert equation to image. Please check the syntax.");case 5:return t.a(2)}},t,null,[[0,4]])})),function(t){return i.apply(this,arguments)})},{key:"extractSvgPositionInfo",value:function(t){var e=t.getAttribute("viewBox");if(!e)throw new Error("SVG missing viewBox attribute.");var n=function(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var i,r,a,o,s=[],c=!0,l=!1;try{if(a=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;c=!1}else for(;!(c=(i=a.call(n)).done)&&(s.push(i.value),s.length!==e);c=!0);}catch(t){l=!0,r=t}finally{try{if(!c&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(l)throw r}}return s}}(t,e)||function(t,e){if(t){if("string"==typeof t)return ut(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ut(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(e.split(" ").map(parseFloat),4),i=(n[0],n[1]),r=n[2],a=n[3],o=0,s=(t.getAttribute("style")||"").match(/vertical-align:\s*([-\d.]+)ex/);s&&(o=parseFloat(s[1]));var c=[];t.querySelectorAll("rect").forEach(function(t){var e=parseFloat(t.getAttribute("height")||"0"),n=parseFloat(t.getAttribute("width")||"0"),i=parseFloat(t.getAttribute("y")||"0"),o=parseFloat(t.getAttribute("x")||"0");e<.05*a&&n>.1*r&&c.push({y:i,width:n,height:e,x:o,isMain:!1})});var l=null;if(c.length>0){var u=i+a/2,d=[].concat(c).sort(function(t,e){var n=e.width-t.width;return Math.abs(n)>.1*r?n:Math.abs(t.y-u)-Math.abs(e.y-u)});l=d[0];var p=c.findIndex(function(t){return t.y===l.y&&t.width===l.width&&t.x===l.x});-1!==p&&(c[p].isMain=!0)}return{baseline:o,fractionBars:c,mainFractionBar:l,totalHeight:a,totalWidth:r}}},{key:"isMathJaxReady",value:function(){return"undefined"!=typeof MathJax&&MathJax.startup}},{key:"waitForMathJaxReady",value:(n=ft(dt().m(function t(){return dt().w(function(t){for(;;)switch(t.n){case 0:if(this.isMathJaxReady()){t.n=1;break}throw new Error("MathJax is not defined.");case 1:return t.p=1,t.n=2,MathJax.startup.promise;case 2:t.n=4;break;case 3:throw t.p=3,t.v,new Error("Could not load MathJax.");case 4:return t.a(2)}},t,this,[[1,3]])})),function(){return n.apply(this,arguments)})}],e&&mt(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,n,i}();function gt(t){return gt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},gt(t)}function bt(){var t,e,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",r=n.toStringTag||"@@toStringTag";function a(n,i,r,a){var c=i&&i.prototype instanceof s?i:s,l=Object.create(c.prototype);return xt(l,"_invoke",function(n,i,r){var a,s,c,l=0,u=r||[],d=!1,p={p:0,n:0,v:t,a:h,f:h.bind(t,4),d:function(e,n){return a=e,s=0,c=t,p.n=n,o}};function h(n,i){for(s=n,c=i,e=0;!d&&l&&!r&&e<u.length;e++){var r,a=u[e],h=p.p,f=a[2];n>3?(r=f===i)&&(c=a[(s=a[4])?5:(s=3,3)],a[4]=a[5]=t):a[0]<=h&&((r=n<2&&h<a[1])?(s=0,p.v=i,p.n=a[1]):h<f&&(r=n<3||a[0]>i||i>f)&&(a[4]=n,a[5]=i,p.n=f,s=0))}if(r||n>1)return o;throw d=!0,i}return function(r,u,f){if(l>1)throw TypeError("Generator is already running");for(d&&1===u&&h(u,f),s=u,c=f;(e=s<2?t:c)||!d;){a||(s?s<3?(s>1&&(p.n=-1),h(s,c)):p.n=c:p.v=c);try{if(l=2,a){if(s||(r="next"),e=a[r]){if(!(e=e.call(a,c)))throw TypeError("iterator result is not an object");if(!e.done)return e;c=e.value,s<2&&(s=0)}else 1===s&&(e=a.return)&&e.call(a),s<2&&(c=TypeError("The iterator does not provide a '"+r+"' method"),s=1);a=t}else if((e=(d=p.n<0)?c:n.call(i,p))!==o)break}catch(e){a=t,s=1,c=e}finally{l=1}}return{value:e,done:d}}}(n,r,a),!0),l}var o={};function s(){}function c(){}function l(){}e=Object.getPrototypeOf;var u=[][i]?e(e([][i]())):(xt(e={},i,function(){return this}),e),d=l.prototype=s.prototype=Object.create(u);function p(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,l):(t.__proto__=l,xt(t,r,"GeneratorFunction")),t.prototype=Object.create(d),t}return c.prototype=l,xt(d,"constructor",l),xt(l,"constructor",c),c.displayName="GeneratorFunction",xt(l,r,"GeneratorFunction"),xt(d),xt(d,r,"Generator"),xt(d,i,function(){return this}),xt(d,"toString",function(){return"[object Generator]"}),(bt=function(){return{w:a,m:p}})()}function xt(t,e,n,i){var r=Object.defineProperty;try{r({},"",{})}catch(t){r=0}xt=function(t,e,n,i){if(e)r?r(t,e,{value:n,enumerable:!i,configurable:!i,writable:!i}):t[e]=n;else{var a=function(e,n){xt(t,e,function(t){return this._invoke(e,n,t)})};a("next",0),a("throw",1),a("return",2)}},xt(t,e,n,i)}function wt(t,e,n,i,r,a,o){try{var s=t[a](o),c=s.value}catch(t){return void n(t)}s.done?e(c):Promise.resolve(c).then(i,r)}function kt(t){return function(){var e=this,n=arguments;return new Promise(function(i,r){var a=t.apply(e,n);function o(t){wt(a,i,r,o,s,"next",t)}function s(t){wt(a,i,r,o,s,"throw",t)}o(void 0)})}}function Lt(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,Ct(i.key),i)}}function Ct(t){var e=function(t){if("object"!=gt(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=gt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==gt(e)?e:e+""}var St=function(){return t=function t(e,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.equationBuilder=e,this.latexConverter=n},e=[{key:"setEquationLoadedCallback",value:function(t){this.onEquationLoadedCallback=t}},{key:"insertEquationToWord",value:(a=kt(bt().m(function t(e,n,i,r,a){var o,s,c,l,u,d,p=this;return bt().w(function(t){for(;;)switch(t.n){case 0:t.p=0,o=new Blob([e]).size,s=o/1024,console.log("SVG Image dimensions: ".concat(n,"x").concat(i,"px")),console.log("SVG String size: ".concat(o," bytes (").concat(s.toFixed(2)," KB)")),t.p=1,c=btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(t,e){return String.fromCharCode(parseInt(e,16))})),l=c.length/1024,console.log("Base64 SVG length: ".concat(c.length," chars (").concat(l.toFixed(2)," KB)")),t.n=3;break;case 2:throw t.p=2,u=t.v,console.error("Base64 conversion failed:",u),new Error("Failed to convert SVG to base64");case 3:return t.n=4,Word.run(function(){var t=kt(bt().m(function t(o){var l,u,d,h,f,m,v,y,g,b,x,w,k,L,C;return bt().w(function(t){for(;;)switch(t.n){case 0:return console.log("Inside Word.run context"),l=o.document.getSelection(),console.log("Got document selection"),u="hlleqed ".concat(a),d=p.createInlineImageWithPositionOoxml(c,n,i,r,u),h=d.length/1024,console.log("OOXML size: ".concat(h.toFixed(1),"KB")),a.includes("matrix")||a.includes("pmatrix")||a.includes("bmatrix")||a.includes("cases")||a.includes("array"),console.log("Attempting OOXML for simple equation (".concat(h.toFixed(1),"KB)...")),t.p=1,l.insertOoxml(d,Word.InsertLocation.replace),t.n=2,o.sync();case 2:return console.log("OOXML insertion successful"),t.a(2);case 3:t.p=3,k=t.v,console.log("OOXML insertion failed, falling back to PNG:",k),t.n=5;break;case 4:console.log("Matrix/Array content detected - OOXML insertion not supported by Word (SVG: ".concat(s.toFixed(1),"KB, Base64: ").concat((c.length/1024).toFixed(1),"KB)")),console.log("Using PNG approach instead...");case 5:return console.log("Attempting PNG conversion and insertion..."),t.p=6,console.log("Converting SVG to PNG..."),t.n=7,p.convertSvgToPng(e,n,i);case 7:if(f=t.v,m=3*f.length/4/1024,console.log("PNG conversion successful, size: ".concat(m.toFixed(1),"KB")),!(m<50)){t.n=16;break}console.log("Attempting PNG insertion via insertInlinePictureFromBase64..."),v=["data:image/png;base64,".concat(f),f],y=!1,g=0;case 8:if(!(g<v.length)||y){t.n=14;break}return t.p=9,console.log("Trying PNG format ".concat(g+1,":"),v[g].substring(0,50)+"..."),b=l.insertInlinePictureFromBase64(v[g],Word.InsertLocation.replace),x=.75*n,w=.75*i,b.width=x,b.height=w,t.n=10,o.sync();case 10:return 0!==r&&(b.getRange().font.position=r,console.log("Applied baseline offset: ".concat(r,"pt"))),b.altTextDescription=u,t.n=11,o.sync();case 11:console.log("PNG insertion with alt text and baseline positioning successful"),y=!0,t.n=13;break;case 12:t.p=12,L=t.v,console.log("PNG format ".concat(g+1," failed:"),L);case 13:g++,t.n=8;break;case 14:if(y){t.n=15;break}throw new Error("All PNG formats failed");case 15:t.n=17;break;case 16:throw new Error("PNG too large, falling back to text");case 17:t.n=20;break;case 18:return t.p=18,C=t.v,console.log("PNG conversion/insertion failed:",C),console.log("All image insertion methods failed, using text fallback"),l.insertText("[EQUATION: ".concat(a,"]"),Word.InsertLocation.replace),t.n=19,o.sync();case 19:console.log("Text fallback successful");case 20:return t.a(2)}},t,null,[[9,12],[6,18],[1,3]])}));return function(e){return t.apply(this,arguments)}}());case 4:t.n=6;break;case 5:throw t.p=5,d=t.v,console.error("Word.run failed:",d),console.error("LaTeX that caused the error:",a),d;case 6:return t.a(2)}},t,null,[[1,2],[0,5]])})),function(t,e,n,i,r){return a.apply(this,arguments)})},{key:"setupEquationImageHandler",value:function(){var t=this;Office.context.document.addHandlerAsync(Office.EventType.DocumentSelectionChanged,function(){return t.handleSelectionChange()})}},{key:"handleSelectionChange",value:(r=kt(bt().m(function t(){var e=this;return bt().w(function(t){for(;;)switch(t.n){case 0:return t.p=0,t.n=1,Word.run(function(){var t=kt(bt().m(function t(n){var i,r,a,o;return bt().w(function(t){for(;;)switch(t.n){case 0:return(i=n.document.getSelection()).load("inlinePictures"),t.n=1,n.sync();case 1:if(!(i.inlinePictures.items.length>0)){t.n=4;break}return(r=i.inlinePictures.items[0]).load("altTextDescription"),t.n=2,n.sync();case 2:if(!(a=r.altTextDescription)||!a.trim()){t.n=4;break}if(!a.startsWith("hlleqed ")){t.n=4;break}return o=a.substring(8),t.n=3,e.loadEquationFromLatex(o);case 3:if(!t.v||!e.onEquationLoadedCallback){t.n=4;break}return t.n=4,e.onEquationLoadedCallback(o);case 4:return t.a(2)}},t)}));return function(e){return t.apply(this,arguments)}}());case 1:t.n=3;break;case 2:t.p=2,t.v;case 3:return t.a(2)}},t,null,[[0,2]])})),function(){return r.apply(this,arguments)})},{key:"loadEquationFromLatex",value:(i=kt(bt().m(function t(e){var n,i;return bt().w(function(t){for(;;)switch(t.n){case 0:if(t.p=0,!(n=this.latexConverter.parseFromLatex(e))){t.n=1;break}return this.equationBuilder.setEquation(n),this.equationBuilder.updateBracketNesting(),t.a(2,!0);case 1:return t.a(2,!1);case 2:return t.p=2,i=t.v,console.error("Error loading equation from LaTeX:",i),t.a(2,!1)}},t,this,[[0,2]])})),function(t){return i.apply(this,arguments)})},{key:"createInlineImageWithPositionOoxml",value:function(t,e,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"",a=Math.round(9525*e),o=Math.round(9525*n),s="rId"+Math.random().toString(36).substring(2,12),c=Math.floor(1e6*Math.random())+1,l=Math.round(2*i);return'\n<pkg:package xmlns:pkg="http://schemas.microsoft.com/office/2006/xmlPackage">\n  <pkg:part pkg:name="/_rels/.rels" pkg:contentType="application/vnd.openxmlformats-package.relationships+xml">\n    <pkg:xmlData>\n      <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n        <Relationship Id="'.concat("rId1",'" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>\n      </Relationships>\n    </pkg:xmlData>\n  </pkg:part>\n  <pkg:part pkg:name="/word/_rels/document.xml.rels" pkg:contentType="application/vnd.openxmlformats-package.relationships+xml">\n    <pkg:xmlData>\n      <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n        <Relationship Id="').concat(s,'" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="media/image1.svg"/>\n      </Relationships>\n    </pkg:xmlData>\n  </pkg:part>\n  <pkg:part pkg:name="/word/media/image1.svg" pkg:contentType="image/svg+xml">\n    <pkg:binaryData>').concat(t,'</pkg:binaryData>\n  </pkg:part>\n  <pkg:part pkg:name="/word/document.xml" pkg:contentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml">\n    <pkg:xmlData>\n      <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing" xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main" xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">\n        <w:body>\n          <w:p>\n            <w:r>\n              ').concat(0!==l?'<w:rPr>\n                <w:position w:val="'.concat(l,'"/>\n              </w:rPr>'):"",'\n              <w:drawing>\n                <wp:inline distT="0" distB="0" distL="0" distR="0">\n                  <wp:extent cx="').concat(a,'" cy="').concat(o,'"/>\n                  <wp:effectExtent l="0" t="0" r="0" b="0"/>\n                  <wp:docPr id="').concat(c,'" name="Math Equation" descr="').concat(r,'"/>\n                  <wp:cNvGraphicFramePr/>\n                  <a:graphic>\n                    <a:graphicData uri="http://schemas.openxmlformats.org/drawingml/2006/picture">\n                      <pic:pic>\n                        <pic:nvPicPr>\n                          <pic:cNvPr id="').concat(c,'" name="Math Equation" descr="').concat(r,'"/>\n                          <pic:cNvPicPr/>\n                        </pic:nvPicPr>\n                        <pic:blipFill>\n                          <a:blip r:embed="').concat(s,'"/>\n                          <a:stretch>\n                            <a:fillRect/>\n                          </a:stretch>\n                        </pic:blipFill>\n                        <pic:spPr>\n                          <a:xfrm>\n                            <a:off x="0" y="0"/>\n                            <a:ext cx="').concat(a,'" cy="').concat(o,'"/>\n                          </a:xfrm>\n                          <a:prstGeom prst="rect">\n                            <a:avLst/>\n                          </a:prstGeom>\n                        </pic:spPr>\n                      </pic:pic>\n                    </a:graphicData>\n                  </a:graphic>\n                </wp:inline>\n              </w:drawing>\n            </w:r>\n          </w:p>\n        </w:body>\n      </w:document>\n    </pkg:xmlData>\n  </pkg:part>\n</pkg:package>').trim()}},{key:"convertSvgToPng",value:(n=kt(bt().m(function t(e,n,i){return bt().w(function(t){for(;;)if(0===t.n)return t.a(2,new Promise(function(t,r){try{console.log("Starting SVG to PNG conversion...");var a=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),o=URL.createObjectURL(a),s=new Image;s.onload=function(){try{var e=window.devicePixelRatio||1,a=Math.round(n*e*2),c=Math.round(i*e*2);console.log("Canvas dimensions: ".concat(a,"x").concat(c," (DPR: ").concat(e,")"));var l=document.createElement("canvas");l.width=a,l.height=c;var u=l.getContext("2d");if(!u)throw new Error("Failed to get 2D context");u.imageSmoothingEnabled=!0,u.imageSmoothingQuality="high",u.fillStyle="white",u.fillRect(0,0,a,c),u.drawImage(s,0,0,a,c),l.toBlob(function(e){if(e){console.log("PNG blob created, size: ".concat(e.size," bytes"));var n=new FileReader;n.onload=function(){var e=n.result.split(",")[1];console.log("PNG base64 length: ".concat(e.length)),URL.revokeObjectURL(o),t(e)},n.onerror=function(){return r(new Error("Failed to read PNG blob"))},n.readAsDataURL(e)}else r(new Error("Failed to convert canvas to blob"))},"image/png",1)}catch(t){URL.revokeObjectURL(o),r(t)}},s.onerror=function(){URL.revokeObjectURL(o),r(new Error("Failed to load SVG image"))},s.src=o}catch(t){console.error("SVG to PNG conversion error:",t),r(t)}}))},t)})),function(t,e,i){return n.apply(this,arguments)})}],e&&Lt(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,n,i,r,a}();function It(t){return It="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},It(t)}function Et(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=Array(e);n<e;n++)i[n]=t[n];return i}function Mt(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,Pt(i.key),i)}}function Pt(t){var e=function(t){if("object"!=It(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=It(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==It(e)?e:e+""}var Bt=function(){return t=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)},(e=[{key:"prepareSvgForOffice",value:function(t,e,n){var i=t.cloneNode(!0);i.setAttribute("xmlns","http://www.w3.org/2000/svg");var r=(i.getAttribute("style")||"").match(/vertical-align:\s*([-\d.]+)ex/);r&&parseFloat(r[1]),this.cleanSvgAttributes(i);var a=i.getAttribute("viewBox");if(!a)throw new Error("SVG missing viewBox attribute.");var o=function(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var i,r,a,o,s=[],c=!0,l=!1;try{if(a=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;c=!1}else for(;!(c=(i=a.call(n)).done)&&(s.push(i.value),s.length!==e);c=!0);}catch(t){l=!0,r=t}finally{try{if(!c&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(l)throw r}}return s}}(t,e)||function(t,e){if(t){if("string"==typeof t)return Et(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Et(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(a.split(" ").map(parseFloat),4),s=o[0],c=o[1],l=o[2],u=o[3],d=e*(96/72)/1e3,p=Math.round(l*d),h=Math.round(u*d),f=0;if(n){var m=.5*n.baseline*e*(96/72);n.mainFractionBar?(f=.75*m,n.mainFractionBar.y,n.mainFractionBar.height):f=.75*m}i.setAttribute("width",String(p)),i.setAttribute("height",String(h)),this.fixThinRectangles(i,u),this.fixColors(i),this.addWhiteBackground(i,s,c,l,u),this.convertUseElementsToPaths(i);var v=(new XMLSerializer).serializeToString(i);return{svgString:'<?xml version="1.0" encoding="UTF-8" standalone="no"?>'.concat(v),width:p,height:h,baselineOffsetPt:f}}},{key:"cleanSvgAttributes",value:function(t){t.removeAttribute("focusable"),t.removeAttribute("aria-hidden"),t.removeAttribute("role"),t.removeAttribute("style")}},{key:"fixThinRectangles",value:function(t,e){t.querySelectorAll("rect").forEach(function(t){var n=parseFloat(t.getAttribute("height")||"0"),i=parseFloat(t.getAttribute("y")||"0");if(n<.01*e&&n>0){var r=.012*e,a=Math.max(n,r),o=i-(a-n)/2;t.setAttribute("height",String(a)),t.setAttribute("y",String(o))}})}},{key:"fixColors",value:function(t){var e=this,n=t.querySelectorAll("*"),i=Array.from(n).some(function(t){var e=t.getAttribute("fill"),n=t.getAttribute("stroke");return e&&"black"!==e&&"white"!==e&&"currentColor"!==e||n&&"black"!==n&&"white"!==n&&"currentColor"!==n});n.forEach(function(t){var n=t.getAttribute("fill"),r=t.getAttribute("stroke");if(i){"currentColor"===n&&(e.findParentWithColor(t)?t.removeAttribute("fill"):t.setAttribute("fill","black")),"currentColor"===r&&(e.findParentWithColor(t)?t.removeAttribute("stroke"):t.setAttribute("stroke","black"));var a=e.findParentWithColor(t);if(i&&a){var o=t.getAttribute("fill"),s=t.getAttribute("stroke");if(""===o||"null"===o||null===o){var c=a.getAttribute("fill");c&&"black"!==c&&"white"!==c&&"currentColor"!==c&&t.setAttribute("fill",c)}if(""===s||"null"===s||null===s){var l=a.getAttribute("stroke");l&&"black"!==l&&"white"!==l&&"currentColor"!==l&&t.setAttribute("stroke",l)}}}else"currentColor"===n&&t.setAttribute("fill","black"),"currentColor"===r&&t.setAttribute("stroke","black")})}},{key:"findParentWithColor",value:function(t){for(var e=t.parentElement;e;){var n=e.getAttribute("fill"),i=e.getAttribute("stroke");if(n&&"black"!==n&&"white"!==n&&"currentColor"!==n||i&&"black"!==i&&"white"!==i&&"currentColor"!==i)return e;e=e.parentElement}return null}},{key:"addWhiteBackground",value:function(t,e,n,i,r){var a=document.createElementNS("http://www.w3.org/2000/svg","rect");a.setAttribute("x",String(e)),a.setAttribute("y",String(n)),a.setAttribute("width",String(i)),a.setAttribute("height",String(r)),a.setAttribute("fill","white"),t.insertBefore(a,t.firstChild)}},{key:"convertUseElementsToPaths",value:function(t){var e=t.querySelector("defs");t.querySelectorAll("use").forEach(function(t){var n=t.getAttribute("href")||t.getAttribute("xlink:href");if(n&&e){var i=n.replace("#",""),r=e.querySelector("#".concat(i));if(r&&"path"===r.tagName){var a,o=document.createElementNS("http://www.w3.org/2000/svg","path");o.setAttribute("d",r.getAttribute("d")||""),t.hasAttribute("transform")&&o.setAttribute("transform",t.getAttribute("transform"));var s=t.getAttribute("fill")||r.getAttribute("fill")||"black",c=t.getAttribute("stroke")||r.getAttribute("stroke");o.setAttribute("fill",s),c&&o.setAttribute("stroke",c),null===(a=t.parentNode)||void 0===a||a.replaceChild(o,t)}}})}}])&&Mt(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function Tt(t){return Tt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Tt(t)}function At(){var t,e,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",r=n.toStringTag||"@@toStringTag";function a(n,i,r,a){var c=i&&i.prototype instanceof s?i:s,l=Object.create(c.prototype);return Ot(l,"_invoke",function(n,i,r){var a,s,c,l=0,u=r||[],d=!1,p={p:0,n:0,v:t,a:h,f:h.bind(t,4),d:function(e,n){return a=e,s=0,c=t,p.n=n,o}};function h(n,i){for(s=n,c=i,e=0;!d&&l&&!r&&e<u.length;e++){var r,a=u[e],h=p.p,f=a[2];n>3?(r=f===i)&&(c=a[(s=a[4])?5:(s=3,3)],a[4]=a[5]=t):a[0]<=h&&((r=n<2&&h<a[1])?(s=0,p.v=i,p.n=a[1]):h<f&&(r=n<3||a[0]>i||i>f)&&(a[4]=n,a[5]=i,p.n=f,s=0))}if(r||n>1)return o;throw d=!0,i}return function(r,u,f){if(l>1)throw TypeError("Generator is already running");for(d&&1===u&&h(u,f),s=u,c=f;(e=s<2?t:c)||!d;){a||(s?s<3?(s>1&&(p.n=-1),h(s,c)):p.n=c:p.v=c);try{if(l=2,a){if(s||(r="next"),e=a[r]){if(!(e=e.call(a,c)))throw TypeError("iterator result is not an object");if(!e.done)return e;c=e.value,s<2&&(s=0)}else 1===s&&(e=a.return)&&e.call(a),s<2&&(c=TypeError("The iterator does not provide a '"+r+"' method"),s=1);a=t}else if((e=(d=p.n<0)?c:n.call(i,p))!==o)break}catch(e){a=t,s=1,c=e}finally{l=1}}return{value:e,done:d}}}(n,r,a),!0),l}var o={};function s(){}function c(){}function l(){}e=Object.getPrototypeOf;var u=[][i]?e(e([][i]())):(Ot(e={},i,function(){return this}),e),d=l.prototype=s.prototype=Object.create(u);function p(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,l):(t.__proto__=l,Ot(t,r,"GeneratorFunction")),t.prototype=Object.create(d),t}return c.prototype=l,Ot(d,"constructor",l),Ot(l,"constructor",c),c.displayName="GeneratorFunction",Ot(l,r,"GeneratorFunction"),Ot(d),Ot(d,r,"Generator"),Ot(d,i,function(){return this}),Ot(d,"toString",function(){return"[object Generator]"}),(At=function(){return{w:a,m:p}})()}function Ot(t,e,n,i){var r=Object.defineProperty;try{r({},"",{})}catch(t){r=0}Ot=function(t,e,n,i){if(e)r?r(t,e,{value:n,enumerable:!i,configurable:!i,writable:!i}):t[e]=n;else{var a=function(e,n){Ot(t,e,function(t){return this._invoke(e,n,t)})};a("next",0),a("throw",1),a("return",2)}},Ot(t,e,n,i)}function Dt(t,e,n,i,r,a,o){try{var s=t[a](o),c=s.value}catch(t){return void n(t)}s.done?e(c):Promise.resolve(c).then(i,r)}function qt(t){return function(){var e=this,n=arguments;return new Promise(function(i,r){var a=t.apply(e,n);function o(t){Dt(a,i,r,o,s,"next",t)}function s(t){Dt(a,i,r,o,s,"throw",t)}o(void 0)})}}function Rt(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,Ht(i.key),i)}}function Ft(t,e,n){return(e=Ht(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function Ht(t){var e=function(t){if("object"!=Tt(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=Tt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Tt(e)?e:e+""}var jt=function(){return t=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),Ft(this,"currentColor","#000000"),Ft(this,"currentUnderlineStyle","single"),Ft(this,"isInlineStyle",!1),Ft(this,"currentMatrixType","parentheses"),Ft(this,"pendingStackCasesType",null),Ft(this,"pendingStackCasesCols",1),this.equationBuilder=new k,this.latexConverter=new O,this.latexConverter.setEquationBuilder(this.equationBuilder),this.contextManager=new N(this.equationBuilder,this.latexConverter),this.displayRenderer=new Q(this.contextManager),this.mathJaxService=new yt,this.officeService=new St(this.equationBuilder,this.latexConverter),this.svgProcessor=new Bt,this.fontMeasurementService=new $},e=[{key:"initialize",value:(r=qt(At().m(function t(){var e,n=this;return At().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.mathJaxService.waitForMathJaxReady();case 1:if(e=this.getDOMElements()){t.n=2;break}return t.a(2);case 2:return this.inputHandler=new it(this.equationBuilder,this.contextManager,this.displayRenderer,e.equationDisplay),this.latexConverter.setInputHandler(this.inputHandler),this.displayRenderer.setInputHandler(this.inputHandler),this.inputHandler.onSelectionChange=function(){return n.updateFormattingUIBasedOnSelection()},this.tabController=new ct(e.tabNav,e.tabContent),this.setupEventListeners(e),this.officeService.setEquationLoadedCallback(function(t){return n.handleEquationLoaded(t)}),this.officeService.setupEquationImageHandler(),this.displayRenderer.updateDisplay(e.equationDisplay,this.equationBuilder.getEquation()),this.updateColorPreview(this.currentColor),this.updateHexColorPreview(this.currentColor),e.hexInput.value=this.currentColor,t.p=3,t.n=4,this.fontMeasurementService.measureAndSetScaleRatios();case 4:t.n=6;break;case 5:t.p=5,t.v;case 6:return t.a(2)}},t,this,[[3,5]])})),function(){return r.apply(this,arguments)})},{key:"getDOMElements",value:function(){var t=document.getElementById("insert-equation-button"),e=document.getElementById("clear-equation-button"),n=document.getElementById("status"),i=document.getElementById("hiddenInput"),r=document.getElementById("equationDisplay"),a=document.querySelector(".tab-nav"),o=document.querySelector(".tab-content"),s=document.getElementById("fontSizeInput"),c=document.getElementById("fontSizeDropdownBtn"),l=document.getElementById("fontSizeDropdown"),u=document.getElementById("boldBtn"),d=document.getElementById("italicBtn"),p=document.getElementById("underlineBtn"),h=document.getElementById("underlineDropdownBtn"),f=document.getElementById("cancelBtn"),m=document.getElementById("colorBtn"),v=document.getElementById("colorDropdownBtn"),y=document.getElementById("textModeBtn"),g=document.getElementById("underlineDropdown"),b=document.getElementById("colorPanel"),x=document.getElementById("colorPreview"),w=document.getElementById("hexInput"),k=document.getElementById("hexColorPreview"),L=document.getElementById("colorOkBtn"),C=document.getElementById("colorCancelBtn");return t&&e&&n&&i&&r&&a&&o&&s&&c&&l&&u&&d&&p&&h&&f&&m&&v&&g&&b&&x&&w&&k&&L&&C?{insertButton:t,clearButton:e,statusDiv:n,hiddenInput:i,equationDisplay:r,tabNav:a,tabContent:o,fontSizeInput:s,fontSizeDropdownBtn:c,fontSizeDropdown:l,boldBtn:u,italicBtn:d,underlineBtn:p,underlineDropdownBtn:h,cancelBtn:f,colorBtn:m,colorDropdownBtn:v,textModeBtn:y,underlineDropdown:g,colorPanel:b,colorPreview:x,hexInput:w,hexColorPreview:k,colorOkBtn:L,colorCancelBtn:C}:null}},{key:"setupEventListeners",value:function(t){var e=this;if(t){t.insertButton.addEventListener("click",function(){return e.handleInsertEquation(t.statusDiv)}),t.clearButton.addEventListener("click",function(){return e.handleClearEquation()}),t.hiddenInput.addEventListener("keydown",function(t){return e.inputHandler.handleKeyPress(t)}),t.hiddenInput.addEventListener("input",function(t){return e.inputHandler.handleInput(t)}),t.fontSizeInput.addEventListener("input",function(t){return e.inputHandler.handleFontSizeChange(t)}),t.fontSizeDropdownBtn.addEventListener("click",function(t){return e.handleFontSizeDropdownClick(t)}),t.fontSizeDropdown.addEventListener("click",function(t){return e.handleFontSizeOptionClick(t)}),t.boldBtn.addEventListener("click",function(){return e.inputHandler.toggleBold()}),t.italicBtn.addEventListener("click",function(){return e.inputHandler.toggleItalic()}),t.underlineBtn.addEventListener("click",function(){return e.handleUnderlineApply()}),t.underlineDropdownBtn.addEventListener("click",function(t){return e.handleUnderlineDropdownClick(t)}),t.cancelBtn.addEventListener("click",function(){return e.inputHandler.toggleCancel()}),t.colorBtn.addEventListener("click",function(){return e.handleColorApply()}),t.colorDropdownBtn.addEventListener("click",function(t){return e.handleColorDropdownClick(t)}),t.textModeBtn.addEventListener("click",function(){return e.handleTextModeToggle()}),t.colorPanel.addEventListener("click",function(t){return e.handleColorPanelClick(t)}),t.colorOkBtn.addEventListener("click",function(){return e.handleColorOk()}),t.colorCancelBtn.addEventListener("click",function(){return e.handleColorCancel()}),t.hexInput.addEventListener("input",function(t){return e.handleHexInputChange(t)}),t.underlineDropdown.addEventListener("click",function(t){return e.handleUnderlineOptionClick(t)}),document.addEventListener("click",function(n){return e.handleOutsideClick(n,t)}),t.tabContent.addEventListener("click",function(t){return e.handleBuilderButtonClick(t)}),document.addEventListener("click",function(t){return e.handleFormatButtonClick(t)}),t.tabContent.addEventListener("click",function(t){var n=t.target.closest("button.differential-style-btn");n&&("differential-style-italic"===n.id?e.handleDifferentialStyleToggle("italic"):"differential-style-roman"===n.id&&e.handleDifferentialStyleToggle("roman"))});var n=document.getElementById("display-style-toggle");n&&n.addEventListener("click",function(){e.handleDisplayStyleToggle()}),t.equationDisplay.addEventListener("mousedown",function(t){return e.inputHandler.handleMouseDown(t)}),t.equationDisplay.addEventListener("mousemove",function(t){return e.inputHandler.handleMouseMove(t)}),t.equationDisplay.addEventListener("mouseup",function(t){return e.inputHandler.handleMouseUp(t)}),document.addEventListener("click",function(t){return e.inputHandler.handleDocumentClick(t)})}}},{key:"handleBuilderButtonClick",value:function(t){var e=t.target.closest("button.builder-btn");if(e)if(e.classList.contains("display-fraction-btn"))this.inputHandler.insertDisplayFraction();else if(e.classList.contains("fraction-btn"))this.inputHandler.insertFraction();else if(e.classList.contains("bevelled-fraction-btn"))this.inputHandler.insertBevelledFraction();else if(e.classList.contains("operator-btn")){var n=e.dataset.operator||"";this.inputHandler.insertSymbol(n)}else if(e.classList.contains("greek-letter-btn")||e.classList.contains("greek-letter-capital-btn")){var i=e.dataset.greek||"";this.inputHandler.insertSymbol(i)}else if(e.classList.contains("accent-btn")){var r=e.dataset.accent||"",a=e.dataset.position||"over";this.inputHandler.insertAccent(r,a)}else if(e.classList.contains("arrow-btn")){var o=e.dataset.arrow||"";this.inputHandler.insertSymbol(o)}else if(e.classList.contains("matrix-btn")){var s=e.dataset.matrixType||"parentheses";this.handleMatrixButtonClick(s)}else if(e.classList.contains("sqrt-btn"))this.inputHandler.insertSquareRoot();else if(e.classList.contains("nthroot-btn"))this.inputHandler.insertNthRoot();else if(e.classList.contains("sup-btn"))this.inputHandler.insertScript("superscript");else if(e.classList.contains("sub-btn"))this.inputHandler.insertScript("subscript");else if(e.classList.contains("sup-sub-btn"))this.inputHandler.insertSuperscriptSubscript();else if(e.classList.contains("bracket-preset-btn")){var c=e.dataset.bracket||"";this.handlePresetBracketInsertion(c)}else if(e.classList.contains("custom-bracket-btn"))this.handleCustomBracketInsertion();else if(e.classList.contains("evaluation-bracket-btn")){var l=e.dataset.evaluationType||"bar";this.handleEvaluationBracketInsertion(l)}else if(e.classList.contains("sum-nolimit-btn"))this.inputHandler.insertLargeOperator("∑","inline","nolimits");else if(e.classList.contains("sum-limit-btn"))this.inputHandler.insertLargeOperator("∑","inline","limits");else if(e.classList.contains("sum-display-nolimit-btn"))this.inputHandler.insertLargeOperator("∑","display","nolimits");else if(e.classList.contains("sum-display-limit-btn"))this.inputHandler.insertLargeOperator("∑","display","limits");else if(e.classList.contains("prod-nolimit-btn"))this.inputHandler.insertLargeOperator("∏","inline","nolimits");else if(e.classList.contains("prod-limit-btn"))this.inputHandler.insertLargeOperator("∏","inline","limits");else if(e.classList.contains("prod-display-nolimit-btn"))this.inputHandler.insertLargeOperator("∏","display","nolimits");else if(e.classList.contains("prod-display-limit-btn"))this.inputHandler.insertLargeOperator("∏","display","limits");else if(e.classList.contains("bigcup-display-nolimit-btn"))this.inputHandler.insertLargeOperator("⋃","display","nolimits");else if(e.classList.contains("bigcup-display-limit-btn"))this.inputHandler.insertLargeOperator("⋃","display","limits");else if(e.classList.contains("bigcup-nolimit-btn"))this.inputHandler.insertLargeOperator("⋃","inline","nolimits");else if(e.classList.contains("bigcup-limit-btn"))this.inputHandler.insertLargeOperator("⋃","inline","limits");else if(e.classList.contains("bigcap-display-nolimit-btn"))this.inputHandler.insertLargeOperator("⋂","display","nolimits");else if(e.classList.contains("bigcap-display-limit-btn"))this.inputHandler.insertLargeOperator("⋂","display","limits");else if(e.classList.contains("bigcap-nolimit-btn"))this.inputHandler.insertLargeOperator("⋂","inline","nolimits");else if(e.classList.contains("bigcap-limit-btn"))this.inputHandler.insertLargeOperator("⋂","inline","limits");else if(e.classList.contains("bigvee-display-nolimit-btn"))this.inputHandler.insertLargeOperator("⋁","display","nolimits");else if(e.classList.contains("bigvee-display-limit-btn"))this.inputHandler.insertLargeOperator("⋁","display","limits");else if(e.classList.contains("bigvee-nolimit-btn"))this.inputHandler.insertLargeOperator("⋁","inline","nolimits");else if(e.classList.contains("bigvee-limit-btn"))this.inputHandler.insertLargeOperator("⋁","inline","limits");else if(e.classList.contains("bigwedge-display-nolimit-btn"))this.inputHandler.insertLargeOperator("⋀","display","nolimits");else if(e.classList.contains("bigwedge-display-limit-btn"))this.inputHandler.insertLargeOperator("⋀","display","limits");else if(e.classList.contains("bigwedge-nolimit-btn"))this.inputHandler.insertLargeOperator("⋀","inline","nolimits");else if(e.classList.contains("bigwedge-limit-btn"))this.inputHandler.insertLargeOperator("⋀","inline","limits");else if(e.classList.contains("bigoplus-display-nolimit-btn"))this.inputHandler.insertLargeOperator("⨁","display","nolimits");else if(e.classList.contains("bigoplus-display-limit-btn"))this.inputHandler.insertLargeOperator("⨁","display","limits");else if(e.classList.contains("bigoplus-nolimit-btn"))this.inputHandler.insertLargeOperator("⨁","inline","nolimits");else if(e.classList.contains("bigoplus-limit-btn"))this.inputHandler.insertLargeOperator("⨁","inline","limits");else if(e.classList.contains("bigotimes-display-nolimit-btn"))this.inputHandler.insertLargeOperator("⨂","display","nolimits");else if(e.classList.contains("bigotimes-display-limit-btn"))this.inputHandler.insertLargeOperator("⨂","display","limits");else if(e.classList.contains("bigotimes-nolimit-btn"))this.inputHandler.insertLargeOperator("⨂","inline","nolimits");else if(e.classList.contains("bigotimes-limit-btn"))this.inputHandler.insertLargeOperator("⨂","inline","limits");else if(e.classList.contains("bigodot-display-nolimit-btn"))this.inputHandler.insertLargeOperator("⨀","display","nolimits");else if(e.classList.contains("bigodot-display-limit-btn"))this.inputHandler.insertLargeOperator("⨀","display","limits");else if(e.classList.contains("bigodot-nolimit-btn"))this.inputHandler.insertLargeOperator("⨀","inline","nolimits");else if(e.classList.contains("bigodot-limit-btn"))this.inputHandler.insertLargeOperator("⨀","inline","limits");else if(e.classList.contains("coprod-display-nolimit-btn"))this.inputHandler.insertLargeOperator("∐","display","nolimits");else if(e.classList.contains("coprod-display-limit-btn"))this.inputHandler.insertLargeOperator("∐","display","limits");else if(e.classList.contains("coprod-nolimit-btn"))this.inputHandler.insertLargeOperator("∐","inline","nolimits");else if(e.classList.contains("coprod-limit-btn"))this.inputHandler.insertLargeOperator("∐","inline","limits");else if(e.classList.contains("biguplus-display-nolimit-btn"))this.inputHandler.insertLargeOperator("⨄","display","nolimits");else if(e.classList.contains("biguplus-display-limit-btn"))this.inputHandler.insertLargeOperator("⨄","display","limits");else if(e.classList.contains("biguplus-nolimit-btn"))this.inputHandler.insertLargeOperator("⨄","inline","nolimits");else if(e.classList.contains("biguplus-limit-btn"))this.inputHandler.insertLargeOperator("⨄","inline","limits");else if(e.classList.contains("int-display-nolimit-btn"))this.inputHandler.insertDefiniteIntegral("single",this.isInlineStyle?"inline":"display","nolimits");else if(e.classList.contains("int-display-limit-btn"))this.inputHandler.insertDefiniteIntegral("single",this.isInlineStyle?"inline":"display","limits");else if(e.classList.contains("first-derivative-btn"))this.inputHandler.insertDerivative("first",this.isInlineStyle?"inline":"display");else if(e.classList.contains("nth-derivative-btn"))this.inputHandler.insertDerivative("nth",this.isInlineStyle?"inline":"display");else if(e.classList.contains("derivative-long-form-btn"))this.inputHandler.insertDerivativeLongForm("first",this.isInlineStyle?"inline":"display");else if(e.classList.contains("nth-derivative-long-form-btn"))this.inputHandler.insertDerivativeLongForm("nth",this.isInlineStyle?"inline":"display");else if(e.classList.contains("first-partial-derivative-btn"))this.inputHandler.insertPartialDerivative("first",this.isInlineStyle?"inline":"display");else if(e.classList.contains("nth-partial-derivative-btn"))this.inputHandler.insertPartialDerivative("nth",this.isInlineStyle?"inline":"display");else if(e.classList.contains("partial-derivative-long-form-btn"))this.inputHandler.insertPartialDerivativeLongForm("first",this.isInlineStyle?"inline":"display");else if(e.classList.contains("nth-partial-derivative-long-form-btn"))this.inputHandler.insertPartialDerivativeLongForm("nth",this.isInlineStyle?"inline":"display");else if(e.classList.contains("int-indefinite-display-btn"))this.inputHandler.insertSingleIntegral(this.isInlineStyle?"inline":"display");else if(e.classList.contains("double-int-indefinite-btn"))this.inputHandler.insertDoubleIntegral(this.isInlineStyle?"inline":"display");else if(e.classList.contains("double-int-subscript-btn"))this.inputHandler.insertDoubleIntegralSubscript(this.isInlineStyle?"inline":"display");else if(e.classList.contains("double-int-lower-btn"))this.inputHandler.insertDoubleIntegralLower(this.isInlineStyle?"inline":"display");else if(e.classList.contains("double-int-nolimit-btn"))this.inputHandler.insertDefiniteIntegral("double",this.isInlineStyle?"inline":"display","nolimits");else if(e.classList.contains("double-int-limit-btn"))this.inputHandler.insertDefiniteIntegral("double",this.isInlineStyle?"inline":"display","limits");else if(e.classList.contains("triple-int-indefinite-btn"))this.inputHandler.insertTripleIntegral(this.isInlineStyle?"inline":"display");else if(e.classList.contains("triple-int-subscript-btn"))this.inputHandler.insertTripleIntegralSubscript(this.isInlineStyle?"inline":"display");else if(e.classList.contains("triple-int-lower-btn"))this.inputHandler.insertTripleIntegralLower(this.isInlineStyle?"inline":"display");else if(e.classList.contains("triple-int-nolimit-btn"))this.inputHandler.insertDefiniteIntegral("triple",this.isInlineStyle?"inline":"display","nolimits");else if(e.classList.contains("triple-int-limit-btn"))this.inputHandler.insertDefiniteIntegral("triple",this.isInlineStyle?"inline":"display","limits");else if(e.classList.contains("contour-int-indefinite-btn"))this.inputHandler.insertContourIntegral(this.isInlineStyle?"inline":"display");else if(e.classList.contains("contour-int-subscript-btn"))this.inputHandler.insertContourIntegralSubscript(this.isInlineStyle?"inline":"display");else if(e.classList.contains("contour-int-nolimit-btn"))this.inputHandler.insertDefiniteIntegral("contour",this.isInlineStyle?"inline":"display","nolimits");else if(e.classList.contains("stack-btn")){var u=e.dataset.stack||"";this.handleStackButtonClick(u)}else if(e.classList.contains("cases-btn")){var d=e.dataset.cases||"";this.handleCasesButtonClick(d)}else if(e.classList.contains("function-btn")){var p=e.dataset.function||"";this.inputHandler.insertFunction(p)}}},{key:"handleFormatButtonClick",value:function(t){t.target.closest("button.format-btn")}},{key:"handleClearEquation",value:function(){this.equationBuilder.clear(),this.contextManager.exitEditingMode(),this.contextManager.setCursorPosition(0);var t=document.getElementById("equationDisplay");t&&this.displayRenderer.updateDisplay(t,this.equationBuilder.getEquation())}},{key:"handlePresetBracketInsertion",value:function(t){var e="",n="";switch(t){case"()":e="(",n=")";break;case"[]":e="[",n="]";break;case"{}":e="{",n="}";break;case"⌊⌋":e="⌊",n="⌋";break;case"⌈⌉":e="⌈",n="⌉";break;case"||":e="|",n="|";break;case"‖‖":e="‖",n="‖";break;case"⟨⟩":e="⟨",n="⟩"}(e||n)&&this.inputHandler.insertCustomBrackets(e,n)}},{key:"handleCustomBracketInsertion",value:function(){var t=document.getElementById("leftBracketSelect"),e=document.getElementById("rightBracketSelect");if(t&&e){var n=t.value,i=e.value;this.inputHandler.insertCustomBrackets(n,i)}}},{key:"handleEvaluationBracketInsertion",value:function(t){this.inputHandler.insertEvaluationBracket(t)}},{key:"handleFontSizeDropdownClick",value:function(t){t.stopPropagation();var e=document.getElementById("fontSizeDropdown"),n=e.classList.contains("show");if(this.closeAllDropdowns(),!n){e.classList.add("show");var i=document.getElementById("fontSizeInput").value;document.querySelectorAll(".font-size-option").forEach(function(t){t.classList.remove("selected"),t.getAttribute("data-size")===i&&t.classList.add("selected")})}}},{key:"handleFontSizeOptionClick",value:function(t){var e=t.target;if(e.classList.contains("font-size-option")){var n=e.getAttribute("data-size");if(n){var i=document.getElementById("fontSizeInput");i.value=n;var r=new Event("input",{bubbles:!0});i.dispatchEvent(r),document.querySelectorAll(".font-size-option").forEach(function(t){return t.classList.remove("selected")}),e.classList.add("selected")}this.closeAllDropdowns()}}},{key:"handleUnderlineApply",value:function(){var t=this.inputHandler.getSelectionFormatting();t&&t.underline&&"none"!==t.underline?(this.inputHandler.setUnderlineStyle("none"),this.updateUnderlineUI("none")):(this.inputHandler.setUnderlineStyle(this.currentUnderlineStyle),this.updateUnderlineUI(this.currentUnderlineStyle))}},{key:"handleUnderlineDropdownClick",value:function(t){t.stopPropagation();var e=document.getElementById("underlineDropdown"),n=e.classList.contains("show");this.closeAllDropdowns(),n||e.classList.add("show")}},{key:"handleUnderlineOptionClick",value:function(t){t.stopPropagation(),t.preventDefault();var e=t.target.closest(".underline-option");if(e){var n=e.dataset.underline;n&&(this.currentUnderlineStyle=n,this.inputHandler.setUnderlineStyle(n),this.updateUnderlineUI(n),this.closeAllDropdowns())}}},{key:"updateUnderlineUI",value:function(t){var e=document.getElementById("underlineBtn");"none"===t?e.classList.remove("active"):e.classList.add("active"),document.querySelectorAll(".underline-option").forEach(function(t){return t.classList.remove("selected")});var n=document.querySelector('[data-underline="'.concat(t,'"]'));n&&n.classList.add("selected")}},{key:"updateTextModeUI",value:function(){var t=document.getElementById("textModeBtn");this.inputHandler.getTextMode()?t.classList.add("active"):t.classList.remove("active")}},{key:"updateFormattingUIBasedOnSelection",value:function(){var t=this.inputHandler.getSelectionFormatting();if(t)if(void 0!==t.underline){var e=!0===t.underline?"single":!1===t.underline?"none":t.underline;this.updateUnderlineUI(e),this.currentUnderlineStyle="none"===e?"single":e}else this.updateUnderlineUI("none");this.updateTextModeUI()}},{key:"handleColorApply",value:function(){this.inputHandler.setTextColor(this.currentColor)}},{key:"handleTextModeToggle",value:function(){this.inputHandler.toggleTextMode(),this.updateTextModeUI()}},{key:"handleColorDropdownClick",value:function(t){t.stopPropagation();var e=document.getElementById("colorPanel"),n=e.classList.contains("show");this.closeAllDropdowns(),n||e.classList.add("show")}},{key:"handleColorPanelClick",value:function(t){var e=t.target;if(e.classList.contains("color-square")){var n=e.dataset.color;n&&(this.currentColor=n,this.updateColorPreview(n),this.inputHandler.setTextColor(n),document.getElementById("hexInput").value=n,this.updateHexColorPreview(n),document.querySelectorAll(".color-square").forEach(function(t){return t.classList.remove("selected")}),e.classList.add("selected"),this.closeAllDropdowns())}}},{key:"handleColorOk",value:function(){var t=document.getElementById("hexInput"),e=t.value.trim();e.startsWith("#")||(e="#"+e),this.isValidHexColor(e)?(this.selectColor(e),this.closeAllDropdowns()):(t.style.borderColor="#ff0000",setTimeout(function(){t.style.borderColor=""},2e3))}},{key:"handleColorCancel",value:function(){var t=document.getElementById("colorPreview").style.backgroundColor||"#000000",e=document.getElementById("hexInput");t.startsWith("rgb")?e.value=this.rgbToHex(t):e.value=t,this.closeAllDropdowns()}},{key:"handleDifferentialStyleToggle",value:function(t){var e=document.getElementById("differential-style-italic"),n=document.getElementById("differential-style-roman");"italic"===t?(null==e||e.classList.add("active"),null==n||n.classList.remove("active"),this.inputHandler.setDifferentialStyle("italic")):(null==e||e.classList.remove("active"),null==n||n.classList.add("active"),this.inputHandler.setDifferentialStyle("roman")),document.querySelectorAll(".derivative-d").forEach(function(e){"roman"===t?e.classList.add("roman"):e.classList.remove("roman")}),this.inputHandler.updateExistingDifferentialStyle(t),this.updateDerivativeElementsStyle(t)}},{key:"updateDerivativeElementsStyle",value:function(t){var e=this.getDOMElements();e&&this.displayRenderer.updateDisplay(e.equationDisplay,this.equationBuilder.getEquation())}},{key:"detectAndSetDifferentialStyle",value:function(t){var e=/\\dv\b/.test(t)||/\{\s*\\displaystyle\s+\\dv\b/.test(t),n=/\\derivfrac\b/.test(t)||/\\derivdfrac\b/.test(t),i="italic";e?i="roman":n&&(i="italic"),this.setDifferentialStyleUI(i)}},{key:"setDifferentialStyleUI",value:function(t){var e=document.getElementById("differential-style-italic"),n=document.getElementById("differential-style-roman");"italic"===t?(null==e||e.classList.add("active"),null==n||n.classList.remove("active"),this.inputHandler.setDifferentialStyle("italic")):(null==e||e.classList.remove("active"),null==n||n.classList.add("active"),this.inputHandler.setDifferentialStyle("roman")),document.querySelectorAll(".derivative-d").forEach(function(e){"roman"===t?e.classList.add("roman"):e.classList.remove("roman")})}},{key:"handleDisplayStyleToggle",value:function(){this.isInlineStyle=!this.isInlineStyle;var t=document.getElementById("display-style-toggle");t&&(this.isInlineStyle?t.classList.add("inline-active"):t.classList.remove("inline-active")),this.isInlineStyle?document.body.classList.add("inline-style-active"):document.body.classList.remove("inline-style-active"),this.inputHandler.setInlineStyle(this.isInlineStyle),this.inputHandler.updateExistingEquationStyle(this.isInlineStyle)}},{key:"handleHexInputChange",value:function(t){var e=t.target,n=e.value.trim();!n.startsWith("#")&&n.length>0&&(n="#"+n,e.value=n),this.isValidHexColor(n)&&7===n.length&&(this.updateHexColorPreview(n),document.querySelectorAll(".color-square").forEach(function(t){return t.classList.remove("selected")}))}},{key:"handleOutsideClick",value:function(t,e){if(e){var n=t.target;e.fontSizeDropdownBtn.contains(n)||e.fontSizeDropdown.contains(n)||e.fontSizeDropdown.classList.remove("show"),e.underlineBtn.contains(n)||e.underlineDropdownBtn.contains(n)||e.underlineDropdown.contains(n)||e.underlineDropdown.classList.remove("show"),e.colorBtn.contains(n)||e.colorDropdownBtn.contains(n)||e.colorPanel.contains(n)||e.colorPanel.classList.remove("show")}}},{key:"updateColorPreview",value:function(t){document.getElementById("colorPreview").style.backgroundColor=t}},{key:"updateHexColorPreview",value:function(t){var e=document.getElementById("hexColorPreview");e&&(e.style.backgroundColor=t)}},{key:"selectColor",value:function(t){this.currentColor=t,this.updateColorPreview(t),this.updateHexColorPreview(t),this.inputHandler.setTextColor(t)}},{key:"closeAllDropdowns",value:function(){var t=document.getElementById("fontSizeDropdown"),e=document.getElementById("underlineDropdown"),n=document.getElementById("colorPanel");t&&t.classList.remove("show"),e&&e.classList.remove("show"),n&&n.classList.remove("show")}},{key:"isValidHexColor",value:function(t){return/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(t)}},{key:"rgbToHex",value:function(t){var e=t.match(/\d+/g);return!e||e.length<3?"#000000":"#"+((1<<24)+(parseInt(e[0])<<16)+(parseInt(e[1])<<8)+parseInt(e[2])).toString(16).slice(1)}},{key:"handleEquationLoaded",value:(i=qt(At().m(function t(e){var n,i,r,a,o;return At().w(function(t){for(;;)switch(t.n){case 0:try{this.detectAndSetDifferentialStyle(e),n=this.latexConverter.parseFromLatex(e),this.equationBuilder.clear(),this.equationBuilder.setEquation(n),this.equationBuilder.updateBracketNesting(),this.contextManager.enterRootContext(),this.contextManager.clearSelection(),(i=document.getElementById("equationDisplay"))&&this.displayRenderer.updateDisplay(i,this.equationBuilder.getEquation()),(r=document.getElementById("hiddenInput"))&&r.focus(),(a=document.getElementById("status"))&&(a.textContent="Equation loaded for editing!",setTimeout(function(){a.textContent=""},3e3))}catch(t){(o=document.getElementById("status"))&&(o.textContent="Error: Could not load equation for editing.",setTimeout(function(){o.textContent=""},3e3))}case 1:return t.a(2)}},t,this)})),function(t){return i.apply(this,arguments)})},{key:"handleInsertEquation",value:(n=qt(At().m(function t(e){var n,i,r,a,o,s,c,l,u,d,p,h;return At().w(function(t){for(;;)switch(t.n){case 0:if(n=document.getElementById("insert-equation-button"),i=this.displayRenderer.getGlobalFontSize(),!this.equationBuilder.isEmpty()){t.n=1;break}return e.textContent="Please create an equation first.",t.a(2);case 1:if(t.p=1,n.disabled=!0,n.querySelector(".ms-Button-label").textContent="Inserting...",e.textContent="Converting to LaTeX...",r=this.latexConverter.convertToLatex(this.equationBuilder.getEquation())){t.n=2;break}throw new Error("Equation is empty or invalid.");case 2:return e.textContent="Rendering equation...",t.n=3,this.mathJaxService.renderLatexToSvg(r);case 3:return a=t.v,o=this.mathJaxService.extractSvgPositionInfo(a),e.textContent="Preparing for Word...",s=this.svgProcessor.prepareSvgForOffice(a,i,o),c=s.svgString,l=s.width,u=s.height,d=s.baselineOffsetPt,e.textContent="Inserting into Word...",t.n=4,this.officeService.insertEquationToWord(c,l,u,d,r);case 4:e.textContent="Equation inserted.",this.handleClearEquation(),t.n=6;break;case 5:t.p=5,h=t.v,p=h instanceof Error?h.message:"An unknown error occurred.",e.textContent="Error: ".concat(p);case 6:return t.p=6,n.disabled=!1,n.querySelector(".ms-Button-label").textContent="Insert Equation",setTimeout(function(){var t;null!==(t=e.textContent)&&void 0!==t&&t.includes("Error")||(e.textContent="")},3e3),t.f(6);case 7:return t.a(2)}},t,this,[[1,5,6,7]])})),function(t){return n.apply(this,arguments)})},{key:"handleMatrixButtonClick",value:function(t){this.currentMatrixType=t,this.showMatrixSizePanel()}},{key:"handleStackButtonClick",value:function(t){switch(t){case"2x1":this.inputHandler.insertStack(2,1);break;case"3x1":this.inputHandler.insertStack(3,1);break;case"2x2":this.inputHandler.insertStack(2,2);break;case"3x2":this.inputHandler.insertStack(3,2);break;case"nx1":this.promptForStackSize(1);break;case"nx2":this.promptForStackSize(2)}}},{key:"handleCasesButtonClick",value:function(t){switch(t){case"2x1":this.inputHandler.insertCases(2,1);break;case"3x1":this.inputHandler.insertCases(3,1);break;case"2x2":this.inputHandler.insertCases(2,2);break;case"3x2":this.inputHandler.insertCases(3,2);break;case"nx1":this.promptForCasesSize(1);break;case"nx2":this.promptForCasesSize(2)}}},{key:"promptForStackSize",value:function(t){this.showStackCasesSizePanel("stack",t)}},{key:"promptForCasesSize",value:function(t){this.showStackCasesSizePanel("cases",t)}},{key:"showStackCasesSizePanel",value:function(t,e){var n=document.getElementById("stackCasesSizePanel"),i=document.getElementById("stackCasesHeader"),r=document.getElementById("stackCasesRows");if(n&&i&&r){this.pendingStackCasesType=t,this.pendingStackCasesCols=e;var a="stack"===t?"Stack":"Cases";i.textContent="Select ".concat(a," Size (").concat(e," column").concat(e>1?"s":"",")"),r.value="3",this.setupStackCasesPanelEventListeners(),n.style.display="block",r.focus(),r.select()}}},{key:"setupStackCasesPanelEventListeners",value:function(){var t=this,e=document.getElementById("createStackCasesBtn"),n=document.getElementById("cancelStackCasesBtn"),i=document.getElementById("stackCasesSizePanel");if(e){var r,a=e.cloneNode(!0);null===(r=e.parentNode)||void 0===r||r.replaceChild(a,e),a.addEventListener("click",function(){var e=document.getElementById("stackCasesRows"),n=parseInt(e.value);n>=3&&n<=10&&("stack"===t.pendingStackCasesType?t.inputHandler.insertStack(n,t.pendingStackCasesCols):t.inputHandler.insertCases(n,t.pendingStackCasesCols),i.style.display="none")})}if(n){var o,s=n.cloneNode(!0);null===(o=n.parentNode)||void 0===o||o.replaceChild(s,n),s.addEventListener("click",function(){i.style.display="none"})}var c=document.getElementById("stackCasesRows");if(c){var l,u=c.cloneNode(!0);null===(l=c.parentNode)||void 0===l||l.replaceChild(u,c),u.addEventListener("keypress",function(e){if("Enter"===e.key){var n=parseInt(u.value);n>=3&&n<=20&&("stack"===t.pendingStackCasesType?t.inputHandler.insertStack(n,t.pendingStackCasesCols):t.inputHandler.insertCases(n,t.pendingStackCasesCols),i.style.display="none")}})}}},{key:"showMatrixSizePanel",value:function(){var t=document.getElementById("matrixSizePanel");t&&(this.initializeMatrixGridSelector(),this.setupMatrixPanelEventListeners(),t.style.display="block")}},{key:"initializeMatrixGridSelector",value:function(){var t=this,e=document.getElementById("matrixGridSelector");if(e){e.innerHTML="";for(var n=0;n<36;n++){var i=document.createElement("div");i.className="matrix-grid-cell",i.dataset.row=Math.floor(n/6).toString(),i.dataset.col=(n%6).toString(),e.appendChild(i)}var r=e.querySelectorAll(".matrix-grid-cell");r.forEach(function(e,n){e.addEventListener("mouseenter",function(){return t.highlightMatrixGrid(n)}),e.addEventListener("click",function(){return t.selectMatrixSize(n)})}),e.addEventListener("mouseleave",function(){r.forEach(function(t){return t.classList.remove("highlighted")})})}}},{key:"highlightMatrixGrid",value:function(t){var e=document.getElementById("matrixGridSelector").querySelectorAll(".matrix-grid-cell"),n=Math.floor(t/6),i=t%6;e.forEach(function(t,e){Math.floor(e/6)<=n&&e%6<=i?t.classList.add("highlighted"):t.classList.remove("highlighted")});var r=document.getElementById("matrixRows"),a=document.getElementById("matrixCols");r&&a&&(r.value=(n+1).toString(),a.value=(i+1).toString())}},{key:"selectMatrixSize",value:function(t){var e=Math.floor(t/6)+1,n=t%6+1;this.createMatrix(e,n)}},{key:"setupMatrixPanelEventListeners",value:function(){var t=this,e=document.getElementById("createMatrixBtn"),n=document.getElementById("cancelMatrixBtn");e&&(e.onclick=function(){var e=document.getElementById("matrixRows"),n=document.getElementById("matrixCols"),i=parseInt((null==e?void 0:e.value)||"2"),r=parseInt((null==n?void 0:n.value)||"2");i>=1&&i<=20&&r>=1&&r<=20?t.createMatrix(i,r):alert("Matrix size must be between 1x1 and 20x20")}),n&&(n.onclick=function(){return t.hideMatrixSizePanel()})}},{key:"createMatrix",value:function(t,e){this.inputHandler.createMatrix(t,e,this.currentMatrixType),this.hideMatrixSizePanel()}},{key:"hideMatrixSizePanel",value:function(){var t=document.getElementById("matrixSizePanel");t&&(t.style.display="none")}}],e&&Rt(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,n,i,r}();Office.onReady(function(t){t.host===Office.HostType.Word&&(new jt).initialize().then(function(){}).catch(function(t){var e=document.getElementById("status");e&&(e.textContent="Error: Could not initialize the add-in.")})})}(),new URL(n(58394),n.b)}();
//# sourceMappingURL=taskpane.js.map